---
title: 工作中的问题20200818
tags: 工作
abbrlink: d0781196
date: 2020-08-18 21:20:42
---
### 前言
最近遇到的问题，大多集中在数据库。

### MyBatis批量update语句无法执行
处理数据同步时，用到了批量update，如下
``` sql
  <update id="batchUpdate" parameterType="map">
        <foreach collection="list" item="item" open="" close=";" separator=";">
            update table
            set ...
            where id = #{item.id,jdbcType=BIGINT}
        </foreach>
    </update>
```
执行该方法，只要list.size() > 1，就会报错，sql也没问题
![avatar](/images/work/batch_update.png)

解决方式：
jdbcurl加上 ： **&allowMultiQueries=true**




### 批量update死锁
批量update能够执行后，查看日志发现某张数据量在20w左右的表大量报DeadlockLoserDataAccessException

执行如下语句，查看INNODB输出信息
``` sql
SHOW ENGINE INNODB STATUS;
```
发现一个奇怪的现象，两个查询条件不同的sql发生死锁，在以前的认知中，update加的排他锁是行锁，不同行不应该互斥，然后记起行级锁是针对索引，是不是order_no没有创建索引，行级锁，变为了表锁，故大量update互斥，查看表果然如此，在order_no上创建索引后问题解决。
``` sql
------------------------
LATEST DETECTED DEADLOCK
------------------------
...
update crmorder_travel_order_detail
            set ...
            update_time = '2015-04-22 20:27:32.18',
            where order_no = 'SQ1504221538269616'
...
update crmorder_travel_order_detail
            set ...
            update_time = '2015-08-22 04:14:33.627',
            where order_no = 'SQ150822171345969508'
```

MySQL文档这样解释
**If you have no indexes suitable for your statement and MySQL must scan the entire table to process the statement, every row of the table becomes locked**, which in turn blocks all inserts by other users to the table
如果没有适合语句的索引，并且MySQL必须扫描整个表以处理该语句，则表的每一行都将被锁定，从而阻塞其他用户对表的所有插入。


参考
https://dev.mysql.com/doc/refman/5.6/en/innodb-locks-set.html