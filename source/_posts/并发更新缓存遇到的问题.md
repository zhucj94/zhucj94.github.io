---
title: 并发更新缓存遇到的问题
date: 2020-04-19 21:00:22
tags: [缓存]
declare: true
---
### 业务场景
1. 调用第三方oauth 2.0服务（like微信），会分配access_token，通过access_token来换取资源。
2. access_token是有时限的，这时就需要刷新或重新获取token。

### 出问题的方式
1. 从缓存获取access_token。
2. 未获取到，请求oauth服务，获取access_token，并设置过期时间。
3. 将access_token放入缓存。
![avatar](/images/cache/acc_token.png)

并发时
1. a获取access_token，未获取到。
2. b获取access_token，未获取到。
3. a申请access_token1。
4. b申请access_token2。
5. a将access_token1放入缓存，并请求资源，发现过期，重新申请access_token3。
6. b将access_token2放入缓存，并请求资源，发现过期，重新申请access_token4。
...2000 years later ~...

### 解决方案
+ server只读取access_token。
+ 更新access_token由异步线程执行。