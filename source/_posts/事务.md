---
title: 事务
tags: MySQL
declare: true
abbrlink: 93ac284c
date: 2020-05-02 20:52:14
---
### ACID
+ 原子性(Atomicity)
事务是一个原子操作，其对数据的修改，要么全执行，要么全不执行。
+ 一致性(Consistency)
事务执行结束后，数据库的完整性约束没有被破坏，事务执行的前后都是合法的数据状态。数据库的完整性约束包括但不限于：实体完整性（如行的主键存在且唯一）、列完整性（如字段的类型、大小、长度要符合要求）、外键约束、用户自定义完整性（如转账前后，两个账户余额的和应该不变）。
+ 隔离性(Isolation)
事务内部的操作与其他事务是隔离的，并发执行的各个事务之间不能互相干扰。
+ 持久性(Durability)
事务完成后，它对于数据的修改是永久性的，其后的其他操作或故障都不应该造成影响。

### 并发事务造成的影响
+ 脏读(Dirty Reads)
事务A读取到了事务B未提交的已修改数据，并操作了这些数据，此时事务B回滚，A依据脏数据做的操作可能不正确，不符合一致性。（例如，b=3，B事务将b改为4未提交，A事务读取到了，执行a=b+5，此时B回滚）

+ 不可重复读(Non-Repeatable Reads)
事务A读取到了事务B已提交的修改数据（update，delete），不符合隔离性。

+ 幻读(Phantom Reads)
事务A读取到了事务B已提交的新增数据，不符合隔离性。

### 隔离级别
隔离级别 | 读数据一致性 | 脏读 | 不可重复读 | 幻读
:-: | :-: | :-: | :-: | :-: 
读未提交(Read uncommitted) | 最低级别，只能保证不读取物理上损坏的数据 | √ | √ | √
读已提交(Read committed) | 语句级 | × | √ | √
可重复读(Repeatable read) | 事务级 | × | × | √
可序列化(Serializable) | 事务级 | × | × | ×

注：上表只是通常情况，**InnoDB Repeatable read，通过MVCC解决普通读的幻读，通过间隙锁(Gap Locks)，临键锁(Next-Key Locks)解决 ***当前读*** 幻影读问题**


### 自动提交
MySQL默认采用自动提交模式。即如果不是显示地开始一个事务，则每个查询都被当做一个事务执行提交操作。