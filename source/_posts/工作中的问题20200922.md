---
title: 工作中的问题20200922
tags: 工作
abbrlink: 1a42c17c
date: 2020-09-22 13:49:13
---
### 前言
最近公司开始使用分表组件，选择了Sharding-JDBC，版本是4.1.0，记录下使用过程中遇到的问题

### 不支持的sql
+ 不支持非标准between eg: #{param} between field1 and field2 报错
+ 不支持嵌套子查詢 eg：select xxx from (select xx from tablename xxx) 不报错，但不分表。
+ 不支持DATE_ADD嵌套 eg：DATE_ADD(DATE_ADD(now(), INTERVAL -#{param} MINUTE), INTERVAL -5 HOUR) 报错
+ 不支持在预编译参数上REPLACE eg: REPLACE(#{param})

### 针对公司业务对源码的修改
Sharding-JDBC在DQL条件不包含分表字段时，会对轮询所有表，这点不符合业务要求，业务要求不包含分表字段时，要定位到不含后缀的表。

将ShardingStandardRoutingEngine.routeTables修改为如下
```java
   private Collection<DataNode> routeTables(final ShardingRule shardingRule, final TableRule tableRule, final String routedDataSource, final List<RouteValue> tableShardingValues) {
        Collection<String> availableTargetTables = tableRule.getActualTableNames(routedDataSource);
        // 修改符合业务逻辑 ，当tableShardingValues为空时直接路由到逻辑表
        Collection<String> routedTables = new LinkedHashSet<>(tableShardingValues.isEmpty() ? Stream.of(tableRule.getLogicTable()).collect(Collectors.toList())
                : shardingRule.getTableShardingStrategy(tableRule).doSharding(availableTargetTables, tableShardingValues, this.properties));
        Preconditions.checkState(!routedTables.isEmpty(), "no table route info");
        Collection<DataNode> result = new LinkedList<>();
        for (String each : routedTables) {
            result.add(new DataNode(routedDataSource, each));
        }
        return result;
    }
```
