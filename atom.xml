<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>å°æœ±çš„blog</title>
  
  <subtitle>åŠæ—¶å½“å‹‰åŠ±ï¼Œå²æœˆä¸å¾…äººã€‚</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://zhucj94.github.io/"/>
  <updated>2020-08-04T09:18:33.072Z</updated>
  <id>https://zhucj94.github.io/</id>
  
  <author>
    <name>é£å…‰</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>MyBatisæºç ä¹‹Executor</title>
    <link href="https://zhucj94.github.io/article/f8953bf7.html"/>
    <id>https://zhucj94.github.io/article/f8953bf7.html</id>
    <published>2020-08-02T10:01:17.000Z</published>
    <updated>2020-08-04T09:18:33.072Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€">å‰è¨€</h3><p>åœ¨é˜…è¯»MyBatisæºç å‰ï¼Œå»ºè®®å…ˆå»githubä¸Šclone MyBatisä»¥åŠMyBatis parentæºç ï¼Œåœ¨æœ¬åœ°æ­å»ºæµ‹è¯•ç¯å¢ƒï¼Œä»¥ä¾›ideaåœ¨æºç ä¸­æ‰“æ–­ç‚¹è°ƒè¯•ã€‚</p><hr><h3 id="ExecutoråŠå…¶å­ç±»">ExecutoråŠå…¶å­ç±»</h3><p><img src="/images/mybatis/executor.png" alt="avatar"></p><a id="more"></a><p><img src="/images/mybatis/executor_model.png" alt="avatar"></p><h4 id="Executor">Executor</h4><p>æ‰€æœ‰æ‰§è¡Œå™¨çš„çˆ¶ç±»ï¼Œå®šä¹‰äº†æäº¤ï¼Œå›å½’ï¼ŒæŸ¥è¯¢ï¼ˆDQLï¼‰ï¼Œä¿®æ”¹(ä¸åªæ˜¯updateï¼Œæ˜¯æ‰€æœ‰DML)ï¼Œè·å–äº‹åŠ¡ç­‰æ–¹æ³•ã€‚</p><h4 id="BaseExecutor">BaseExecutor</h4><p>BaseExecutoré‡‡ç”¨<strong>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</strong>ï¼Œå®ç°å¤§å¤šæ•°å…±ç”¨çš„åŠŸèƒ½ï¼Œåªå°†å¦‚ä¸‹æ–¹æ³•äº¤ç»™å­ç±»å®ç°ã€‚ä¸€çº§ç¼“å­˜æ ¸å¿ƒä»£ç å°±ä½äºBaseExecutorä¸­ï¼ˆå…³äºä¸€çº§ç¼“å­˜ï¼Œè¯·çœ‹ <a href="https://zhucj94.github.io/article/7dd9b5ec.html">https://zhucj94.github.io/article/7dd9b5ec.html</a> ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">doUpdate</span><span class="params">(MappedStatement ms, Object parameter)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;BatchResult&gt; <span class="title">doFlushStatements</span><span class="params">(<span class="keyword">boolean</span> isRollback)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">doQuery</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> &lt;E&gt; <span class="function">Cursor&lt;E&gt; <span class="title">doQueryCursor</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, BoundSql boundSql)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> SQLException</span>;</span><br></pre></td></tr></table></figure><p>ä»¥queryä¸ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> query(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  List&lt;E&gt; list;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    queryStack++;</span><br><span class="line">    <span class="comment">// ä»ä¸€çº§ç¼“å­˜è·å–</span></span><br><span class="line">    list = resultHandler == <span class="keyword">null</span> ? (List&lt;E&gt;) localCache.getObject(key) : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (list != <span class="keyword">null</span>) &#123;</span><br><span class="line">      handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//æœªè·å–åˆ°æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">      list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    queryStack--;</span><br><span class="line">  &#125;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">queryFromDatabase</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  List&lt;E&gt; list;</span><br><span class="line">  <span class="comment">//è®¾ç½®ç¼“å­˜å ä½ç¬¦ï¼Œä¸æ˜ç™½å«ä¹‰</span></span><br><span class="line">  localCache.putObject(key, EXECUTION_PLACEHOLDER);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//äº¤ç»™å­ç±»  </span></span><br><span class="line">    list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    localCache.removeObject(key);</span><br><span class="line">  &#125;</span><br><span class="line">  localCache.putObject(key, list);</span><br><span class="line">  <span class="keyword">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;</span><br><span class="line">    localOutputParameterCache.putObject(key, parameter);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="SimpleExecutor">SimpleExecutor</h4><p>é»˜è®¤çš„Executorï¼ŒConfiguration.newExecutor</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Executor <span class="title">newExecutor</span><span class="params">(Transaction transaction, ExecutorType executorType)</span> </span>&#123;</span><br><span class="line">  executorType = executorType == <span class="keyword">null</span> ? defaultExecutorType : executorType;</span><br><span class="line">  <span class="comment">// æœªæŒ‡å®šexecutorTypeæ—¶ï¼Œé»˜è®¤simple</span></span><br><span class="line">  executorType = executorType == <span class="keyword">null</span> ? ExecutorType.SIMPLE : executorType;</span><br><span class="line">  Executor executor;</span><br><span class="line">  <span class="keyword">if</span> (ExecutorType.BATCH == executorType) &#123;</span><br><span class="line">    executor = <span class="keyword">new</span> BatchExecutor(<span class="keyword">this</span>, transaction);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ExecutorType.REUSE == executorType) &#123;</span><br><span class="line">    executor = <span class="keyword">new</span> ReuseExecutor(<span class="keyword">this</span>, transaction);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    executor = <span class="keyword">new</span> SimpleExecutor(<span class="keyword">this</span>, transaction);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (cacheEnabled) &#123;</span><br><span class="line">    executor = <span class="keyword">new</span> CachingExecutor(executor);</span><br><span class="line">  &#125;</span><br><span class="line">  executor = (Executor) interceptorChain.pluginAll(executor);</span><br><span class="line">  <span class="keyword">return</span> executor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SimpleExecutorçš„é€»è¾‘å¾ˆç®€å•ï¼Œè·å–StatementHandlerï¼Œæ¯æ¬¡éƒ½åˆ›å»ºStatementï¼Œå°†æ•°æ®äº¤ç»™StatementHandler</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doUpdate</span><span class="params">(MappedStatement ms, Object parameter)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">   Statement stmt = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     Configuration configuration = ms.getConfiguration();</span><br><span class="line">     <span class="comment">//è·å–StatementHandler</span></span><br><span class="line">     StatementHandler handler = configuration.newStatementHandler(<span class="keyword">this</span>, ms, parameter, RowBounds.DEFAULT, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">     stmt = prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">     <span class="keyword">return</span> handler.update(stmt);</span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">     closeStatement(stmt);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> Statement <span class="title">prepareStatement</span><span class="params">(StatementHandler handler, Log statementLog)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">   Statement stmt;</span><br><span class="line">   Connection connection = getConnection(statementLog);</span><br><span class="line">   <span class="comment">// åˆ›å»ºStatement</span></span><br><span class="line">   stmt = handler.prepare(connection, transaction.getTimeout());</span><br><span class="line">   handler.parameterize(stmt);</span><br><span class="line">   <span class="keyword">return</span> stmt;</span><br><span class="line"> &#125;</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure><h4 id="ReuseExecutor">ReuseExecutor</h4><p>ReuseExecutorä¸Simpleçš„ä¸åŒåœ¨äºï¼Œå½“sqlè¯­å¥ç›¸åŒæ—¶ï¼Œï¼Œ<strong>ReuseExecutorä¼šé‡ç”¨Statement</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Statement&gt; statementMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">private</span> Statement <span class="title">prepareStatement</span><span class="params">(StatementHandler handler, Log statementLog)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    Statement stmt;</span><br><span class="line">    BoundSql boundSql = handler.getBoundSql();</span><br><span class="line">    String sql = boundSql.getSql();</span><br><span class="line">    <span class="comment">// å¦‚æœstatementMapä¸­æœ‰ç›¸åŒçš„Statementï¼Œå°±å¤ç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (hasStatementFor(sql)) &#123;</span><br><span class="line">      stmt = getStatement(sql);</span><br><span class="line">      applyTransactionTimeout(stmt);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¦åˆ™å°±æ–°å»ºï¼Œå¹¶ä¸”ç½®å…¥map</span></span><br><span class="line">      Connection connection = getConnection(statementLog);</span><br><span class="line">      stmt = handler.prepare(connection, transaction.getTimeout());</span><br><span class="line">      putStatement(sql, stmt);</span><br><span class="line">    &#125;</span><br><span class="line">    handler.parameterize(stmt);</span><br><span class="line">    <span class="keyword">return</span> stmt;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasStatementFor</span><span class="params">(String sql)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Statement statement = statementMap.get(sql);</span><br><span class="line">      <span class="keyword">return</span> statement != <span class="keyword">null</span> &amp;&amp; !statement.getConnection().isClosed();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Statement <span class="title">getStatement</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> statementMap.get(s);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putStatement</span><span class="params">(String sql, Statement stmt)</span> </span>&#123;</span><br><span class="line">    statementMap.put(sql, stmt);</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="BatchExecutor">BatchExecutor</h4><p>BatchExecutoråŒæ ·ä¼šé‡ç”¨Statmentï¼Œä¸”ä¼šæ‰¹é‡æäº¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BATCH_UPDATE_RETURN_VALUE = Integer.MIN_VALUE + <span class="number">1002</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Statement&gt; statementList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;BatchResult&gt; batchResultList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> String currentSql;</span><br><span class="line"><span class="keyword">private</span> MappedStatement currentStatement;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BatchExecutor</span><span class="params">(Configuration configuration, Transaction transaction)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">super</span>(configuration, transaction);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doUpdate</span><span class="params">(MappedStatement ms, Object parameterObject)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Configuration configuration = ms.getConfiguration();</span><br><span class="line">  <span class="keyword">final</span> StatementHandler handler = configuration.newStatementHandler(<span class="keyword">this</span>, ms, parameterObject, RowBounds.DEFAULT, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">  <span class="keyword">final</span> BoundSql boundSql = handler.getBoundSql();</span><br><span class="line">  <span class="keyword">final</span> String sql = boundSql.getSql();</span><br><span class="line">  <span class="keyword">final</span> Statement stmt;</span><br><span class="line">  <span class="comment">// å¦‚æœsqlä¸currentSqlç›¸åŒï¼ŒMappedStatementä¸currentStatementç›¸åŒï¼Œå°±è·å–batchResultListçš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå¹¶å°†å‚æ•°åŠ å…¥</span></span><br><span class="line">  <span class="keyword">if</span> (sql.equals(currentSql) &amp;&amp; ms.equals(currentStatement)) &#123;</span><br><span class="line">    <span class="keyword">int</span> last = statementList.size() - <span class="number">1</span>;</span><br><span class="line">    stmt = statementList.get(last);</span><br><span class="line">    applyTransactionTimeout(stmt);</span><br><span class="line">    handler.parameterize(stmt);<span class="comment">// fix Issues 322</span></span><br><span class="line">    BatchResult batchResult = batchResultList.get(last);</span><br><span class="line">    batchResult.addParameterObject(parameterObject);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//å¦‚æœä¸ç›¸åŒï¼Œå°±æ–°å»ºBatchResultå’ŒStatementï¼Œå¹¶å°†å…¶addåˆ°listï¼Œä¸”è®¾ç½®currentSqlå’ŒcurrentStatementä¸ºå½“å‰å€¼</span></span><br><span class="line">    Connection connection = getConnection(ms.getStatementLog());</span><br><span class="line">    stmt = handler.prepare(connection, transaction.getTimeout());</span><br><span class="line">    handler.parameterize(stmt);    <span class="comment">// fix Issues 322</span></span><br><span class="line">    currentSql = sql;</span><br><span class="line">    currentStatement = ms;</span><br><span class="line">    statementList.add(stmt);</span><br><span class="line">    batchResultList.add(<span class="keyword">new</span> BatchResult(ms, sql, parameterObject));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//é€šè¿‡ä¸Šé¢ä¸¤ä¸ªæ“ä½œï¼Œå°±å½¢æˆäº†ä¸¤ä¸ªlistä¸‹æ ‡ä¸€ä¸€å¯¹åº”çš„ä¸”éƒ¨åˆ†å¤ç”¨çš„æƒ…å†µï¼ˆé—´éš”è°ƒç”¨ç›¸åŒæ–¹æ³•ï¼Œä¸ä¼šå¤ç”¨Statementï¼‰ã€‚</span></span><br><span class="line"></span><br><span class="line">  handler.batch(stmt);</span><br><span class="line">  <span class="comment">//ç»Ÿä¸€è¿”å›-2147482646ï¼Œæ­¤æ—¶è¿˜æ²¡æœ‰æ‰¹é‡æäº¤ï¼Œæ— æ³•å¾—çŸ¥æ“ä½œè¡Œæ•°ï¼Œç»Ÿä¸€è¿”å›ä¸€ä¸ªè´Ÿæ•°</span></span><br><span class="line">  <span class="comment">//æ‰€ä»¥å½“executorä¸ºbatchæ—¶ï¼Œinsertï¼Œdeleteï¼Œupdateæ–¹æ³•ï¼Œä¸èƒ½ä½¿ç”¨è¿”å›å€¼&gt;0åˆ¤æ–­æ–¹æ³•æ˜¯å¦æˆåŠŸã€‚</span></span><br><span class="line">  <span class="keyword">return</span> BATCH_UPDATE_RETURN_VALUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;BatchResult&gt; <span class="title">doFlushStatements</span><span class="params">(<span class="keyword">boolean</span> isRollback)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">   ...</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, n = statementList.size(); i &lt; n; i++) &#123;</span><br><span class="line">      Statement stmt = statementList.get(i);</span><br><span class="line">      applyTransactionTimeout(stmt);</span><br><span class="line">      BatchResult batchResult = batchResultList.get(i);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//å¾ªç¯æäº¤  </span></span><br><span class="line">        batchResult.setUpdateCounts(stmt.executeBatch());</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="CachingExecutor">CachingExecutor</h4><p>CachingExecutorä½¿ç”¨è£…é¥°æ¨¡å¼ï¼Œå¢å¼ºä¸Šè¿°çš„Executorï¼ŒäºŒçº§ç¼“å­˜çš„è°ƒç”¨é€»è¾‘ä¹Ÿä½äºCachingExecutorä¸­ï¼Œå…³äºäºŒçº§ç¼“å­˜è¯·çœ‹ï¼ˆ <a href="https://zhucj94.github.io/article/3f89eca3.html">https://zhucj94.github.io/article/3f89eca3.html</a> ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¢«è£…é¥°çš„Executor</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Executor delegate;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CachingExecutor</span><span class="params">(Executor delegate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">    delegate.setExecutorWrapper(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(MappedStatement ms, Object parameterObject)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    flushCacheIfRequired(ms);</span><br><span class="line">    <span class="comment">// å°†updateé€»è¾‘å«ç»™è¢«è£…é¥°çš„Executor</span></span><br><span class="line">    <span class="keyword">return</span> delegate.update(ms, parameterObject);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æœ¬æ–‡æ‰§è¡Œå™¨å›¾ç‰‡è½¬è‡ª<br><a href="https://blog.csdn.net/landywu1985/article/details/106736621" target="_blank" rel="noopener">https://blog.csdn.net/landywu1985/article/details/106736621</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h3&gt;&lt;p&gt;åœ¨é˜…è¯»MyBatisæºç å‰ï¼Œå»ºè®®å…ˆå»githubä¸Šclone MyBatisä»¥åŠMyBatis parentæºç ï¼Œåœ¨æœ¬åœ°æ­å»ºæµ‹è¯•ç¯å¢ƒï¼Œä»¥ä¾›ideaåœ¨æºç ä¸­æ‰“æ–­ç‚¹è°ƒè¯•ã€‚&lt;/p&gt;&lt;hr&gt;&lt;h3 id=&quot;ExecutoråŠå…¶å­ç±»&quot;&gt;ExecutoråŠå…¶å­ç±»&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/images/mybatis/executor.png&quot; alt=&quot;avatar&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="MyBatis" scheme="https://zhucj94.github.io/tags/MyBatis/"/>
    
  </entry>
  
  <entry>
    <title>blogå®‰è£…çš„æ’ä»¶</title>
    <link href="https://zhucj94.github.io/article/9fc0ebd4.html"/>
    <id>https://zhucj94.github.io/article/9fc0ebd4.html</id>
    <published>2020-08-02T08:53:50.000Z</published>
    <updated>2020-08-02T11:45:17.953Z</updated>
    
    <content type="html"><![CDATA[<p>blog å®‰è£…çš„Node.jsæ’ä»¶è¶Šæ¥è¶Šå¤šï¼Œè®°å½•ä¸‹ ğŸ˜</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cnpm install hexo-git-backup --save  //å¤‡ä»½æ’ä»¶</span><br><span class="line">cnpm install hexo-neat --save  //é™æ€èµ„æºå‹ç¼©æ’ä»¶</span><br><span class="line">cnpm install hexo-abbrlink --save  //urlæ ¼å¼åŒ–æ’ä»¶</span><br><span class="line">cnpm install hexo-wordcount --save  //æ–‡å­—ç»Ÿè®¡æ’ä»¶</span><br><span class="line">cnpm install hexo-generator-feed //rss</span><br><span class="line">--- æ›¿æ¢æ¸²æŸ“å¼•æ“</span><br><span class="line">cnpm un hexo-renderer-marked --save</span><br><span class="line">cnpm install hexo-renderer-markdown-it --save</span><br><span class="line">cnpm install markdown-it-emoji --save</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;blog å®‰è£…çš„Node.jsæ’ä»¶è¶Šæ¥è¶Šå¤šï¼Œè®°å½•ä¸‹ ğŸ˜&lt;/p&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span c
      
    
    </summary>
    
    
    
      <category term="blogæ­å»º" scheme="https://zhucj94.github.io/tags/blog%E6%90%AD%E5%BB%BA/"/>
    
  </entry>
  
  <entry>
    <title>MyBatisæºç ä¹‹äºŒçº§ç¼“å­˜</title>
    <link href="https://zhucj94.github.io/article/3f89eca3.html"/>
    <id>https://zhucj94.github.io/article/3f89eca3.html</id>
    <published>2020-07-26T06:51:37.000Z</published>
    <updated>2020-08-02T11:35:22.221Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€">å‰è¨€</h3><p>åœ¨é˜…è¯»MyBatisæºç å‰ï¼Œå»ºè®®å…ˆå»githubä¸Šclone MyBatisä»¥åŠMyBatis parentæºç ï¼Œåœ¨æœ¬åœ°æ­å»ºæµ‹è¯•ç¯å¢ƒï¼Œä»¥ä¾›ideaåœ¨æºç ä¸­æ‰“æ–­ç‚¹è°ƒè¯•ã€‚</p><hr><p>MyBatisäºŒçº§ç¼“å­˜çš„è°ƒç”¨é€»è¾‘ä½äº<strong>CachingExecutor</strong>ä¸­</p><h3 id="CacheåŠå…¶å­ç±»">CacheåŠå…¶å­ç±»</h3><p>Mybatisä½¿ç”¨CacheåŠå­ç±»æ¥å›Šæ‹¬æ‰€æœ‰ç¼“å­˜å®ç°<br>æ‰€æœ‰å­ç±»å¦‚ä¸‹å›¾ï¼ˆideaæŸ¥çœ‹ ç±»å³é”® -&gt; Diagrams -&gt; show Diagrams -&gt; ctrl+alt+bé€‰æ‹©æ‰€æœ‰å­ç±»ï¼‰<br><img src="/images/mybatis/cache_child.png" alt="avatar"></p><a id="more"></a><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> The identifier of this cache</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">String <span class="title">getId</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * æ’å…¥ç¼“å­˜</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object key, Object value)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * è·å–ç¼“å­˜</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">Object <span class="title">getObject</span><span class="params">(Object key)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ç§»é™¤ç¼“å­˜</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">Object <span class="title">removeObject</span><span class="params">(Object key)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * æ¸…ç©ºç¼“å­˜</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> The number of elements stored in the cache (not its capacity).</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™äº›å­ç±»ä¸­æœ‰4ä¸ªç±»ä¸ºç¼“å­˜æ·˜æ±°ç­–ç•¥</p><ol><li>SoftCacheï¼ˆè½¯å¼•ç”¨ï¼Œåœ¨ç³»ç»Ÿè¦å‘ç”Ÿå†…å­˜æº¢å‡ºçš„å¼‚å¸¸ä¹‹å‰,å°†ä¼šæŠŠè¿™äº›å¯¹è±¡åˆ—è¿›å›æ”¶èŒƒå›´ä¹‹ä¸­è¿›è¡Œç¬¬äºŒæ¬¡å›æ”¶ï¼‰</li><li>LruCache</li><li>FifoCache</li><li>WeakCacheï¼ˆå¼±å¼•ç”¨ï¼Œåªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å‘ç”Ÿä¹‹å‰ï¼‰</li></ol><h4 id="SoftCache">SoftCache</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SoftCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">  <span class="comment">//å¼ºå¼•ç”¨åŒç«¯é˜Ÿåˆ—</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;Object&gt; hardLinksToAvoidGarbageCollection;</span><br><span class="line">  <span class="comment">//å¼±å¼•ç”¨é˜Ÿåˆ—</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ReferenceQueue&lt;Object&gt; queueOfGarbageCollectedEntries;</span><br><span class="line">  <span class="comment">//è¢«è£…é¥°Cache</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Cache delegate;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> numberOfHardLinks;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//æ¸…é™¤æ‰€æœ‰æœªåŠ å…¥å¼ºå¼•ç”¨é˜Ÿåˆ—çš„è½¯å¼•ç”¨</span></span><br><span class="line">    removeGarbageCollectedItems();</span><br><span class="line">    delegate.putObject(key, <span class="keyword">new</span> SoftEntry(key, value, queueOfGarbageCollectedEntries));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Object result = <span class="keyword">null</span>;</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>) <span class="comment">// assumed delegate cache is totally managed by this cache</span></span><br><span class="line">    <span class="comment">// ä»è¢«ä¿®é¥°çš„Cacheä¸­è·å–å€¼</span></span><br><span class="line">    SoftReference&lt;Object&gt; softReference = (SoftReference&lt;Object&gt;) delegate.getObject(key);</span><br><span class="line">    <span class="keyword">if</span> (softReference != <span class="keyword">null</span>) &#123;</span><br><span class="line">      result = softReference.get();</span><br><span class="line">      <span class="comment">//å¦‚æœè¢«å›æ”¶ï¼Œç§»é™¤è¢«ä¿®é¥°Cacheçš„é”®å€¼</span></span><br><span class="line">      <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">        delegate.removeObject(key);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ²¡è¢«å›æ”¶ï¼Œå°†å¼±å¼•å‡çº§ä¸ºå¼ºå¼•ç”¨ï¼Œé¿å…è¢«å›æ”¶ï¼Œä¾›ä¸‹æ¬¡å‘½ä¸­ä½¿ç”¨</span></span><br><span class="line">        <span class="comment">// See #586 (and #335) modifications need more than a read lock</span></span><br><span class="line">        <span class="keyword">synchronized</span> (hardLinksToAvoidGarbageCollection) &#123;</span><br><span class="line">          hardLinksToAvoidGarbageCollection.addFirst(result);</span><br><span class="line">          <span class="keyword">if</span> (hardLinksToAvoidGarbageCollection.size() &gt; numberOfHardLinks) &#123;</span><br><span class="line">            hardLinksToAvoidGarbageCollection.removeLast();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"> ...</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeGarbageCollectedItems</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SoftEntry sv;</span><br><span class="line">    <span class="keyword">while</span> ((sv = (SoftEntry) queueOfGarbageCollectedEntries.poll()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      delegate.removeObject(sv.key);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="comment">// è½¯å¼•ç”¨å†…éƒ¨ç±»ï¼Œkeyä¸ºå¼ºå¼•ç”¨ï¼Œvalueä¸ºè½¯åº”ç”¨</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SoftEntry</span> <span class="keyword">extends</span> <span class="title">SoftReference</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object key;</span><br><span class="line"></span><br><span class="line">    SoftEntry(Object key, Object value, ReferenceQueue&lt;Object&gt; garbageCollectionQueue) &#123;</span><br><span class="line">      <span class="comment">//å°†valueåŒ…è£…ä¸ºè½¯å¼•ç”¨ï¼Œå¹¶åŠ å…¥garbageCollectionQueue</span></span><br><span class="line">      <span class="keyword">super</span>(value, garbageCollectionQueue);</span><br><span class="line">      <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="SerializedCache">SerializedCache</h4><p>é€šè¿‡åºåˆ—åŒ–åŠååºåˆ—åŒ–ï¼Œæ¥è¿›è¡Œ<strong>é˜²å¾¡æ€§æ‹·è´</strong>ï¼Œå³æ¯æ¬¡é€šè¿‡ç›¸åŒkeyè·å–çš„å¯¹è±¡éƒ½æ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œä»¥é˜²æ­¢Açº¿ç¨‹æ‹¿åˆ°å¯¹è±¡åï¼Œä¿®æ”¹å¯¹è±¡ï¼ŒBçº¿ç¨‹æ‹¿åˆ°ä¿®æ”¹åçš„å¯¹è±¡ï¼Œå…³äºé˜²å¾¡æ€§æ‹·è´å¯ä»¥çœ‹ <a href="https://zhucj94.github.io/article/ad01bc3e.html">https://zhucj94.github.io/article/ad01bc3e.html</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializedCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Cache delegate;</span><br><span class="line">  ...</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object key, Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (object == <span class="keyword">null</span> || object <span class="keyword">instanceof</span> Serializable) &#123;</span><br><span class="line">      delegate.putObject(key, serialize((Serializable) object));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">"SharedCache failed to make a copy of a non-serializable object: "</span> + object);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Object object = delegate.getObject(key);</span><br><span class="line">    <span class="keyword">return</span> object == <span class="keyword">null</span> ? <span class="keyword">null</span> : deserialize((<span class="keyword">byte</span>[]) object);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">byte</span>[] serialize(Serializable value) &#123;</span><br><span class="line">    <span class="keyword">try</span> (ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(bos)) &#123;</span><br><span class="line">      oos.writeObject(value);</span><br><span class="line">      oos.flush();</span><br><span class="line">      <span class="keyword">return</span> bos.toByteArray();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">"Error serializing object.  Cause: "</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Serializable <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] value)</span> </span>&#123;</span><br><span class="line">    Serializable result;</span><br><span class="line">    <span class="keyword">try</span> (ByteArrayInputStream bis = <span class="keyword">new</span> ByteArrayInputStream(value);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> CustomObjectInputStream(bis)) &#123;</span><br><span class="line">      result = (Serializable) ois.readObject();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">"Error deserializing object.  Cause: "</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="TransactionalCache">TransactionalCache</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CachingExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Executor delegate;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> TransactionalCacheManager tcm = <span class="keyword">new</span> TransactionalCacheManager();</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    Cache cache = ms.getCache();</span><br><span class="line">    <span class="keyword">if</span> (cache != <span class="keyword">null</span>) &#123;</span><br><span class="line">      flushCacheIfRequired(ms);</span><br><span class="line">      <span class="keyword">if</span> (ms.isUseCache() &amp;&amp; resultHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        ensureNoOutParams(ms, boundSql);</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢äºŒçº§ç¼“å­˜</span></span><br><span class="line">        List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);</span><br><span class="line">        <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// å°†æŸ¥è¯¢è½¬äº¤ç»™è¢«è£…é¥°çš„Executorï¼Œè¿›å…¥å‰æ–‡æ‰€æåˆ°çš„BaseExecutorçš„å­ç±»</span></span><br><span class="line">          list = delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">          tcm.putObject(cache, key, list); <span class="comment">// issue #578 and #116</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CachingExecutoråˆå§‹åŒ–æ—¶ï¼Œä¼šåˆå§‹åŒ–TransactionalCacheManagerï¼ŒäºŒçº§ç¼“å­˜æ˜¯ç”±TransactionalCacheManageræ¥ç®¡ç†çš„ï¼ŒTransactionalCacheManagerä¼šä½¿ç”¨TransactionalCacheæ¥è£…é¥°Cacheï¼Œ<strong>TransactionalCacheçš„è®¾è®¡ååˆ†æœ‰æ„æ€ï¼Œputç¼“å­˜åªæ˜¯æš‚å­˜äºå½“å‰çº¿ç¨‹ä¸­ï¼Œåªæœ‰å½“commitæ—¶æ‰ä¼šå°†ç¼“å­˜å†™å…¥ã€‚</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionalCacheManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Cache, TransactionalCache&gt; transactionalCaches = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">(Cache cache)</span> </span>&#123;</span><br><span class="line">    getTransactionalCache(cache).clear();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(Cache cache, CacheKey key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getTransactionalCache(cache).getObject(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Cache cache, CacheKey key, Object value)</span> </span>&#123;</span><br><span class="line">    getTransactionalCache(cache).putObject(key, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (TransactionalCache txCache : transactionalCaches.values()) &#123;</span><br><span class="line">      txCache.commit();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (TransactionalCache txCache : transactionalCaches.values()) &#123;</span><br><span class="line">      txCache.rollback();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ä½¿ç”¨TransactionalCacheè£…é¥°Cache</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> TransactionalCache <span class="title">getTransactionalCache</span><span class="params">(Cache cache)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> transactionalCaches.computeIfAbsent(cache, TransactionalCache::<span class="keyword">new</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionalCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Cache delegate;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> clearOnCommit;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, Object&gt; entriesToAddOnCommit;</span><br><span class="line">  <span class="comment">//æœªå‘½ä¸­åˆ—è¡¨</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Object&gt; entriesMissedInCache;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// issue #116</span></span><br><span class="line">    <span class="comment">// ä»è¢«è£…é¥°çš„Cacheä¸­è·å–</span></span><br><span class="line">    Object object = delegate.getObject(key);</span><br><span class="line">    <span class="comment">// å¦‚æœå€¼ä¸ºç©ºï¼ŒåŠ å…¥æœªå‘½ä¸­åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">      entriesMissedInCache.add(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// issue #146</span></span><br><span class="line">    <span class="keyword">if</span> (clearOnCommit) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// putåªæ˜¯å°†é”®å€¼å­˜å…¥entriesToAddOnCommitï¼Œè€Œä¸äº¤ç»™è¢«è£…é¥°çš„Cacheï¼Œä»entriesToAddOnCommitåå­—ä¹Ÿèƒ½çœ‹å‡ºï¼Œå³æäº¤åå†æ·»åŠ ï¼Œè¿™æ ·å…¶ä»–çº¿ç¨‹å°±ä¸èƒ½çœ‹åˆ°æœªæäº¤çš„æ•°æ®ã€‚</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object key, Object object)</span> </span>&#123;</span><br><span class="line">    entriesToAddOnCommit.put(key, object);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (clearOnCommit) &#123;</span><br><span class="line">      delegate.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    flushPendingEntries();</span><br><span class="line">    reset();</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">flushPendingEntries</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å°†entriesToAddOnCommitçš„é”®å€¼äº¤ç»™è¢«è£…é¥°çš„Cache</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Object, Object&gt; entry : entriesToAddOnCommit.entrySet()) &#123;</span><br><span class="line">      delegate.putObject(entry.getKey(), entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœæœªå‘½ä¸­åˆ—è¡¨æ•°æ®ä¸åœ¨entriesToAddOnCommitä¸­ï¼Œåˆ™åœ¨è¢«è£…é¥°çš„Cacheå­˜å…¥nullå€¼ï¼Œé˜²æ­¢ç¼“å­˜ç©¿é€</span></span><br><span class="line">    <span class="keyword">for</span> (Object entry : entriesMissedInCache) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!entriesToAddOnCommit.containsKey(entry)) &#123;</span><br><span class="line">        delegate.putObject(entry, <span class="keyword">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³äºflushPendingEntriesæˆ‘æœ‰ä¸ªç–‘é—®ï¼Œå½“Açº¿ç¨‹entriesMissedInCacheå­˜åœ¨key testï¼ŒBçº¿ç¨‹æ’å…¥äº†testä¸”æäº¤ï¼Œæ­¤æ—¶Açº¿ç¨‹å†æ‰§è¡Œdelegate.putObject(test, null);ï¼Œè¿™æ ·ä¼šé€ æˆåœ¨ä¸‹ä¸€æ¬¡æ¸…ç©ºç¼“å­˜å‰ï¼Œå…³äºkeyçš„æŸ¥è¯¢å‡ä¸ºè„æ•°æ®</strong></p><h3 id="å‘½ä¸­æ¡ä»¶">å‘½ä¸­æ¡ä»¶</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public CacheKey createCacheKey(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql) &#123;</span><br><span class="line">  return delegate.createCacheKey(ms, parameterObject, rowBounds, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®é™…æ˜¯äº¤ä¸ªè¢«è£…é¥°çš„Executorï¼Œè°ƒç”¨BaseExecutor.createCacheKeyï¼Œåœ¨ä¸€çº§ç¼“å­˜ä¸­è¯¦ç»†ä»‹ç»è¿‡createCacheKeyï¼Œå‘½ä¸­æ¡ä»¶å¦‚ä¸‹ï¼Œä¸ä¸€çº§ç¼“å­˜ä¸åŒåœ¨äºä¸ç”¨ç›¸åŒçš„sessionï¼Œè‡³äºä¸ºä»€ä¹ˆè¯·çœ‹Cacheé“¾çš„ç»„è£…è¿™ä¸€å°èŠ‚ã€‚</p><ol><li><strong>ç›¸åŒçš„æ–¹æ³•ï¼ˆMappedStatementï¼‰</strong></li><li><strong>ç›¸åŒsqlï¼Œå‚æ•°</strong></li><li><strong>ç›¸åŒæŸ¥è¯¢èŒƒå›´ï¼Œå³åç§»é‡ï¼Œlimit</strong></li></ol><h3 id="æ¸…ç©ºæ¡ä»¶">æ¸…ç©ºæ¡ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">flushCacheIfRequired</span><span class="params">(MappedStatement ms)</span> </span>&#123;</span><br><span class="line">  Cache cache = ms.getCache();</span><br><span class="line">  <span class="keyword">if</span> (cache != <span class="keyword">null</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;</span><br><span class="line">    tcm.clear(cache);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>äºŒçº§ç¼“å­˜æ¸…ç©ºï¼Œå¿…é¡»è®¾ç½®flushCache=â€œtrueâ€ã€‚è°ƒç”¨æƒ…å†µå¦‚ä¸‹ï¼Œå³æŸ¥è¯¢å’Œä¿®æ”¹å‡ä¼šæ¸…ç©ºç¼“å­˜ã€‚<br><img src="/images/mybatis/2_cache_clear.png" alt="avatar"></p><h3 id="Cacheé“¾çš„ç»„è£…">Cacheé“¾çš„ç»„è£…</h3><p>ç»„è£…è°ƒç”¨ä½äºMapperBuilderAssistantï¼Œé‡‡ç”¨å»ºé€ è€…æ¨¡å¼ï¼Œã€Šeffective javaã€‹ä¸Šæåˆ°è¿‡ï¼Œå½“å‚æ•°è¾ƒå¤šæ—¶ï¼Œä½¿ç”¨å»ºç­‘ä¸­æ¨¡å¼ä»£æ›¿æ„é€ ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Cache <span class="title">useNewCache</span><span class="params">(Class&lt;? extends Cache&gt; typeClass,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;? extends Cache&gt; evictionClass,</span></span></span><br><span class="line"><span class="function"><span class="params">    Long flushInterval,</span></span></span><br><span class="line"><span class="function"><span class="params">    Integer size,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> readWrite,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> blocking,</span></span></span><br><span class="line"><span class="function"><span class="params">    Properties props)</span> </span>&#123;</span><br><span class="line">  Cache cache = <span class="keyword">new</span> CacheBuilder(currentNamespace)</span><br><span class="line">      .implementation(valueOrDefault(typeClass, PerpetualCache<span class="class">.<span class="keyword">class</span>))</span></span><br><span class="line"><span class="class">      .<span class="title">addDecorator</span>(<span class="title">valueOrDefault</span>(<span class="title">evictionClass</span>, <span class="title">LruCache</span>.<span class="title">class</span>))</span></span><br><span class="line"><span class="class">      .<span class="title">clearInterval</span>(<span class="title">flushInterval</span>)</span></span><br><span class="line"><span class="class">      .<span class="title">size</span>(<span class="title">size</span>)</span></span><br><span class="line"><span class="class">      .<span class="title">readWrite</span>(<span class="title">readWrite</span>)</span></span><br><span class="line"><span class="class">      .<span class="title">blocking</span>(<span class="title">blocking</span>)</span></span><br><span class="line"><span class="class">      .<span class="title">properties</span>(<span class="title">props</span>)</span></span><br><span class="line"><span class="class">      .<span class="title">build</span>()</span>;</span><br><span class="line">  configuration.addCache(cache);</span><br><span class="line">  currentCache = cache;</span><br><span class="line">  <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›å…¥CacheBuilder</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Cache <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  setDefaultImplementations();</span><br><span class="line">  <span class="comment">// è·å–åŸºç¡€Cacheï¼Œé»˜è®¤ä¸ºPerpetualCacheï¼Œä¸ä¸€çº§ç¼“å­˜ä¸€è‡´</span></span><br><span class="line">  Cache cache = newBaseCacheInstance(implementation, id);</span><br><span class="line">  setCacheProperties(cache);</span><br><span class="line">  <span class="comment">// issue #352, do not apply decorators to custom caches</span></span><br><span class="line">  <span class="keyword">if</span> (PerpetualCache<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">cache</span>.<span class="title">getClass</span>())) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;? extends Cache&gt; decorator : decorators) &#123;</span><br><span class="line">      <span class="comment">//ä½¿ç”¨ç¼“å­˜æ·˜æ±°ç­–ç•¥è£…é¥°Cacheï¼Œé»˜è®¤ä¸ºLruCache</span></span><br><span class="line">      cache = newCacheDecoratorInstance(decorator, cache);</span><br><span class="line">      setCacheProperties(cache);</span><br><span class="line">    &#125;</span><br><span class="line">    cache = setStandardDecorators(cache);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!LoggingCache<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">cache</span>.<span class="title">getClass</span>())) </span>&#123;</span><br><span class="line">    cache = <span class="keyword">new</span> LoggingCache(cache);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> Cache <span class="title">setStandardDecorators</span><span class="params">(Cache cache)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    MetaObject metaCache = SystemMetaObject.forObject(cache);</span><br><span class="line">    <span class="keyword">if</span> (size != <span class="keyword">null</span> &amp;&amp; metaCache.hasSetter(<span class="string">"size"</span>)) &#123;</span><br><span class="line">      metaCache.setValue(<span class="string">"size"</span>, size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (clearInterval != <span class="keyword">null</span>) &#123;</span><br><span class="line">      cache = <span class="keyword">new</span> ScheduledCache(cache);</span><br><span class="line">      ((ScheduledCache) cache).setClearInterval(clearInterval);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (readWrite) &#123;</span><br><span class="line">      cache = <span class="keyword">new</span> SerializedCache(cache);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä½¿ç”¨æ—¥å¿—è£…é¥°Cacheï¼Œæ‰“å°ç¼“å­˜å‘½ä¸­ç‡ç­‰ä¿¡æ¯</span></span><br><span class="line">    cache = <span class="keyword">new</span> LoggingCache(cache);</span><br><span class="line">    <span class="comment">//ä½¿ç”¨åŒæ­¥è£…é¥°Cacheï¼ŒåŠ é”</span></span><br><span class="line">    cache = <span class="keyword">new</span> SynchronizedCache(cache);</span><br><span class="line">    <span class="keyword">if</span> (blocking) &#123;</span><br><span class="line">      <span class="comment">//ä½¿ç”¨é˜»å¡è£…é¥°Cacheï¼Œå½“åœ¨ç¼“å­˜ä¸­æœªæ‰¾åˆ°è¯¥å…ƒç´ æ—¶ï¼Œå®ƒå°†å¯¹ç¼“å­˜é”®è®¾ç½®é”å®šï¼Œå…¶ä»–çº¿ç¨‹å°†ç­‰å¾…ç›´åˆ°è¯¥å…ƒç´ è¢«å¡«å……ï¼Œè€Œä¸æ˜¯è®¿é—®æ•°æ®åº“ï¼Œå³é˜²æ­¢ç¼“å­˜å‡»ç©¿</span></span><br><span class="line">      cache = <span class="keyword">new</span> BlockingCache(cache);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cache;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">"Error building standard cache decorators.  Cause: "</span> + e, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„å»ºå®Œåï¼ŒCacheå¯¹è±¡å¦‚ä¸‹ï¼Œæ³¨æ„<strong>delegate</strong>ï¼Œ<strong>é™¤äº†PerpetualCacheå¤–ï¼Œå‡ä¸ºè£…é¥°å™¨ï¼Œå¹¶ä¸”ä¸€å±‚è£…é¥°ä¸€å±‚ï¼Œç»„æˆéæ ‡å‡†çš„è´£ä»»é“¾</strong><br><img src="/images/mybatis/cache_ins.png" alt="avatar"></p><p>è°ƒç”¨æ ˆä¿¡æ¯å¦‚ä¸‹<br><img src="/images/mybatis/2_cache_invoke.png" alt="avatar"><br>å³äºŒçº§ç¼“å­˜çš„æ„å»ºæ˜¯åœ¨SqlSessionFactoryåˆå§‹åŒ–æ—¶ï¼Œè¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆäºŒçº§ç¼“å­˜å‘½ä¸­æ¡ä»¶ä¸åŒ…å«ç›¸åŒçš„sessionäº†</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h3&gt;&lt;p&gt;åœ¨é˜…è¯»MyBatisæºç å‰ï¼Œå»ºè®®å…ˆå»githubä¸Šclone MyBatisä»¥åŠMyBatis parentæºç ï¼Œåœ¨æœ¬åœ°æ­å»ºæµ‹è¯•ç¯å¢ƒï¼Œä»¥ä¾›ideaåœ¨æºç ä¸­æ‰“æ–­ç‚¹è°ƒè¯•ã€‚&lt;/p&gt;&lt;hr&gt;&lt;p&gt;MyBatisäºŒçº§ç¼“å­˜çš„è°ƒç”¨é€»è¾‘ä½äº&lt;strong&gt;CachingExecutor&lt;/strong&gt;ä¸­&lt;/p&gt;&lt;h3 id=&quot;CacheåŠå…¶å­ç±»&quot;&gt;CacheåŠå…¶å­ç±»&lt;/h3&gt;&lt;p&gt;Mybatisä½¿ç”¨CacheåŠå­ç±»æ¥å›Šæ‹¬æ‰€æœ‰ç¼“å­˜å®ç°&lt;br&gt;æ‰€æœ‰å­ç±»å¦‚ä¸‹å›¾ï¼ˆideaæŸ¥çœ‹ ç±»å³é”® -&amp;gt; Diagrams -&amp;gt; show Diagrams -&amp;gt; ctrl+alt+bé€‰æ‹©æ‰€æœ‰å­ç±»ï¼‰&lt;br&gt;&lt;img src=&quot;/images/mybatis/cache_child.png&quot; alt=&quot;avatar&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="MyBatis" scheme="https://zhucj94.github.io/tags/MyBatis/"/>
    
  </entry>
  
  <entry>
    <title>MyBatisæºç ä¹‹ä¸€çº§ç¼“å­˜</title>
    <link href="https://zhucj94.github.io/article/7dd9b5ec.html"/>
    <id>https://zhucj94.github.io/article/7dd9b5ec.html</id>
    <published>2020-07-19T09:39:32.000Z</published>
    <updated>2020-07-29T14:23:30.705Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€">å‰è¨€</h3><p>åœ¨é˜…è¯»MyBatisæºç å‰ï¼Œå»ºè®®å…ˆå»githubä¸Šclone MyBatisä»¥åŠMyBatis parentæºç ï¼Œåœ¨æœ¬åœ°æ­å»ºæµ‹è¯•ç¯å¢ƒï¼Œä»¥ä¾›ideaåœ¨æºç ä¸­æ‰“æ–­ç‚¹è°ƒè¯•ã€‚</p><hr><p>MyBatisä¸€çº§ç¼“å­˜çš„è°ƒç”¨é€»è¾‘ä½äº<strong>BaseExecutor</strong>ä¸­</p><h3 id="å­˜å‚¨ç»“æ„">å­˜å‚¨ç»“æ„</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> PerpetualCache localCache</span><br></pre></td></tr></table></figure><p>PerpetualCacheæ˜¯é€šè¿‡HashMapæ¥å­˜å‚¨çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PerpetualCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, Object&gt; cache = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><a id="more"></a><p>localCacheçš„keyæ˜¯CacheKeyå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheKey</span> <span class="keyword">implements</span> <span class="title">Cloneable</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_MULTIPLIER = <span class="number">37</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_HASHCODE = <span class="number">17</span>;</span><br><span class="line">  <span class="comment">//hashè®¡ç®—æ—¶ä¹˜çš„å€æ•°,é»˜è®¤æ„é€ ä¼šèµ‹å€¼DEFAULT_MULTIPLIER</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> multiplier; </span><br><span class="line">  <span class="comment">//hashç </span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> hashcode; </span><br><span class="line">  <span class="comment">//ä¸ä¹˜å€æ•°çš„hashç ç´¯åŠ å€¼</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> checksum;</span><br><span class="line">  <span class="comment">//è°ƒç”¨updateæ–¹æ³•çš„æ¬¡æ•°</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line">  <span class="comment">//æ‰€æœ‰updateå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;Object&gt; updateList;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// æ¯æ¬¡updateä¾¿ä¿®æ”¹hashcodeï¼Œcountï¼Œchecksumï¼ŒupdateList</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> baseHashCode = object == <span class="keyword">null</span> ? <span class="number">1</span> : ArrayUtil.hashCode(object);</span><br><span class="line"></span><br><span class="line">    count++;</span><br><span class="line">    checksum += baseHashCode;</span><br><span class="line">    baseHashCode *= count;</span><br><span class="line"></span><br><span class="line">    hashcode = multiplier * hashcode + baseHashCode;</span><br><span class="line"></span><br><span class="line">    updateList.add(object);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// æ¯”è¾ƒhashcodeï¼Œcountï¼Œchecksumï¼ŒupdateList</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> == object) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(object <span class="keyword">instanceof</span> CacheKey)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> CacheKey cacheKey = (CacheKey) object;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hashcode != cacheKey.hashcode) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (checksum != cacheKey.checksum) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (count != cacheKey.count) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; updateList.size(); i++) &#123;</span><br><span class="line">      Object thisObject = updateList.get(i);</span><br><span class="line">      Object thatObject = cacheKey.updateList.get(i);</span><br><span class="line">      <span class="keyword">if</span> (!ArrayUtil.equals(thisObject, thatObject)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> hashcode;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¼“å­˜çš„å‘½ä¸­æ¡ä»¶">ç¼“å­˜çš„å‘½ä¸­æ¡ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CacheKey <span class="title">createCacheKey</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ExecutorException(<span class="string">"Executor was closed."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  CacheKey cacheKey = <span class="keyword">new</span> CacheKey();</span><br><span class="line">  <span class="comment">//1.æ–¹æ³•å</span></span><br><span class="line">  cacheKey.update(ms.getId());</span><br><span class="line">  <span class="comment">//2.åç§»é‡</span></span><br><span class="line">  cacheKey.update(rowBounds.getOffset());</span><br><span class="line">  <span class="comment">//3.æŸ¥è¯¢æ•°é‡ä¸Šé™</span></span><br><span class="line">  cacheKey.update(rowBounds.getLimit());</span><br><span class="line">  <span class="comment">//4.sql</span></span><br><span class="line">  cacheKey.update(boundSql.getSql());</span><br><span class="line">  List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">  TypeHandlerRegistry typeHandlerRegistry = ms.getConfiguration().getTypeHandlerRegistry();</span><br><span class="line">  <span class="comment">// mimic DefaultParameterHandler logic</span></span><br><span class="line">  <span class="comment">// è§£æå‚æ•°</span></span><br><span class="line">  <span class="keyword">for</span> (ParameterMapping parameterMapping : parameterMappings) &#123;</span><br><span class="line">    <span class="keyword">if</span> (parameterMapping.getMode() != ParameterMode.OUT) &#123;</span><br><span class="line">      Object value;</span><br><span class="line">      String propertyName = parameterMapping.getProperty();</span><br><span class="line">      <span class="keyword">if</span> (boundSql.hasAdditionalParameter(propertyName)) &#123;</span><br><span class="line">        value = boundSql.getAdditionalParameter(propertyName);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameterObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">        value = <span class="keyword">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;</span><br><span class="line">        value = parameterObject;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        MetaObject metaObject = configuration.newMetaObject(parameterObject);</span><br><span class="line">        value = metaObject.getValue(propertyName);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//5.å‚æ•°</span></span><br><span class="line">      cacheKey.update(value);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//6.ç¯å¢ƒ</span></span><br><span class="line">  <span class="keyword">if</span> (configuration.getEnvironment() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// issue #176</span></span><br><span class="line">    cacheKey.update(configuration.getEnvironment().getId());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cacheKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºä¸€çº§ç¼“å­˜å‘½ä¸­æ¡ä»¶æ˜¯</p><ol><li><strong>ç›¸åŒçš„æ–¹æ³•ï¼ˆMappedStatementï¼‰</strong></li><li><strong>ç›¸åŒsqlï¼Œå‚æ•°</strong></li><li><strong>ç›¸åŒæŸ¥è¯¢èŒƒå›´ï¼Œå³åç§»é‡ï¼Œlimit</strong></li><li><strong>ç›¸åŒçš„session</strong>ï¼Œæ­¤ä»£ç ä¸­æœªä½“ç°ï¼Œä½†æ˜¯localCacheåœ¨BaseExecutorä¸­ï¼Œè€ŒBaseExecutorçš„åˆ›å»ºæ˜¯åœ¨åˆå§‹åŒ–sessionæ—¶ï¼Œè°ƒç”¨æ ˆä¿¡æ¯å¦‚ä¸‹å›¾ã€‚</li></ol><p><img src="/images/mybatis/1_cache_invoke.png" alt="avatar"></p><h3 id="ç¼“å­˜æ¸…é™¤æ¡ä»¶">ç¼“å­˜æ¸…é™¤æ¡ä»¶</h3><p>PerpetualCacheé€šè¿‡clearæ–¹æ³•æ¥æ¸…ç©ºç¼“å­˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PerpetualCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    cache.clear();</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æƒ…å†µå¦‚ä¸‹å›¾<br><img src="/images/mybatis/first_cache_clear.png" alt="avatar"></p><ol><li>å›æ»š</li><li>æäº¤</li><li>ä¿®æ”¹</li><li>æŸ¥è¯¢ï¼Œå½“è®¾ç½®flushCache=&quot;true&quot;æ—¶ï¼Œé»˜è®¤ä¸ºfalse</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (queryStack == <span class="number">0</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;</span><br><span class="line">    clearLocalCache();</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç”±äºäº‹åŠ¡æäº¤ä¼šæ¸…é™¤ç¼“å­˜ï¼Œæ‰€ä»¥è¦ç”¨åˆ°ä¸€çº§ç¼“å­˜ï¼Œè¿˜éœ€è¦åœ¨åŒä¸€äº‹åŠ¡ä¸­</strong></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h3&gt;&lt;p&gt;åœ¨é˜…è¯»MyBatisæºç å‰ï¼Œå»ºè®®å…ˆå»githubä¸Šclone MyBatisä»¥åŠMyBatis parentæºç ï¼Œåœ¨æœ¬åœ°æ­å»ºæµ‹è¯•ç¯å¢ƒï¼Œä»¥ä¾›ideaåœ¨æºç ä¸­æ‰“æ–­ç‚¹è°ƒè¯•ã€‚&lt;/p&gt;&lt;hr&gt;&lt;p&gt;MyBatisä¸€çº§ç¼“å­˜çš„è°ƒç”¨é€»è¾‘ä½äº&lt;strong&gt;BaseExecutor&lt;/strong&gt;ä¸­&lt;/p&gt;&lt;h3 id=&quot;å­˜å‚¨ç»“æ„&quot;&gt;å­˜å‚¨ç»“æ„&lt;/h3&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; PerpetualCache localCache&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;PerpetualCacheæ˜¯é€šè¿‡HashMapæ¥å­˜å‚¨çš„&lt;/p&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;PerpetualCache&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Cache&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; String id;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;Object, Object&amp;gt; cache = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
    
      <category term="MyBatis" scheme="https://zhucj94.github.io/tags/MyBatis/"/>
    
  </entry>
  
  <entry>
    <title>MySQLæ•°æ®ç±»å‹</title>
    <link href="https://zhucj94.github.io/article/47519a60.html"/>
    <id>https://zhucj94.github.io/article/47519a60.html</id>
    <published>2020-07-14T13:56:29.000Z</published>
    <updated>2020-07-24T06:18:36.202Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¼˜åŒ–æ•°æ®ç±»å‹çš„åŸåˆ™">ä¼˜åŒ–æ•°æ®ç±»å‹çš„åŸåˆ™</h3><ul><li><p>æ›´å°çš„é€šå¸¸æ›´å¥½<br>æ›´å°çš„æ•°æ®ç±»å‹é€šå¸¸æ›´å¿«ï¼Œå› ä¸ºå…¶å ç”¨æ›´å°‘çš„ç£ç›˜ï¼Œå†…å­˜ï¼ŒCPUç¼“å­˜ï¼Œå¤„ç†æ—¶éœ€è¦çš„CPUå‘¨æœŸä¹Ÿæ›´å°‘ã€‚</p></li><li><p>ç®€å•å°±å¥½<br>ç®€å•çš„æ•°æ®ç±»å‹çš„æ“ä½œé€šå¸¸éœ€è¦æ›´å°‘çš„CPUï¼Œä¾‹å¦‚æ•´å‹æ¯”å­—ç¬¦ä¸²æ“ä½œä»£ä»·ä½ï¼Œå› ä¸ºå­—ç¬¦é›†å’Œæ’åºè§„åˆ™ä½¿å­—ç¬¦æ¯”è¾ƒæ¯”æ•´å‹æ¯”è¾ƒæ›´å¤æ‚ã€‚</p></li><li><p>å°½é‡é¿å…NULL<br>å¯ä¸ºNULLçš„åˆ—ä½¿ç´¢å¼•ï¼Œç´¢å¼•ç»Ÿè®¡å’Œå€¼çš„æ¯”è¾ƒæ›´ä¸ºå¤æ‚ï¼Œå½“å¯ä¸ºNULLçš„åˆ—è¢«ç´¢å¼•æ—¶ï¼Œæ¯ä¸ªç´¢å¼•éœ€é¢å¤–çš„ä¸€ä¸ªå­—èŠ‚ã€‚</p></li></ul><h3 id="æ•´æ•°ç±»å‹">æ•´æ•°ç±»å‹</h3><p>TINYINTï¼ŒSMALLINTï¼ŒMEDIUMINTï¼ŒINTï¼ŒBIGINTï¼Œåˆ†åˆ«ä½¿ç”¨8ï¼Œ16ï¼Œ24ï¼Œ32ï¼Œ64ä½å­˜å‚¨ç©ºé—´ï¼ŒèŒƒå›´ä»$-2^{N-1}$ åˆ° $2^{N-1} -1$ ï¼Œå¯é€‰UNSIGNEDå±æ€§ï¼Œå³ä¸å…è®¸è´Ÿï¼Œè¿™æ ·æ­£æ•°ä¸Šçº¿æé«˜ä¸€å€ã€‚</p><p><strong>æŒ‡å®šçš„å®½åº¦é€šå¸¸æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œä¾‹å¦‚INT(11)ï¼Œå®ƒä¸ä¼šé™åˆ¶å€¼çš„åˆæ³•èŒƒå›´ï¼Œåªè§„å®šMySQLäº¤äº’å·¥å…·æ¥æ˜¾ç¤ºå­—ç¬¦ä¸ªæ•°ã€‚</strong></p><h3 id="å®æ•°ç±»å‹">å®æ•°ç±»å‹</h3><p>DECIMALï¼ŒFLOATï¼ŒDOUBLE<br>DECIMALç”¨äºå­˜å‚¨ç²¾ç¡®çš„å°æ•°ï¼Œ5.0ä»¥åæ”¯æŒç²¾ç¡®è®¡ç®—ã€‚é€šå¸¸DECIMALæ¯”FLOATï¼ŒDOUBLEå ç”¨æ›´å¤šçš„ç©ºé—´ã€‚å› ä¸ºéœ€è¦é¢å¤–çš„ç©ºé—´å’Œè®¡ç®—å¼€é”€ï¼Œ<strong>å°½é‡åªåœ¨å¯¹å°æ•°è¿›è¡Œç²¾ç¡®è®¡ç®—æ—¶ä½¿ç”¨DECIMALï¼ˆä¾‹å¦‚é’±ï¼‰ï¼Œå…¶ä½™æƒ…å†µä½¿ç”¨æµ®ç‚¹å‹å³å¯ï¼Œåœ¨æ•°æ®é‡æ¯”è¾ƒå¤§æ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨BIGINTä»£æ›¿DECIMALï¼Œå°†å­˜å‚¨çš„æ•°æ®ä¹˜ç›¸åº”ä½æ•°å­˜å‚¨ã€‚</strong></p><h3 id="å­—ç¬¦ä¸²ç±»å‹">å­—ç¬¦ä¸²ç±»å‹</h3><ul><li>VARCHAR ä¸ CHAR<br>VARCHAR<strong>æ˜¯å˜é•¿çš„</strong>ï¼Œå®ƒä»…éœ€è¦ä½¿ç”¨å¿…è¦çš„ç©ºé—´ï¼Œå®ƒéœ€è¦ä½¿ç”¨1æˆ–2ä¸ªå­—èŠ‚è¡¨ç¤ºå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå®ƒèŠ‚çº¦äº†ç©ºé—´ï¼Œä½†æ˜¯UPDATEå¯èƒ½ä½¿è¡Œæ¯”åŸæ¥æ›´é•¿ï¼Œå ç”¨çš„ç©ºé—´æ›´å¤§ï¼Œå¦‚æœé¡µå†…æ²¡æœ‰ç©ºä½™çš„ç©ºé—´å­˜å‚¨ï¼Œé‚£ä¹ˆInnoDBéœ€è¦åˆ†è£‚é¡µä½¿è¡Œæ”¾è¿›é¡µä¸­ã€‚</li></ul><p>CHARæ˜¯<strong>å®šé•¿çš„</strong>ï¼ŒMySQLæ€»æ˜¯æ ¹æ®å®šä¹‰çš„å­—ç¬¦ä¸²é•¿åº¦åˆ†é…è¶³å¤Ÿçš„ç©ºé—´ï¼ŒMySQLä¼š<strong>åˆ é™¤æœ«å°¾çš„ç©ºæ ¼</strong>ï¼Œå®ƒé€‚åˆå­˜å‚¨æ‰€æœ‰å€¼éƒ½æ¥è¿‘åŒä¸€é•¿åº¦ï¼Œä¾‹å¦‚å¯†ç çš„MD5å€¼ã€‚</p><ul><li>BLOB ä¸ TEXT<br>BLOBä¸TEXTä»…æœ‰å¤§çš„ä¸åŒæ˜¯BLOBæ˜¯äºŒè¿›åˆ¶ï¼Œè€ŒTEXTæ˜¯å­—ç¬¦é›†ï¼ŒTEXTæœ‰å­—ç¬¦é›†å’Œæ’åºè§„åˆ™ï¼Œè€ŒBLOBæ²¡æœ‰ã€‚</li></ul><p>MySQLåªå¯¹BLOBå’ŒTEXTçš„æœ€å‰max_sort_lengthå­—èŠ‚æ’åºï¼Œè€Œä¸æ˜¯æ•´ä¸ªå­—ç¬¦ä¸²ã€‚</p><ul><li>ENUM<br>ENUMæŠŠä¸€äº›ä¸é‡å¤çš„å­—ç¬¦ä¸²å­˜å‚¨æˆä¸€ä¸ªé¢„å®šä¹‰çš„é›†åˆï¼ŒMySQLå­˜å‚¨ENUMæ—¶éå¸¸ç´§å‡‘ï¼Œä¼šå°†å€¼å‹ç¼©åˆ°ä¸€ä¸ªæˆ–ä¸¤ä¸ªå­—èŠ‚ä¸­ã€‚<strong>MySQLå®é™…å­˜å‚¨ENUMä¸ºæ•´æ•°ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºå…¶åœ¨é›†åˆä¸­çš„ä½ç½®ã€‚</strong></li></ul><p>ENUMæŒ‰ç…§å­˜å‚¨çš„æ•´æ•°è¿›è¡Œæ’åºï¼Œè€Œä¸æ˜¯å®šä¹‰çš„å­—ç¬¦ä¸²ã€‚</p><p>æ·»åŠ æˆ–åˆ é™¤å­—ç¬¦ä¸²åªèƒ½ç”¨ALTER TABLEï¼Œå¯¹äºæœªæ¥ä¼šå‘ç”Ÿæ”¹å˜çš„å­—ç¬¦ä¸²ï¼Œä½¿ç”¨æšä¸¾ä¸å¤ªå¥½ã€‚<br>ENUMä¸VARCHARè¿›è¡Œå…³è”æŸ¥è¯¢æ—¶ï¼Œæ•ˆç‡ä¼šå˜ä½ï¼Œå¯èƒ½åŸå› æ˜¯ENUMå…³è”æ—¶è¿›è¡Œäº†ä¸€æ¬¡è½¬åŒ–ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ä¼˜åŒ–æ•°æ®ç±»å‹çš„åŸåˆ™&quot;&gt;ä¼˜åŒ–æ•°æ®ç±»å‹çš„åŸåˆ™&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;æ›´å°çš„é€šå¸¸æ›´å¥½&lt;br&gt;æ›´å°çš„æ•°æ®ç±»å‹é€šå¸¸æ›´å¿«ï¼Œå› ä¸ºå…¶å ç”¨æ›´å°‘çš„ç£ç›˜ï¼Œå†…å­˜ï¼ŒCPUç¼“å­˜ï¼Œå¤„ç†æ—¶éœ€è¦çš„CPUå‘¨æœŸä¹Ÿæ›´å°‘ã€‚&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;ç®€å•å°±å¥½&lt;br&gt;ç®€å•çš„æ•°æ®ç±»å‹çš„æ“ä½œé€šå¸¸éœ€è¦
      
    
    </summary>
    
    
    
      <category term="MySQL" scheme="https://zhucj94.github.io/tags/MySQL/"/>
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="https://zhucj94.github.io/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
      <category term="é«˜æ€§èƒ½MySQLç¬¬3ç‰ˆ" scheme="https://zhucj94.github.io/tags/%E9%AB%98%E6%80%A7%E8%83%BDMySQL%E7%AC%AC3%E7%89%88/"/>
    
  </entry>
  
  <entry>
    <title>MySQLç´¢å¼•ï¼ˆ2ï¼‰</title>
    <link href="https://zhucj94.github.io/article/be964bf6.html"/>
    <id>https://zhucj94.github.io/article/be964bf6.html</id>
    <published>2020-06-25T12:53:06.000Z</published>
    <updated>2020-07-24T06:18:36.278Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡æ¢è®¨**å¤šåˆ—ç´¢å¼•ï¼ˆç±»å‹ä¸ºB-TREEï¼‰**å¯¹å“ªäº›æŸ¥è¯¢æœ‰æ•ˆ<br>Mysqlç‰ˆæœ¬ä¸º5.7<br>ä¸‹é¢çš„sqlå‡æ˜¯åŸºäºä¸‹è¡¨~</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`emp`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`num`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`age`</span> <span class="built_in">int</span>(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`dept_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_age_deptid_name <span class="keyword">ON</span> emp(age,dept_id,<span class="keyword">name</span>)</span><br></pre></td></tr></table></figure><h3 id="explainå…³é”®å­—">explainå…³é”®å­—</h3><p><img src="/images/index/explain.png" alt="avatar"></p><ul><li>possible_keysï¼šæ˜¾ç¤ºå¯èƒ½åº”ç”¨åœ¨è¿™å¼ è¡¨ä¸­çš„ç´¢å¼•ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªï¼Œä½†ä¸ä¸€å®šè¢«æŸ¥è¯¢å®é™…ä½¿ç”¨ã€‚</li><li>keyï¼š<strong>å®é™…ä½¿ç”¨çš„ç´¢å¼•ã€‚å¦‚æœä¸ºNULLï¼Œåˆ™æ²¡æœ‰ä½¿ç”¨ç´¢å¼•</strong>ã€‚</li><li>key_lenï¼šè¡¨ç¤ºç´¢å¼•ä¸­ä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œèƒ½å¤Ÿå¸®ä½ æ£€æŸ¥æ˜¯å¦å……åˆ†çš„åˆ©ç”¨ä¸Šäº†ç´¢å¼•ã€‚</li><li>extraï¼šé‡è¦çš„é¢å¤–ä¿¡æ¯<ul><li>Using filesortï¼šæ— æ³•ä½¿ç”¨ç´¢å¼•æ’åºï¼Œä½¿ç”¨æ•ˆç‡ä½çš„æ–‡ä»¶æ’åº</li><li>Using temporaryï¼šä½¿ç”¨ä¸´æ—¶è¡¨ä¿å­˜ä¸­é—´ç»“æœ,å¸¸è§äº order by å’Œ group by</li><li>Using index conditionï¼šä½¿ç”¨ç´¢å¼•æ¡ä»¶ä¸‹æ¨ï¼ˆ5.6åŠ å…¥ï¼‰</li><li>Using indexï¼šä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œä¸éœ€è¦å›è¡¨</li><li>Using where</li><li>Using join buffer</li><li>impossible where</li><li>select tables optimized away</li></ul></li></ul><h3 id="æœ€å·¦å‰ç¼€åŸåˆ™">æœ€å·¦å‰ç¼€åŸåˆ™</h3><p>å¦‚æœç´¢å¼•äº†å¤šåˆ—ï¼Œ<strong>æŸ¥è¯¢ä»ç´¢å¼•çš„æœ€å·¦åˆ—å¼€å§‹å¹¶ä¸”ä¸è·³è¿‡ç´¢å¼•ä¸­çš„åˆ—ã€‚</strong><br><img src="/images/index/left1.png" alt="avatar"></p><p><img src="/images/index/left2.png" alt="avatar"></p><p><img src="/images/index/left3.png" alt="avatar"></p><p>å›¾2ç”±äºä¸æ˜¯ä»ç´¢å¼•æœ€å·¦åˆ—å¼€å§‹ï¼Œæ‰€ä»¥æ²¡æœ‰ç”¨åˆ°ç´¢å¼•ï¼ˆkeyä¸ºNULLï¼‰<br>å›¾3è™½ç„¶ç”¨åˆ°äº†ç´¢å¼•ï¼Œä½†æ˜¯è·³è¿‡äº†dept_idï¼Œåªç”¨åˆ°äº†ç´¢å¼•çš„ä¸€éƒ¨åˆ†ï¼ˆkey_len 5 &lt; 93ï¼‰</p><h3 id="ä¸åœ¨ç´¢å¼•åˆ—ä¸Šåšä»»ä½•æ“ä½œ-ç´¢å¼•ä¸èƒ½æ˜¯è¡¨è¾¾å¼çš„ä¸€éƒ¨åˆ†">ä¸åœ¨ç´¢å¼•åˆ—ä¸Šåšä»»ä½•æ“ä½œ(ç´¢å¼•ä¸èƒ½æ˜¯è¡¨è¾¾å¼çš„ä¸€éƒ¨åˆ†)</h3><p>è®¡ç®—ã€å‡½æ•°ã€(è‡ªåŠ¨oræ‰‹åŠ¨)ç±»å‹è½¬æ¢ï¼Œä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆ<br><img src="/images/index/oper1.png" alt="avatar"></p><p><img src="/images/index/oper2.png" alt="avatar"></p><p><img src="/images/index/oper3.png" alt="avatar"></p><p>å›¾1ç”±äºåœ¨ç´¢å¼•ä¸Šè®¡ç®—å¯¼è‡´æ— æ³•ä½¿ç”¨ç´¢å¼•<br>å›¾2ç”±äºåœ¨ç´¢å¼•ä¸Šä½¿ç”¨äº†å‡½æ•°å¯¼è‡´æ— æ³•ä½¿ç”¨ç´¢å¼•<br>å›¾3ç”±äºåœ¨nameä¸Šæœ‰ç±»å‹è½¬æ¢ï¼ˆ<strong>nameä¸ºvarcharï¼Œ123æ²¡æœ‰å¼•å·</strong>ï¼‰ï¼Œå¯¼è‡´nameå¤±æ•ˆï¼ˆkey_len 10&lt; 93ï¼‰</p><h3 id="èŒƒå›´æ¡ä»¶å³ä¾§çš„åˆ—æ— æ³•ä½¿ç”¨ç´¢å¼•">èŒƒå›´æ¡ä»¶å³ä¾§çš„åˆ—æ— æ³•ä½¿ç”¨ç´¢å¼•</h3><p><img src="/images/index/range.png" alt="avatar"><br>ç”±äºageä½¿ç”¨èŒƒå›´æŸ¥è¯¢ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨èŒƒå›´æŸ¥è¯¢å³ä¾§çš„dept_idå’Œnameï¼ˆkey_len 5 &lt; 93ï¼‰</p><h3 id="ä¸ç­‰äºæ— æ³•ä½¿ç”¨ç´¢å¼•">ä¸ç­‰äºæ— æ³•ä½¿ç”¨ç´¢å¼•</h3><p><img src="/images/index/notequal.png" alt="avatar"><br>ç”±äºageä½¿ç”¨äº†ä¸ç­‰äºï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨ç´¢å¼•</p><h3 id="is-not-nullæ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œis-nullå¯ä»¥">is not nullæ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œis nullå¯ä»¥</h3><p><img src="/images/index/isnotnull.png" alt="avatar"></p><h3 id="likeä»¥é€šé…ç¬¦å¼€å¤´ä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼Œä»¥é€šé…ç¬¦ç»“æŸå¯ä»¥">likeä»¥é€šé…ç¬¦å¼€å¤´ä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼Œä»¥é€šé…ç¬¦ç»“æŸå¯ä»¥</h3><p><img src="/images/index/like.png" alt="avatar"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æœ¬æ–‡æ¢è®¨**å¤šåˆ—ç´¢å¼•ï¼ˆç±»å‹ä¸ºB-TREEï¼‰**å¯¹å“ªäº›æŸ¥è¯¢æœ‰æ•ˆ&lt;br&gt;Mysqlç‰ˆæœ¬ä¸º5.7&lt;br&gt;ä¸‹é¢çš„sqlå‡æ˜¯åŸºäºä¸‹è¡¨~&lt;/p&gt;&lt;figure class=&quot;highlight sql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span 
      
    
    </summary>
    
    
    
      <category term="MySQL" scheme="https://zhucj94.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQLç´¢å¼•ï¼ˆ1)</title>
    <link href="https://zhucj94.github.io/article/b5580210.html"/>
    <id>https://zhucj94.github.io/article/b5580210.html</id>
    <published>2020-06-23T08:43:54.000Z</published>
    <updated>2020-07-24T06:18:36.284Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å‰ç¼€ç´¢å¼•å’Œç´¢å¼•é€‰æ‹©æ€§">å‰ç¼€ç´¢å¼•å’Œç´¢å¼•é€‰æ‹©æ€§</h3><ul><li>å‰ç¼€ç´¢å¼•<br>å‰ç¼€ç´¢å¼•æ˜¯ä¸€ç§èƒ½ä½¿ç´¢å¼•æ›´å°ï¼Œæ›´å¿«çš„æ–¹å¼ï¼Œå³åªç´¢å¼•å¼€å§‹çš„éƒ¨åˆ†å­—ç¬¦ï¼Œè¿™æ ·å¯ä»¥èŠ‚çº¦ç´¢å¼•ç©ºé—´ï¼Œæé«˜ç´¢å¼•æ•ˆç‡ã€‚<br>å¯¹äºBLOBï¼ŒTEXTï¼Œå¾ˆé•¿çš„VARCHARåˆ—ï¼Œå¿…é¡»ä½¿ç”¨å‰ç¼€ç´¢å¼•ï¼Œå› ä¸ºMySQLä¸å…è®¸ç´¢å¼•è¿™äº›åˆ—çš„å®Œæ•´é•¿åº¦ã€‚</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> dept <span class="keyword">add</span> <span class="keyword">key</span>(<span class="keyword">name</span>(<span class="number">5</span>))</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ä¹Ÿä¼šé™ä½ç´¢å¼•é€‰æ‹©æ€§ã€‚</p><ul><li><p>ç´¢å¼•é€‰æ‹©æ€§<br><strong>ä¸é‡å¤çš„ç´¢å¼•å€¼å’Œæ•°æ®è¡¨çš„è®°å½•æ€»æ•°çš„æ¯”å€¼ï¼Œç´¢å¼•é€‰æ‹©æ€§è¶Šé«˜åˆ™æŸ¥è¯¢æ•ˆç‡è¶Šé«˜</strong>ï¼Œå› ä¸ºé€‰æ‹©æ€§é«˜çš„ç´¢å¼•èƒ½è®©MySQLåœ¨æŸ¥æ‰¾æ—¶è¿‡æ»¤æ›´å¤šçš„è¡Œã€‚</p></li><li><p>è®¡ç®—ç´¢å¼•é€‰æ‹©æ€§</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">count</span>( <span class="keyword">DISTINCT</span> <span class="keyword">LEFT</span> ( <span class="keyword">NAME</span>, <span class="number">3</span> ) ) / <span class="keyword">count</span>( <span class="number">1</span> ) sel3,</span><br><span class="line">    <span class="keyword">count</span>( <span class="keyword">DISTINCT</span> <span class="keyword">LEFT</span> ( <span class="keyword">NAME</span>, <span class="number">4</span> ) ) / <span class="keyword">count</span>( <span class="number">1</span> ) sel4,</span><br><span class="line">    <span class="keyword">count</span>( <span class="keyword">DISTINCT</span> <span class="keyword">LEFT</span> ( <span class="keyword">NAME</span>, <span class="number">5</span> ) ) / <span class="keyword">count</span>( <span class="number">1</span> ) sel5</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    dept</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬æ¥è¯´èƒ½å¤Ÿæ¥è¿‘0.031ï¼ŒåŸºæœ¬å°±å¯ç”¨ã€‚</p><h3 id="å¤šåˆ—ç´¢å¼•åŠç´¢å¼•åˆ—çš„é¡ºåº">å¤šåˆ—ç´¢å¼•åŠç´¢å¼•åˆ—çš„é¡ºåº</h3><ul><li>å¤šåˆ—ç´¢å¼•<br>å³ç´¢å¼•åŒ…å«å¤šåˆ—ï¼Œä¾‹å¦‚ä¸‹ç¯‡æ–‡ç« çš„idx_age_deptid_name</li></ul><p>åœ¨å¤šä¸ªåˆ—ä¸Šå»ºç«‹ç‹¬ç«‹çš„å•åˆ—ç´¢å¼•å¤§éƒ¨åˆ†æƒ…å†µå¹¶ä¸èƒ½æé«˜æŸ¥è¯¢æ€§èƒ½ï¼ˆæŸ¥è¯¢æ¡ä»¶ä¸æ­¢ä¸€ä¸ªçš„æƒ…å†µï¼‰ï¼Œå› ä¸º<strong>æ—©æœŸMySQLåªèƒ½ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªå•åˆ—ç´¢å¼•ï¼Œ5.0åå¼•å…¥äº†ç´¢å¼•åˆå¹¶ï¼ˆindex mergeï¼‰ç­–ç•¥ï¼Œå³å¯ä»¥åŒæ—¶ä½¿ç”¨å‡ ä¸ªç´¢å¼•ï¼Œå¹¶å°†ç»“æœåˆå¹¶ï¼Œä½†æ˜¯åœ¨åˆå¹¶æ“ä½œä¸Šä¼šè€—è´¹å¤§é‡èµ„æºï¼Œä¸”MySQLè¿˜éµå¾ªrangeä¼˜å…ˆåŸåˆ™ï¼Œå³ä¸€ä¸ªç´¢å¼•çš„è¿ç»­æ®µåŒ…å«æ‰€æœ‰ç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„ç´¢å¼•æ—¶ï¼Œä¸ä½¿ç”¨ç´¢å¼•åˆå¹¶</strong>ã€‚</p><ul><li>å¤šåˆ—ç´¢å¼•é¡ºåºç»éªŒæ³•åˆ™<br>å°†é€‰æ‹©æ€§æœ€é«˜çš„åˆ—æ”¾åˆ°ç´¢å¼•æœ€å‰åˆ—</li></ul><h3 id="èšç°‡ç´¢å¼•">èšç°‡ç´¢å¼•</h3><p>èšç°‡ç´¢å¼•ä¸æ˜¯ä¸€ç§ç´¢å¼•ç±»å‹ï¼Œè€Œæ˜¯ä¸€ç§æ•°æ®å­˜å‚¨æ–¹å¼ã€‚<br>InnoDBçš„èšç°‡ç´¢å¼•å®é™…ä¸Šåœ¨<strong>åŒä¸€ç»“æ„ä¸­ä¿å­˜äº†B-Treeç´¢å¼•å’Œæ•°æ®è¡Œ</strong>ï¼Œå³å½“è¡¨æœ‰èšç°‡ç´¢å¼•æ—¶ï¼Œæ•°æ®è¡Œå®é™…å­˜æ”¾åœ¨ç´¢å¼•çš„å¶å­é¡µä¸­ã€‚</p><p><img src="/images/index/clustered_index.png" alt="avatar"></p><p><strong>InnoDBä¸€å®šä¼šæœ‰èšç°‡ç´¢å¼•</strong>ï¼Œæœ‰ä¸»é”®æ—¶å°±æ˜¯ä¸»é”®ï¼Œæ²¡æœ‰å®šä¹‰ä¸»é”®ï¼ŒInnoDBä¼šé€‰æ‹©å”¯ä¸€çš„éç©ºç´¢å¼•ä»£æ›¿ï¼Œå¦‚æœ‰æ²¡æœ‰è¿™æ ·çš„ç´¢å¼•ï¼Œä¼šéšå¼å®šä¹‰ä¸€ä¸ªä¸»é”®ã€‚</p><ul><li><p>ç¼ºç‚¹</p><ul><li>æ’å…¥é€Ÿåº¦ä¾èµ–æ’å…¥é¡ºåºï¼Œå¦‚æœä¸æŒ‰ç…§ä¸»é”®é¡ºåºåŠ è½½æ•°æ®ï¼Œé‚£ä¹ˆåœ¨åŠ è½½å®Œæˆåæœ€å¥½ä½¿ç”¨OPTIMIZE TABLEé‡æ–°ç»„ç»‡è¡¨ã€‚ä¸‹é¢ä¸¤å¼ å›¾åˆ†åˆ«ä¸ºidä¸ºé€’å¢å’ŒUUIDçš„æƒ…å†µã€‚<br><img src="/images/index/insert2.png" alt="avatar"></li></ul><p><img src="/images/index/insert1.png" alt="avatar"></p><ul><li>æ›´æ–°èšç°‡ç´¢å¼•åˆ—ä»£ä»·é«˜ï¼Œå› ä¸ºä¼šå¼ºåˆ¶å°†è¢«æ›´æ–°çš„è¡Œç§»åŠ¨åˆ°æ–°ä½ç½®ã€‚</li><li>å¯èƒ½ä¼šæœ‰â€˜é¡µåˆ†è£‚ï¼ˆpage splitï¼‰â€™é—®é¢˜ï¼Œå½“è¡Œæ’å…¥åˆ°æŸä¸ªå·²æ»¡çš„é¡µä¸­ï¼Œå­˜å‚¨å¼•æ“ä¼šå°†é¡µåˆ†è£‚æˆä¸¤ä¸ªé¡µï¼Œè¿™ä¼šå¯¼è‡´è¡¨å ç”¨æ›´å¤šçš„ç©ºé—´ã€‚</li><li><strong>InnoDBçš„äºŒçº§ç´¢å¼•ä¼šæœ‰â€˜å›è¡¨â€™é—®é¢˜ï¼Œå› ä¸ºäºŒçº§ç´¢å¼•å¶å­èŠ‚ç‚¹ä¿å­˜çš„æ˜¯è¡Œçš„ä¸»é”®å€¼ï¼Œè€Œä¸æ˜¯â€˜è¡ŒæŒ‡é’ˆâ€™ï¼Œæ‰€ä»¥ä½¿ç”¨äºŒçº§ç´¢å¼•çš„æŸ¥è¯¢éœ€è¦å…ˆæ‰¾åˆ°äºŒçº§ç´¢å¼•çš„å¶å­èŠ‚ç‚¹è·å–ä¸»é”®å€¼ï¼Œç„¶åå»èšç°‡ç´¢å¼•æŸ¥æ‰¾å¯¹åº”çš„è¡Œã€‚</strong></li></ul></li></ul><h3 id="è¦†ç›–ç´¢å¼•">è¦†ç›–ç´¢å¼•</h3><p>å¦‚æœä¸€ä¸ªç´¢å¼•åŒ…å«æ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„å­—æ®µçš„å€¼ï¼Œå°±ç§°ä¸ºè¦†ç›–ç´¢å¼•ï¼ŒMySQLåªèƒ½ç”¨B-TREEç´¢å¼•åšè¦†ç›–ç´¢å¼•ï¼Œå› ä¸ºåªæœ‰B-TREEç´¢å¼•å­˜å‚¨äº†ç´¢å¼•åˆ—çš„å€¼ã€‚</p><p><strong>å¦‚æœInnoDBçš„æŸ¥è¯¢èƒ½ç”¨åˆ°è¦†ç›–ç´¢å¼•ï¼Œé‚£ä¹ˆå°±å¯ä»¥é¿å…â€˜å›è¡¨â€™ã€‚</strong></p><p>å¦‚æœæŸ¥è¯¢çš„åˆ—ç”±ç´¢å¼•å’Œä¸»é”®ç»„æˆï¼Œä¹Ÿæ˜¯è¦†ç›–ç´¢å¼•ï¼Œå› ä¸ºäºŒçº§ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¿å­˜äº†ä¸»é”®å€¼ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;å‰ç¼€ç´¢å¼•å’Œç´¢å¼•é€‰æ‹©æ€§&quot;&gt;å‰ç¼€ç´¢å¼•å’Œç´¢å¼•é€‰æ‹©æ€§&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;å‰ç¼€ç´¢å¼•&lt;br&gt;å‰ç¼€ç´¢å¼•æ˜¯ä¸€ç§èƒ½ä½¿ç´¢å¼•æ›´å°ï¼Œæ›´å¿«çš„æ–¹å¼ï¼Œå³åªç´¢å¼•å¼€å§‹çš„éƒ¨åˆ†å­—ç¬¦ï¼Œè¿™æ ·å¯ä»¥èŠ‚çº¦ç´¢å¼•ç©ºé—´ï¼Œæé«˜ç´¢å¼•æ•ˆç‡ã€‚&lt;br&gt;å¯¹äºBLOBï¼ŒTEXTï¼Œå¾ˆé•¿çš„VARCHARåˆ—ï¼Œå¿…é¡»ä½¿ç”¨å‰ç¼€ç´¢å¼•ï¼Œå› ä¸º
      
    
    </summary>
    
    
    
      <category term="MySQL" scheme="https://zhucj94.github.io/tags/MySQL/"/>
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="https://zhucj94.github.io/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
      <category term="é«˜æ€§èƒ½MySQLç¬¬3ç‰ˆ" scheme="https://zhucj94.github.io/tags/%E9%AB%98%E6%80%A7%E8%83%BDMySQL%E7%AC%AC3%E7%89%88/"/>
    
  </entry>
  
  <entry>
    <title>InnoDBä¹‹ç¼“å†²æ± (buffer pool)</title>
    <link href="https://zhucj94.github.io/article/3e77f45e.html"/>
    <id>https://zhucj94.github.io/article/3e77f45e.html</id>
    <published>2020-06-11T14:20:10.000Z</published>
    <updated>2020-07-24T06:18:36.150Z</updated>
    
    <content type="html"><![CDATA[<p>MySQLä½œä¸ºä¸€ä¸ªå­˜å‚¨ç³»ç»Ÿï¼Œå…·æœ‰ <em><strong>buffer pool</strong></em> æœºåˆ¶ï¼Œä»¥é¿å…æ¯æ¬¡æŸ¥è¯¢éƒ½è¿›è¡Œç£ç›˜IOã€‚</p><h3 id="ç¼“å­˜ä»€ä¹ˆ">ç¼“å­˜ä»€ä¹ˆ</h3><p>ç¼“å­˜è¡¨æ•°æ®ä¸ç´¢å¼•æ•°æ®</p><h3 id="é¢„è¯»ï¼ˆread-aheadï¼‰">é¢„è¯»ï¼ˆread-aheadï¼‰</h3><ul><li>pageæ˜¯InnoDBå­˜å‚¨å¼•æ“çš„æœ€å°ç£ç›˜å•ä½ï¼Œä¸€æ¬¡è‡³å°‘è¯»å–ä¸€ä¸ªpageï¼Œextentæ˜¯ç”±è¿ç»­çš„pageç»„æˆçš„ç©ºé—´ã€‚</li><li>å¦‚æœä¸€ä¸ªextentä¸­è¢«é¡ºåºè¯»å–çš„pageè¶…è¿‡æˆ–è€…ç­‰äºinnodb_read_ahead_thresholdæ—¶ï¼ŒInnoDBå°†ä¼šå¼‚æ­¥çš„å°†ä¸‹ä¸€ä¸ªextentè¯»å–åˆ°buffer poolä¸­ï¼ˆä»¥linear read-aheadæ¦‚è¿°ï¼Œrandom read-aheadåœ¨5.5åè¢«åºŸå¼ƒï¼‰ã€‚</li><li>é¢„è¯»çš„ä¾æ®æ˜¯<strong>å±€éƒ¨æ€§åŸç†</strong> : CPUè®¿é—®å­˜å‚¨å™¨æ—¶ï¼Œæ— è®ºæ˜¯å­˜å–æŒ‡ä»¤è¿˜æ˜¯å­˜å–æ•°æ®ï¼Œæ‰€è®¿é—®çš„å­˜å‚¨å•å…ƒéƒ½è¶‹äºèšé›†åœ¨ä¸€ä¸ªè¾ƒå°çš„è¿ç»­åŒºåŸŸä¸­ã€‚</li></ul><h3 id="æ·˜æ±°ç®—æ³•">æ·˜æ±°ç®—æ³•</h3><p>é‡‡ç”¨æ”¹è¿›ç‰ˆçš„LRUç®—æ³•ï¼Œä¼ ç»Ÿçš„LRUç®—æ³•ä¼šé‡åˆ°ä¸¤ä¸ªé—®é¢˜</p><ul><li><p>é¢„è¯»å¤±è´¥<br>ç”±äºé¢„è¯»ï¼Œæå‰å°†pageæ”¾å…¥ç¼“å†²æ± ï¼Œä½†æœ€ç»ˆæ²¡æœ‰ä»é¡µä¸­è¯»å–æ•°æ®ã€‚<br>æ”¹è¿›ï¼š</p><ul><li>å°†LRUåˆ†ä¸ºæ–°ç”Ÿä»£ï¼ˆnew sublistï¼‰ï¼Œè€ç”Ÿä»£ï¼ˆold sublistï¼‰ã€‚</li><li>æ–°è€ç”Ÿä»£é¦–å°¾ç›¸è¿ã€‚</li><li>æ–°é¡µåŠ å…¥ç¼“å†²æ± æ—¶ï¼ŒåªåŠ å…¥è€ç”Ÿä»£å¤´éƒ¨ï¼Œå¦‚æœæ•°æ®è¢«çœŸæ­£è¯»å–åˆ°ï¼Œæ‰ä¼šåŠ å…¥æ–°ç”Ÿä»£å¤´éƒ¨ï¼Œå¦‚æœæ²¡æœ‰è¢«è¯»å–ï¼Œåˆ™ä¼šæ¯”æ–°ç”Ÿä»£é‡Œçš„æ•°æ®æ›´æ—©è¢«æ·˜æ±°</li></ul></li><li><p>ç¼“å†²æ± æ±¡æŸ“<br>å½“æ‰§è¡ŒæŸä¸ªSQLæ—¶ï¼Œè¦æ‰¹é‡æ‰«æå¤§é‡æ•°æ®ï¼ˆä¾‹å¦‚æœªå‘½ä¸­ç´¢å¼•ï¼Œè€Œå…¨è¡¨æ‰«æï¼‰ï¼Œå¯¼è‡´å¤§é‡çƒ­æ•°æ®è¢«æ·˜æ±°ã€‚<br>æ”¹è¿›ï¼š</p><ul><li>æ’å…¥è€ç”Ÿä»£å¤´éƒ¨çš„é¡µï¼Œå³ä½¿ç«‹åˆ»è¢«è®¿é—®ï¼Œä¹Ÿä¸ä¼šæ”¾å…¥æ–°ç”Ÿä»£å¤´éƒ¨ã€‚</li><li>åªæœ‰æ»¡è¶³ <em><strong>è¢«è®¿é—®</strong></em> ä¸” <em><strong>åœ¨è€ç”Ÿä»£åœç•™æ—¶é—´å¤§äºT</strong></em>ï¼Œæ‰ä¼šè¢«æ”¾å…¥æ–°ç”Ÿä»£å¤´éƒ¨ã€‚</li></ul></li></ul><p><img src="/images/InnoDB/newlru.png" alt="avatar"></p><h3 id="ç›¸å…³å‚æ•°">ç›¸å…³å‚æ•°</h3><ul><li>innodb_buffer_pool_size<br>ç¼“å†²æ± çš„å¤§å°</li><li>innodb_old_blocks_pct<br>è€ç”Ÿä»£å æ•´ä¸ªLRUé“¾é•¿åº¦çš„æ¯”ä¾‹ï¼Œé»˜è®¤æ˜¯37</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;MySQLä½œä¸ºä¸€ä¸ªå­˜å‚¨ç³»ç»Ÿï¼Œå…·æœ‰ &lt;em&gt;&lt;strong&gt;buffer pool&lt;/strong&gt;&lt;/em&gt; æœºåˆ¶ï¼Œä»¥é¿å…æ¯æ¬¡æŸ¥è¯¢éƒ½è¿›è¡Œç£ç›˜IOã€‚&lt;/p&gt;&lt;h3 id=&quot;ç¼“å­˜ä»€ä¹ˆ&quot;&gt;ç¼“å­˜ä»€ä¹ˆ&lt;/h3&gt;&lt;p&gt;ç¼“å­˜è¡¨æ•°æ®ä¸ç´¢å¼•æ•°æ®&lt;/p&gt;&lt;h3 id=&quot;é¢„è¯»ï¼ˆread-ahea
      
    
    </summary>
    
    
    
      <category term="MySQL" scheme="https://zhucj94.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>InnoDBçš„é”ï¼ˆ3xï¼‰</title>
    <link href="https://zhucj94.github.io/article/5533cdb0.html"/>
    <id>https://zhucj94.github.io/article/5533cdb0.html</id>
    <published>2020-05-16T08:15:16.000Z</published>
    <updated>2020-07-24T06:18:36.176Z</updated>
    
    <content type="html"><![CDATA[<h3 id="è¡Œé”ç­–ç•¥">è¡Œé”ç­–ç•¥</h3><ol><li>åŠ é”çš„åŸºæœ¬å•ä½æ˜¯ä¸´é”®é”ã€‚ï¼ˆè®°å½•é”+é—´éš™é”ï¼Œå·¦å¼€å³é—­åŒºé—´ï¼‰</li><li>æŸ¥æ‰¾åˆ°æ•°æ®æ‰ä¼šåŠ è®°å½•é”ã€‚</li><li>å”¯ä¸€ç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼ˆå‘½ä¸­ï¼‰ï¼Œé—´éš™é”é€€åŒ–ä¸ºè®°å½•é”ã€‚</li><li>è¾…åŠ©ç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼ˆå‘½ä¸­ï¼‰ï¼Œä¼šåœ¨å³ä¾§ç›¸é‚»é—´éš™åŠ ä¸Šé—´éš™é”ã€‚</li><li>å”¯ä¸€ç´¢å¼•ä¸Šçš„èŒƒå›´æŸ¥è¯¢ï¼ˆç­‰å€¼æ¡ä»¶å‘½ä¸­ï¼Œä¾‹å¦‚&lt;=çš„ç­‰äºå‘½ä¸­ï¼‰,ä¼šåœ¨å³ä¾§ç›¸é‚»é—´éš™åŠ ä¸Šä¸´é”®é”ã€‚</li></ol><h3 id="ä¾‹å­">ä¾‹å­</h3><p>// todo</p><p>å‚è€ƒ<br><a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-locking.html#innodb-auto-inc-locks" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.6/en/innodb-locking.html#innodb-auto-inc-locks</a></p><p><a href="https://blog.guitar-coder.cn/MySql%E9%94%81-%E9%97%B4%E9%9A%99%E9%94%81%E5%92%8C%E4%B8%B4%E9%94%AE%E9%94%81.html" target="_blank" rel="noopener">https://blog.guitar-coder.cn/MySqlé”-é—´éš™é”å’Œä¸´é”®é”.html</a></p><p><a href="https://www.cnblogs.com/zhoujinyi/p/3435982.html" target="_blank" rel="noopener">https://www.cnblogs.com/zhoujinyi/p/3435982.html</a></p><p><a href="https://time.geekbang.org/column/article/75659" target="_blank" rel="noopener">https://time.geekbang.org/column/article/75659</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;è¡Œé”ç­–ç•¥&quot;&gt;è¡Œé”ç­–ç•¥&lt;/h3&gt;&lt;ol&gt;&lt;li&gt;åŠ é”çš„åŸºæœ¬å•ä½æ˜¯ä¸´é”®é”ã€‚ï¼ˆè®°å½•é”+é—´éš™é”ï¼Œå·¦å¼€å³é—­åŒºé—´ï¼‰&lt;/li&gt;&lt;li&gt;æŸ¥æ‰¾åˆ°æ•°æ®æ‰ä¼šåŠ è®°å½•é”ã€‚&lt;/li&gt;&lt;li&gt;å”¯ä¸€ç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼ˆå‘½ä¸­ï¼‰ï¼Œé—´éš™é”é€€åŒ–ä¸ºè®°å½•é”ã€‚&lt;/li&gt;&lt;li&gt;è¾…åŠ©ç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼ˆå‘½ä¸­ï¼‰ï¼Œä¼šåœ¨
      
    
    </summary>
    
    
    
      <category term="MySQL" scheme="https://zhucj94.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>InnoDBçš„é”ï¼ˆ3ï¼‰</title>
    <link href="https://zhucj94.github.io/article/6f88bd9.html"/>
    <id>https://zhucj94.github.io/article/6f88bd9.html</id>
    <published>2020-05-14T13:56:50.000Z</published>
    <updated>2020-07-24T06:18:36.171Z</updated>
    
    <content type="html"><![CDATA[<p>InnoDB performs row-level locking in such a way that when it searches or scans a table index, it sets shared or exclusive locks on the index records it encounters. Thus, the row-level locks are actually index-record locks. (InnoDBæ‰§è¡Œè¡Œçº§é”æ–¹å¼æ˜¯å½“å®ƒæœç´¢æˆ–æ‰«æè¡¨ç´¢å¼•æ—¶ï¼Œä¼šåœ¨é‡åˆ°çš„ç´¢å¼•ä¸ŠåŠ å…±äº«æˆ–æ’ä»–é”ï¼Œæ•…è¡Œçº§é”å®é™…ä¸Šæ—¶ç´¢å¼•è®°å½•é”)</p><h3 id="è®°å½•é”ï¼ˆRecord-Locksï¼‰">è®°å½•é”ï¼ˆRecord Locksï¼‰</h3><ul><li><p>å®šä¹‰<br>A record lock is a lock on an <strong>index record</strong> ï¼ˆè®°å½•é”é”å®šçš„æ˜¯<strong>ç´¢å¼•</strong>è®°å½•ï¼‰</p></li><li><p>ä¾‹å­</p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM WHERE id &#x3D; 1 FOR UPDATE;</span><br></pre></td></tr></table></figure><p>å®ƒä¼šåœ¨id=1çš„ç´¢å¼•è®°å½•ä¸ŠåŠ é”ï¼Œä»¥é˜»æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥ï¼Œæ›´æ–°ï¼Œåˆ é™¤id=1çš„è¿™ä¸€è¡Œ</p><h3 id="é—´éš™é”ï¼ˆGap-Locksï¼‰">é—´éš™é”ï¼ˆGap Locksï¼‰</h3><ul><li>å®šä¹‰<br>A gap lock is a lock on a gap between index records, or a lock on the gap before the first or after the last index record.ï¼ˆé—´éš™é”é”å®šçš„æ˜¯<strong>ç´¢å¼•</strong>è®°å½•é—´çš„é—´éš”ï¼Œæˆ–æ˜¯ç¬¬ä¸€æ¡ç´¢å¼•ä¹‹å‰çš„èŒƒå›´ï¼Œäº¦æˆ–æ˜¯æœ€åä¸€æ¡ç´¢å¼•ä¹‹åçš„èŒƒå›´ï¼‰</li><li>ä¾‹å­</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM t WHERE id BETWEEN 10 and 20 FOR UPDATE;</span><br></pre></td></tr></table></figure><p>ä¼šé”å®šï¼ˆ10ï¼Œ20ï¼‰ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥ï¼Œæ›´æ–°ï¼Œåˆ é™¤idåœ¨ï¼ˆ10ï¼Œ20ï¼‰é—´çš„è®°å½•</p><p><strong>å¯¹äºä½¿ç”¨å”¯ä¸€ç´¢å¼•æ¥é”å®šå”¯ä¸€è¡Œçš„è¯­å¥ï¼Œä¸ä¼šäº§ç”Ÿé—´éš™é”ï¼Œè€Œæ˜¯ä½¿ç”¨è®°å½•é”ã€‚</strong> (This does not include the case that the search condition includes only some columns of a multiple-column unique index; in that case, gap locking does occur. è¿™å¥è¯æš‚æ—¶æ²¡æ˜ç™½)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM WHERE id &#x3D; 1 FOR UPDATE;</span><br></pre></td></tr></table></figure><p>å¦‚æœidæœªå»ºç«‹ç´¢å¼•æˆ–å…·æœ‰éå”¯ä¸€ç´¢å¼•ï¼Œåˆ™è¯¥è¯­å¥ä¼šäº§ç”Ÿé—´éš™é”ï¼Œé”å®šå‰é¢çš„é—´éš™ã€‚</p><h3 id="ä¸´é”®é”ï¼ˆNext-Key-Locksï¼‰">ä¸´é”®é”ï¼ˆNext-Key Locksï¼‰</h3><ul><li>å®šä¹‰<br>A next-key lock is a combination of a record lock on the index record and a gap lock on the gap before the index record.ï¼ˆä¸´é”®é”æ˜¯é”å®šç´¢å¼•çš„è®°å½•é”å’Œé”å®šè¯¥ç´¢å¼•ä¹‹å‰åŒºé—´çš„é—´éš™é”çš„ç»„åˆï¼‰</li></ul><p><strong>é»˜è®¤æƒ…å†µä¸‹ï¼ˆRRï¼‰ï¼ŒInnoDBä½¿ç”¨ä¸´é”®é”è¿›è¡Œæœç´¢å’Œç´¢å¼•æ‰«æã€‚</strong></p><p>å‡è®¾ç´¢å¼•è®°å½•ä¸º 10, 11, 13, 20</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(-âˆ, 10]</span><br><span class="line">(10, 11]</span><br><span class="line">(11, 13]</span><br><span class="line">(13, 20]</span><br><span class="line">(20, +âˆ)</span><br></pre></td></tr></table></figure><h3 id="æ’å…¥æ„å‘é”ï¼ˆInsert-Intention-Locksï¼‰">æ’å…¥æ„å‘é”ï¼ˆInsert Intention Locksï¼‰</h3><ul><li>å®šä¹‰<br>An insert intention lock is a type of gap lock set by INSERT operations prior to row insertion. ï¼ˆæ’å…¥æ„å‘é”æ—¶æ’å…¥è¡Œä¹‹å‰çš„æ’å…¥æ“ä½œè®¾ç½®çš„ä¸€ç§é—´éš™é”ï¼‰</li></ul><p>å¤šä¸ªäº‹åŠ¡ï¼Œåœ¨åŒä¸€ä¸ªç´¢å¼•ï¼ŒåŒä¸€ä¸ªèŒƒå›´åŒºé—´æ’å…¥è®°å½•æ—¶ï¼Œ<strong>å¦‚æœæ’å…¥çš„ä½ç½®ä¸å†²çªï¼Œä¸ä¼šé˜»å¡å½¼æ­¤ã€‚</strong></p><p>å‚è€ƒ<br><a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-locking.html#innodb-auto-inc-locks" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.6/en/innodb-locking.html#innodb-auto-inc-locks</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;InnoDB performs row-level locking in such a way that when it searches or scans a table index, it sets shared or exclusive locks on the in
      
    
    </summary>
    
    
    
      <category term="MySQL" scheme="https://zhucj94.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>InnoDBçš„é”ï¼ˆ2ï¼‰</title>
    <link href="https://zhucj94.github.io/article/be44ecbc.html"/>
    <id>https://zhucj94.github.io/article/be44ecbc.html</id>
    <published>2020-05-12T13:18:18.000Z</published>
    <updated>2020-07-24T06:18:36.157Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å…±äº«-æ’ä»–é”ï¼ˆShared-and-Exclusice-Locksï¼‰">å…±äº«/æ’ä»–é”ï¼ˆShared and Exclusice Locksï¼‰</h3><p><strong>è¡Œçº§é”</strong></p><ul><li><p>å®šä¹‰</p><ul><li><strong>äº‹åŠ¡</strong>æ‹¿åˆ°æŸä¸€è¡Œè®°å½•çš„å…±äº«Sé”ï¼Œæ‰å¯ä»¥è¯»å–ï¼ˆå½“å‰è¯»ï¼‰è¿™ä¸€è¡Œï¼›</li><li><strong>äº‹åŠ¡</strong>æ‹¿åˆ°æŸä¸€è¡Œè®°å½•çš„æ’ä»–Xé”ï¼Œæ‰å¯ä»¥ä¿®æ”¹æˆ–è€…åˆ é™¤è¿™ä¸€è¡Œï¼›</li></ul></li><li><p>åŠ é”æ–¹å¼</p><ul><li>å…±äº«é”ï¼ˆSï¼‰ï¼šSELECT â€¦ LOCK IN SHARE MODE</li><li>æ’ä»–é”ï¼ˆXï¼‰ï¼šSELECT â€¦ FOR UPDATE ï¼ˆ<strong>update/delete/insertè‡ªåŠ¨åŠ æ’ä»–é”</strong>ï¼‰</li></ul></li><li><p>äº’æ–¥å…³ç³»</p></li></ul><table><thead><tr><th style="text-align:center">-</th><th style="text-align:center">S</th><th style="text-align:center">X</th></tr></thead><tbody><tr><td style="text-align:center">S</td><td style="text-align:center">å…¼å®¹</td><td style="text-align:center">äº’æ–¥</td></tr><tr><td style="text-align:center">X</td><td style="text-align:center">äº’æ–¥</td><td style="text-align:center">äº’æ–¥</td></tr></tbody></table><h3 id="æ„å‘é”ï¼ˆIntention-Locksï¼‰">æ„å‘é”ï¼ˆIntention Locksï¼‰</h3><p><strong>ä¸ä¸è¡Œçº§é”å†²çªè¡¨çº§é”</strong></p><ul><li><p>åˆ†ç±»</p><ul><li>æ„å‘å…±äº«é”(intention shared lock, IS)ï¼Œå®ƒé¢„ç¤ºç€ï¼Œäº‹åŠ¡æœ‰æ„å‘å¯¹è¡¨ä¸­çš„æŸäº›è¡ŒåŠ å…±äº«Sé”ã€‚</li><li>æ„å‘æ’å®ƒé”(intention exclusive lock, IX)ï¼Œå®ƒé¢„ç¤ºç€ï¼Œäº‹åŠ¡æœ‰æ„å‘å¯¹è¡¨ä¸­çš„æŸäº›è¡ŒåŠ æ’å®ƒXé”ã€‚</li></ul></li><li><p>intention locking protocol</p><ul><li>äº‹åŠ¡è¦è·å¾—æŸäº›<strong>è¡Œ</strong>çš„Sé”ï¼Œå¿…é¡»å…ˆè·å¾—è¡¨çš„ISé”ã€‚</li><li>äº‹åŠ¡è¦è·å¾—æŸäº›<strong>è¡Œ</strong>çš„Xé”ï¼Œå¿…é¡»å…ˆè·å¾—è¡¨çš„IXé”ã€‚</li></ul></li><li><p>äº’æ–¥å…³ç³»ï¼ˆ<strong>ä¸‹è¡¨çš„S/Xé”æ˜¯è¡¨çº§çš„!!!</strong>ï¼‰</p></li></ul><table><thead><tr><th style="text-align:center">-</th><th style="text-align:center">X</th><th style="text-align:center">IX</th><th style="text-align:center">S</th><th style="text-align:center">IS</th></tr></thead><tbody><tr><td style="text-align:center">X</td><td style="text-align:center">äº’æ–¥</td><td style="text-align:center">äº’æ–¥</td><td style="text-align:center">äº’æ–¥</td><td style="text-align:center">äº’æ–¥</td></tr><tr><td style="text-align:center">IX</td><td style="text-align:center">äº’æ–¥</td><td style="text-align:center">å…¼å®¹</td><td style="text-align:center">äº’æ–¥</td><td style="text-align:center">å…¼å®¹</td></tr><tr><td style="text-align:center">S</td><td style="text-align:center">äº’æ–¥</td><td style="text-align:center">äº’æ–¥</td><td style="text-align:center">å…¼å®¹</td><td style="text-align:center">å…¼å®¹</td></tr><tr><td style="text-align:center">IS</td><td style="text-align:center">äº’æ–¥</td><td style="text-align:center">å…¼å®¹</td><td style="text-align:center">å…¼å®¹</td><td style="text-align:center">å…¼å®¹</td></tr></tbody></table><ul><li>åˆ¤æ–­å†²çªæ—¶çš„ä½œç”¨<br>æ— æ„å‘é” ï¼š<ul><li>åˆ¤æ–­è¡¨æ˜¯å¦è¢«å…¶ä»–äº‹åŠ¡åŠ è¡¨é”ã€‚</li><li>åˆ¤æ–­è¡¨ä¸­çš„æ¯ä¸€è¡Œæ˜¯å¦è¢«å…¶ä»–äº‹åŠ¡åŠ è¡Œé”ã€‚<br>æœ‰æ„å‘é” ï¼š</li><li>åˆ¤æ–­è¡¨æ˜¯å¦è¢«å…¶ä»–äº‹åŠ¡åŠ è¡¨é”ã€‚</li><li>åˆ¤æ–­è¡¨æ˜¯å¦è¢«å…¶ä»–äº‹åŠ¡åŠ æ„å‘é”ã€‚</li></ul></li></ul><p>å‚è€ƒ<br><a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-locking.html#innodb-auto-inc-locks" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.6/en/innodb-locking.html#innodb-auto-inc-locks</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;å…±äº«-æ’ä»–é”ï¼ˆShared-and-Exclusice-Locksï¼‰&quot;&gt;å…±äº«/æ’ä»–é”ï¼ˆShared and Exclusice Locksï¼‰&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;è¡Œçº§é”&lt;/strong&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;å®šä¹‰&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;stro
      
    
    </summary>
    
    
    
      <category term="MySQL" scheme="https://zhucj94.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>InnoDBçš„é”ï¼ˆ1ï¼‰è‡ªå¢é”ï¼ˆAUTO-INC Locksï¼‰</title>
    <link href="https://zhucj94.github.io/article/32458d66.html"/>
    <id>https://zhucj94.github.io/article/32458d66.html</id>
    <published>2020-05-10T13:27:21.000Z</published>
    <updated>2020-07-24T06:18:36.163Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡ä¸ä»‹ç»MySQLçš„è¯»è¡¨é”ï¼ˆLOCK TABLE table_name READï¼‰å’Œå†™è¡¨é”ï¼ˆLOCK TABLE table_name WRITE</strong></p><p>è‡ªå¢é”æ˜¯ä¸€ç§ç‰¹æ®Šçš„è¡¨çº§åˆ«é”ï¼ˆtable-level lockï¼‰ï¼Œä¸“é—¨é’ˆå¯¹äº‹åŠ¡æ’å…¥AUTO_INCREMENTç±»å‹çš„åˆ—ã€‚</p><h3 id="insertåˆ†ç±»">insertåˆ†ç±»</h3><ul><li><p>Simple inserts<br>Statements for which the number of rows to be inserted can be determined in advance (when the statement is initially processed). This includes single-row and multiple-row INSERT and REPLACE statements that do not have a nested subquery, but not INSERT â€¦ ON DUPLICATE KEY UPDATE.</p></li><li><p>Bulk inserts<br>Statements for which the number of rows to be inserted (and the number of required auto-increment values) is not known in advance.This includes INSERT â€¦ SELECT, REPLACE â€¦ SELECT, and LOAD DATA statements, but not plain INSERT. InnoDB will assign new values for the AUTO_INCREMENT column one at a time as each row is processed.</p></li><li><p>Mixed-mode inserts<br>These are â€œsimple insertâ€ statements that specify the auto-increment value for some (but not all) of the new rows. An example follows, where c1 is an AUTO_INCREMENT column of table t1:</p></li></ul><p>INSERT INTO t1 (c1,c2) VALUES (1,â€˜aâ€™), (NULL,â€˜bâ€™), (5,â€˜câ€™), (NULL,â€˜dâ€™);</p><p>Another type of â€œmixed-mode insertâ€ is INSERT â€¦ ON DUPLICATE KEY UPDATE, which in the worst case is in effect an INSERT followed by a UPDATE, where the allocated value for the AUTO_INCREMENT column may or may not be used during the update phase.</p><h3 id="é”æ¨¡å¼ï¼ˆå‚æ•°innodb-autoinc-lock-modeï¼‰">é”æ¨¡å¼ï¼ˆå‚æ•°innodb_autoinc_lock_modeï¼‰</h3><ul><li><p>innodb_autoinc_lock_mode = 0 ï¼ˆtraditionalï¼‰</p><ul><li>æ­¤æ¨¡å¼ä¸innodb_autoinc_lock_modeå­˜åœ¨å‰çš„è¡Œä¸ºç›¸åŒï¼Œå¯¹äºæ‰€æœ‰çš„â€˜INSERT-likeâ€™è¯­å¥ï¼Œéƒ½ä¼šä½¿ç”¨ç‰¹æ®Šçš„AUTO-INC table-level lockï¼Œä¿æŒåˆ°è¯­å¥ç»“æŸã€‚è¿™ç¡®ä¿äº†ä»»ä½•ç»™å®šè¯­å¥åˆ†é…çš„è‡ªåŠ¨å¢é‡å€¼æ˜¯è¿ç»­çš„ã€‚</li></ul></li><li><p>innodb_autoinc_lock_mode = 1 ï¼ˆconsecutiveï¼‰</p><ul><li>é»˜è®¤çš„æ¨¡å¼</li><li>å‘ç”ŸSimple insertsæ—¶ï¼Œåœ¨åˆ†é…AUTO_INCREMENTæœŸé—´ï¼Œä¼šä½¿ç”¨è½»é‡çº§çš„é”ï¼Œè·å–åˆ°AUTO_INCREMENTåå°±é‡Šæ”¾é”ï¼Œå¦‚æœå…¶ä»–äº‹åŠ¡æŒæœ‰AUTO-INC table-level lockï¼Œè·å–è½»é‡çº§é”ä¹Ÿä¼šç­‰å¾…ã€‚</li><li>å‘ç”ŸBulk insertsæ—¶ï¼Œä¼šä½¿ç”¨ç‰¹æ®Šçš„AUTO-INC table-level lockï¼Œä¿æŒåˆ°è¯­å¥ç»“æŸã€‚</li><li>å‘ç”ŸMixed-mode insertsæ—¶ï¼Œä¸€äº›è¡ŒæŒ‡å®šäº†AUTO_INCREMENTï¼Œå°†åˆ†é…æ¯”è¦æ’å…¥çš„è¡Œæ•°æ›´å¤šçš„AUTO_INCREMENTï¼Œæ‰€æœ‰AUTO_INCREMENTæ˜¯è¿ç»­ç”Ÿæˆçš„ï¼Œå¤šä½™çš„ä¸¢å¤±ã€‚</li></ul></li><li><p>innodb_autoinc_lock_mode = 2 ï¼ˆinterleavedï¼‰</p><ul><li>å¯¹äºæ‰€æœ‰çš„â€˜INSERT-likeâ€™è¯­å¥ä¸åŠ é”</li><li>å¯¹äºBulk insertsï¼ŒAUTO_INCREMENTå¯èƒ½ä¸è¿ç»­</li><li>binlogä¸ºSBRæ¨¡å¼æ—¶ï¼Œæ•°æ®å¤åˆ¶æˆ–æ¢å¤ä¸å®‰å…¨</li></ul></li></ul><p>å‚è€ƒ<br><a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-locking.html#innodb-auto-inc-locks" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.6/en/innodb-locking.html#innodb-auto-inc-locks</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸ä»‹ç»MySQLçš„è¯»è¡¨é”ï¼ˆLOCK TABLE table_name READï¼‰å’Œå†™è¡¨é”ï¼ˆLOCK TABLE table_name WRITE&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;è‡ªå¢é”æ˜¯ä¸€ç§ç‰¹æ®Šçš„è¡¨çº§åˆ«é”ï¼ˆtable-level lockï¼‰ï¼Œä¸“é—¨é’ˆå¯¹äº‹åŠ¡æ’
      
    
    </summary>
    
    
    
      <category term="MySQL" scheme="https://zhucj94.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>InnoDBçš„MVCCï¼ˆMulti Versioning Concurrency Controlï¼‰</title>
    <link href="https://zhucj94.github.io/article/b93dd38a.html"/>
    <id>https://zhucj94.github.io/article/b93dd38a.html</id>
    <published>2020-05-05T12:25:29.000Z</published>
    <updated>2020-07-24T06:18:36.144Z</updated>
    
    <content type="html"><![CDATA[<p><strong>MVCCä¸»è¦æ˜¯ä¸ºäº†æé«˜æ•°æ®åº“å¹¶å‘æ€§èƒ½ï¼Œç”¨æ›´å¥½çš„æ–¹å¼å»å¤„ç†è¯»-å†™å†²çª</strong>ï¼Œåšåˆ°å³ä½¿æœ‰è¯»å†™å†²çªæ—¶ï¼Œä¹Ÿèƒ½åšåˆ°ä¸åŠ é”ï¼Œéé˜»å¡å¹¶å‘è¯»ã€‚ï¼ˆè¯»æŒ‡å¿«ç…§è¯»ï¼‰</p><h3 id="å®šä¹‰">å®šä¹‰</h3><p>InnoDB is a multi-versioned storage engine: it keeps information about old versions of changed rows, to support transactional features such as concurrency and rollback.This information is stored in the tablespace in a data structure called a rollback segmentï¼ˆInndDBæ˜¯å¤šç‰ˆæœ¬çš„å­˜å‚¨å¼•æ“ï¼Œå®ƒä¿ç•™å·²æ›´æ”¹è¡Œæ—§ç‰ˆæœ¬ä¿¡æ¯ï¼Œä»¥æ”¯æŒäº‹åŠ¡çš„å¹¶å‘å’Œå›æ»šï¼Œè¿™äº›ä¿¡æ¯ä¿å­˜åœ¨è¢«ç§°ä¸ºå›æ»šæ®µçš„è¡¨ç©ºé—´æ•°æ®ç»“æ„ä¸­ï¼‰</p><h3 id="å®ç°ç»†èŠ‚">å®ç°ç»†èŠ‚</h3><h4 id="éšè—å­—æ®µ">éšè—å­—æ®µ</h4><ul><li>DB_TRX_IDï¼š6å­—èŠ‚ï¼Œè®°å½•æ¯ä¸€è¡Œæœ€è¿‘ä¸€æ¬¡ä¿®æ”¹å®ƒçš„äº‹åŠ¡IDã€‚</li><li>DB_ROLL_PTRï¼š7å­—èŠ‚ï¼Œè®°å½•æŒ‡å‘å›æ»šæ®µUNDO LOGçš„æŒ‡é’ˆã€‚</li><li>DB_ROW_IDï¼š6å­—èŠ‚ï¼Œå•è°ƒé€’å¢çš„è¡ŒIDã€‚</li></ul><h4 id="undo-log">undo log</h4><ul><li><p>åˆ†ç±»</p><ul><li>insert undo logï¼šäº‹åŠ¡åœ¨insertæ“ä½œæ—¶äº§ç”Ÿçš„undo logï¼Œåªç”¨äºäº‹åŠ¡å›æ»šï¼Œåœ¨äº‹åŠ¡æäº¤æ—¶ç«‹å³è¢«ä¸¢å¼ƒã€‚</li><li>update undo logï¼šäº‹åŠ¡åœ¨updateæˆ–deleteæ“ä½œæ—¶äº§ç”Ÿçš„undo logï¼›åœ¨äº‹åŠ¡å›å½’æ—¶éœ€è¦ï¼Œ<strong>åœ¨å¿«ç…§è¯»æ—¶ä¹Ÿéœ€è¦</strong>ï¼Œä¸ä¼šéšä¾¿åˆ é™¤ï¼Œåªæœ‰åœ¨å¿«é€Ÿè¯»æˆ–äº‹åŠ¡å›æ»šä¸æ¶‰åŠè¯¥æ—¥å¿—æ—¶ï¼Œå¯¹åº”çš„æ—¥å¿—æ‰ä¼šè¢«purgeçº¿ç¨‹ç»Ÿä¸€æ¸…é™¤ã€‚</li></ul></li><li><p>æ‰§è¡Œæµç¨‹</p><ul><li>å‡è®¾personè¡¨æœ‰å¦‚ä¸‹æ•°æ®</li></ul><table><thead><tr><th style="text-align:center">name</th><th style="text-align:center">age</th><th style="text-align:center">DB_ROW_ID</th><th style="text-align:center">DB_TRX_ID</th><th style="text-align:center">DB_ROLL_PTR</th></tr></thead><tbody><tr><td style="text-align:center">jerry</td><td style="text-align:center">24</td><td style="text-align:center">1</td><td style="text-align:center">null</td><td style="text-align:center">null</td></tr></tbody></table><ul><li><p>äº‹åŠ¡1å°†nameä¿®æ”¹ä¸ºtom</p><ul><li>äº‹åŠ¡1è·å–å¹¶å¯¹è¯¥è¡ŒåŠ æ’ä»–é”</li><li>å°†è¡Œæ•°æ®æ‹·è´åˆ°undo logä¸­</li><li>å°†nameæ”¹ä¸ºtomï¼Œå¹¶ç»DB_TRX_IDæ”¹ä¸ºäº‹åŠ¡1çš„ID,å›æ»šæŒ‡é’ˆæŒ‡å‘ä¹‹å‰æ‹·è´åˆ°undo logçš„è¡Œæ•°æ®</li><li>æäº¤äº‹åŠ¡ï¼Œé‡Šæ”¾æ’ä»–é”<br><img src="/images/InnoDB/update-undo-log-4-mvcc1.png" alt="avatar"></li></ul></li><li><p>äº‹åŠ¡2å°†ageæ”¹ä¸º30</p><ul><li>äº‹åŠ¡2è·å–å¹¶å¯¹è¯¥è¡ŒåŠ æ’ä»–é”</li><li>å°†è¡Œæ•°æ®æ‹·è´åˆ°undo logä¸­ï¼Œå‘ç°è¯¥è¡Œè®°å½•å·²æœ‰undo logï¼Œå°†æœ¬æ¬¡çš„æ‹·è´ä½œä¸ºé“¾è¡¨çš„è¡¨å¤´ã€‚</li><li>å°†ageæ”¹ä¸º30ï¼Œå¹¶ç»DB_TRX_IDæ”¹ä¸ºäº‹åŠ¡2çš„ID,å›æ»šæŒ‡é’ˆæŒ‡å‘ä¹‹å‰æ‹·è´åˆ°undo logçš„è¡Œæ•°æ®</li><li>æäº¤äº‹åŠ¡ï¼Œé‡Šæ”¾æ’ä»–é”<br><img src="/images/InnoDB/update-undo-log-4-mvcc2.png" alt="avatar"></li></ul></li></ul></li></ul><p>MVCCä½¿ç”¨çš„æ˜¯ <strong>update undo log ï¼Œundo logå®é™…ä¸Šå°±æ˜¯å­˜åœ¨rollback segmentä¸­æ—§è®°å½•é“¾</strong></p><h4 id="Read-View">Read View</h4><p><strong>Read View æ˜¯ç”¨æ¥åšå¯è§æ€§åˆ¤æ–­çš„</strong>ï¼Œå½“äº‹åŠ¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ï¼Œä¼šç”Ÿæˆæ•°æ®åº“å½“å‰çš„ä¸€ä¸ªå¿«ç…§ï¼Œè®°å½•å¹¶ç»´æŠ¤ç³»ç»Ÿå½“å‰æ´»è·ƒäº‹åŠ¡çš„IDã€‚</p><ul><li>ç®—æ³•ï¼ˆç®€åŒ–ç‰ˆï¼‰</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id_list : ç”¨æ¥ç»´æŠ¤Read Viewç”Ÿæˆæ—¶ç³»ç»Ÿæ´»è·ƒçš„äº‹åŠ¡IDï¼ˆåˆ†é…çš„äº‹åŠ¡IDæ˜¯é€’å¢çš„ï¼‰</span><br><span class="line">up_limit_idï¼šid_listä¸­æœ€å°çš„äº‹åŠ¡ID</span><br><span class="line">low_limit_idï¼šReadViewç”Ÿæˆæ—¶åˆ»ç³»ç»Ÿå°šæœªåˆ†é…çš„ä¸‹ä¸€ä¸ªäº‹åŠ¡IDï¼Œ**å³å·²å‡ºç°è¿‡æœ€å¤§çš„äº‹åŠ¡IDçš„+1**</span><br></pre></td></tr></table></figure><pre><code>+ æ¯”è¾ƒDB_TRX_IDä¸up_limit_idï¼Œå¦‚æœå°äºï¼Œåˆ™å½“å‰äº‹åŠ¡èƒ½çœ‹åˆ°DB_TRX_IDæ‰€åœ¨çš„è¡Œæ•°æ®ï¼Œå¦åˆ™è¿›å…¥ä¸‹ä¸€æ­¥ã€‚+ æ¯”è¾ƒDB_TRX_IDä¸low_limit_idï¼Œå¦‚æœå¤§äºï¼Œåˆ™å½“å‰äº‹åŠ¡ä¸èƒ½çœ‹åˆ°DB_TRX_IDæ‰€åœ¨çš„è¡Œæ•°æ®ï¼Œå¦åˆ™è¿›å…¥ä¸‹ä¸€æ­¥ã€‚+ åˆ¤æ–­DB_TRX_IDæ˜¯å¦åœ¨id_listä¸­ï¼Œå¦‚æœåœ¨ï¼Œåˆ™å½“å‰äº‹åŠ¡ä¸èƒ½çœ‹åˆ°DB_TRX_IDæ‰€åœ¨çš„è¡Œæ•°æ®ï¼Œå¦åˆ™èƒ½çœ‹åˆ°ã€‚</code></pre><ul><li><p>æµç¨‹<br>å°†å½“å‰æ•°æ®çš„DB_TRX_IDå–å‡ºï¼Œä¸Read Viewç»´æŠ¤æ´»è·ƒäº‹åŠ¡IDè¿›è¡Œæ¯”è¾ƒï¼ˆé€šè¿‡ä¸Šé¢çš„ç®—æ³•ï¼‰ï¼Œå¦‚æœå¦‚æœä¸ç¬¦åˆå¯è§æ€§ï¼Œå°±é€šè¿‡DB_ROLL_PTRå–undo logä¸­çš„è®°å½•ï¼Œå°†å®ƒçš„DB_TRX_IDä¸Read Viewç»´æŠ¤æ´»è·ƒäº‹åŠ¡IDè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœè¿˜ä¸ç¬¦åˆï¼Œå°±å–é“¾è¡¨çš„ä¸‹ä¸€æ¡è®°å½•ï¼Œç›´è‡³æ»¡è¶³å¯è§æ€§ï¼Œé‚£ä¹ˆè¿™ä¸ªDB_TRX_IDæ‰€åœ¨çš„æ—§çºªå½•å°±æ˜¯å½“å‰äº‹åŠ¡èƒ½çœ‹è§çš„è®°å½•ã€‚</p></li><li><p>RRä¸RCä¸‹Read Viewç”Ÿæˆæ—¶æœº<br><strong>RCéš”ç¦»çº§åˆ«ä¸‹ï¼Œæ¯ä¸ªå¿«ç…§è¯»éƒ½ä¼šç”Ÿæˆå¹¶è·å–æœ€æ–°çš„Read Viewï¼›è€Œåœ¨RRéš”ç¦»çº§åˆ«ä¸‹ï¼ŒåŒä¸€ä¸ªäº‹åŠ¡ä¸­çš„ç¬¬ä¸€ä¸ªå¿«ç…§è¯»æ‰ä¼šåˆ›å»ºRead View, ä¹‹åçš„å¿«ç…§è¯»è·å–çš„éƒ½æ˜¯åŒä¸€ä¸ªRead Viewã€‚</strong><br>è¿™å°±æ˜¯RRçš„å¿«ç…§è¯»èƒ½é˜²æ­¢å¹»è¯»ï¼Œè€ŒRCä¸èƒ½çš„åŸå› ã€‚</p></li></ul><p>å‚è€ƒ<br><a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-multi-versioning.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.6/en/innodb-multi-versioning.html</a></p><p><a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-undo-logs.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.6/en/innodb-undo-logs.html</a></p><p><a href="https://blog.csdn.net/SnailMann/article/details/94724197" target="_blank" rel="noopener">https://blog.csdn.net/SnailMann/article/details/94724197</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;MVCCä¸»è¦æ˜¯ä¸ºäº†æé«˜æ•°æ®åº“å¹¶å‘æ€§èƒ½ï¼Œç”¨æ›´å¥½çš„æ–¹å¼å»å¤„ç†è¯»-å†™å†²çª&lt;/strong&gt;ï¼Œåšåˆ°å³ä½¿æœ‰è¯»å†™å†²çªæ—¶ï¼Œä¹Ÿèƒ½åšåˆ°ä¸åŠ é”ï¼Œéé˜»å¡å¹¶å‘è¯»ã€‚ï¼ˆè¯»æŒ‡å¿«ç…§è¯»ï¼‰&lt;/p&gt;&lt;h3 id=&quot;å®šä¹‰&quot;&gt;å®šä¹‰&lt;/h3&gt;&lt;p&gt;InnoDB is a multi-versioned
      
    
    </summary>
    
    
    
      <category term="MySQL" scheme="https://zhucj94.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>InnoDBå¿«ç…§è¯»ä¸å½“å‰è¯»</title>
    <link href="https://zhucj94.github.io/article/cdee20fb.html"/>
    <id>https://zhucj94.github.io/article/cdee20fb.html</id>
    <published>2020-05-04T13:51:31.000Z</published>
    <updated>2020-07-24T06:18:36.136Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å¿«ç…§è¯»ï¼ˆConsistent-Nonlocking-Readsï¼‰">å¿«ç…§è¯»ï¼ˆConsistent Nonlocking Readsï¼‰</h3><p>A consistent read means that InnoDB uses multi-versioning to present to a query a snapshot of the database at a point in time.ï¼ˆå¿«ç…§è¯»æ˜¯InnoDBä½¿ç”¨å¤šç‰ˆæœ¬æ¥æŸ¥è¯¢æŸä¸ªæ—¶é—´ç‚¹çš„å¿«ç…§ï¼‰</p><p>Consistent read is the default mode in which InnoDB processes SELECT statements in READ COMMITTED and REPEATABLE READ isolation levels. A consistent read does not set any locks on the tables it accesses, and therefore other sessions are free to modify those tables at the same time a consistent read is being performed on the table.ï¼ˆå¿«ç…§è¯»æ˜¯RRå’ŒRCä¸‹å¤„ç†SELECTçš„é»˜è®¤æ¨¡å¼ï¼Œå¿«ç…§è¯»ä¸åœ¨è®¿é—®çš„è¡¨ä¸Šè®¾ç½®ä»»ä½•é”ï¼Œå› æ­¤å…¶ä»–ä¼šè¯å¯ä»¥è‡ªç”±çš„ä¿®æ”¹è¿™äº›è¡¨ã€‚ï¼‰</p><h3 id="å½“å‰è¯»ï¼ˆLocking-Readsï¼‰">å½“å‰è¯»ï¼ˆLocking Readsï¼‰</h3><p>If you query data and then insert or update related data within the same transaction, the regular SELECT statement does not give enough protection. Other transactions can update or delete the same rows you just queried. ï¼ˆåœ¨åŒä¸€äº‹åŠ¡ä¸­æŸ¥è¯¢æ•°æ®ï¼Œç„¶åæ›´æ–°æˆ–ä¿®æ”¹ç›¸å…³æ•°æ®ï¼Œå¿«ç…§è¯»ä¸èƒ½æä¾›è¶³å¤Ÿä¿æŠ¤ï¼Œå…¶ä»–äº‹åŠ¡å¯ä»¥ä¿®æ”¹æˆ–åˆ é™¤åˆšæŸ¥è¯¢çš„è¡Œã€‚ï¼‰</p><p>InnoDBæä¾›äº† **SELECT â€¦ LOCK IN SHARE MODEï¼ˆå…±äº«é”ï¼‰**å’Œ **SELECT â€¦ FOR UPDATEï¼ˆæ’ä»–é”ï¼‰**æä¾›é¢å¤–çš„å®‰å…¨ã€‚</p><p>å‚è€ƒï¼š<br><a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-consistent-read.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.6/en/innodb-consistent-read.html</a></p><p><a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-locking-reads.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.6/en/innodb-locking-reads.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;å¿«ç…§è¯»ï¼ˆConsistent-Nonlocking-Readsï¼‰&quot;&gt;å¿«ç…§è¯»ï¼ˆConsistent Nonlocking Readsï¼‰&lt;/h3&gt;&lt;p&gt;A consistent read means that InnoDB uses multi-versioning 
      
    
    </summary>
    
    
    
      <category term="MySQL" scheme="https://zhucj94.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>äº‹åŠ¡</title>
    <link href="https://zhucj94.github.io/article/93ac284c.html"/>
    <id>https://zhucj94.github.io/article/93ac284c.html</id>
    <published>2020-05-02T12:52:14.000Z</published>
    <updated>2020-07-24T06:18:36.222Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ACID">ACID</h3><ul><li>åŸå­æ€§(Atomicity)<br>äº‹åŠ¡æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œå…¶å¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚</li><li>ä¸€è‡´æ€§(Consistency)<br>äº‹åŠ¡æ‰§è¡Œç»“æŸåï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸæ²¡æœ‰è¢«ç ´åï¼Œäº‹åŠ¡æ‰§è¡Œçš„å‰åéƒ½æ˜¯åˆæ³•çš„æ•°æ®çŠ¶æ€ã€‚æ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸåŒ…æ‹¬ä½†ä¸é™äºï¼šå®ä½“å®Œæ•´æ€§ï¼ˆå¦‚è¡Œçš„ä¸»é”®å­˜åœ¨ä¸”å”¯ä¸€ï¼‰ã€åˆ—å®Œæ•´æ€§ï¼ˆå¦‚å­—æ®µçš„ç±»å‹ã€å¤§å°ã€é•¿åº¦è¦ç¬¦åˆè¦æ±‚ï¼‰ã€å¤–é”®çº¦æŸã€ç”¨æˆ·è‡ªå®šä¹‰å®Œæ•´æ€§ï¼ˆå¦‚è½¬è´¦å‰åï¼Œä¸¤ä¸ªè´¦æˆ·ä½™é¢çš„å’Œåº”è¯¥ä¸å˜ï¼‰ã€‚</li><li>éš”ç¦»æ€§(Isolation)<br>äº‹åŠ¡å†…éƒ¨çš„æ“ä½œä¸å…¶ä»–äº‹åŠ¡æ˜¯éš”ç¦»çš„ï¼Œå¹¶å‘æ‰§è¡Œçš„å„ä¸ªäº‹åŠ¡ä¹‹é—´ä¸èƒ½äº’ç›¸å¹²æ‰°ã€‚</li><li>æŒä¹…æ€§(Durability)<br>äº‹åŠ¡å®Œæˆåï¼Œå®ƒå¯¹äºæ•°æ®çš„ä¿®æ”¹æ˜¯æ°¸ä¹…æ€§çš„ï¼Œå…¶åçš„å…¶ä»–æ“ä½œæˆ–æ•…éšœéƒ½ä¸åº”è¯¥é€ æˆå½±å“ã€‚</li></ul><h3 id="å¹¶å‘äº‹åŠ¡é€ æˆçš„å½±å“">å¹¶å‘äº‹åŠ¡é€ æˆçš„å½±å“</h3><ul><li><p>è„è¯»(Dirty Reads)<br>äº‹åŠ¡Aè¯»å–åˆ°äº†äº‹åŠ¡Bæœªæäº¤çš„å·²ä¿®æ”¹æ•°æ®ï¼Œå¹¶æ“ä½œäº†è¿™äº›æ•°æ®ï¼Œæ­¤æ—¶äº‹åŠ¡Bå›æ»šï¼ŒAä¾æ®è„æ•°æ®åšçš„æ“ä½œå¯èƒ½ä¸æ­£ç¡®ï¼Œä¸ç¬¦åˆä¸€è‡´æ€§ã€‚ï¼ˆä¾‹å¦‚ï¼Œb=3ï¼ŒBäº‹åŠ¡å°†bæ”¹ä¸º4æœªæäº¤ï¼ŒAäº‹åŠ¡è¯»å–åˆ°äº†ï¼Œæ‰§è¡Œa=b+5ï¼Œæ­¤æ—¶Bå›æ»šï¼‰</p></li><li><p>ä¸å¯é‡å¤è¯»(Non-Repeatable Reads)<br>äº‹åŠ¡Aè¯»å–åˆ°äº†äº‹åŠ¡Bå·²æäº¤çš„ä¿®æ”¹æ•°æ®ï¼ˆupdateï¼Œdeleteï¼‰ï¼Œä¸ç¬¦åˆéš”ç¦»æ€§ã€‚</p></li><li><p>å¹»è¯»(Phantom Reads)<br>äº‹åŠ¡Aè¯»å–åˆ°äº†äº‹åŠ¡Bå·²æäº¤çš„æ–°å¢æ•°æ®ï¼Œä¸ç¬¦åˆéš”ç¦»æ€§ã€‚</p></li></ul><h3 id="éš”ç¦»çº§åˆ«">éš”ç¦»çº§åˆ«</h3><table><thead><tr><th style="text-align:center">éš”ç¦»çº§åˆ«</th><th style="text-align:center">è¯»æ•°æ®ä¸€è‡´æ€§</th><th style="text-align:center">è„è¯»</th><th style="text-align:center">ä¸å¯é‡å¤è¯»</th><th style="text-align:center">å¹»è¯»</th></tr></thead><tbody><tr><td style="text-align:center">è¯»æœªæäº¤(Read uncommitted)</td><td style="text-align:center">æœ€ä½çº§åˆ«ï¼Œåªèƒ½ä¿è¯ä¸è¯»å–ç‰©ç†ä¸ŠæŸåçš„æ•°æ®</td><td style="text-align:center">âˆš</td><td style="text-align:center">âˆš</td><td style="text-align:center">âˆš</td></tr><tr><td style="text-align:center">è¯»å·²æäº¤(Read committed)</td><td style="text-align:center">è¯­å¥çº§</td><td style="text-align:center">Ã—</td><td style="text-align:center">âˆš</td><td style="text-align:center">âˆš</td></tr><tr><td style="text-align:center">å¯é‡å¤è¯»(Repeatable read)</td><td style="text-align:center">äº‹åŠ¡çº§</td><td style="text-align:center">Ã—</td><td style="text-align:center">Ã—</td><td style="text-align:center">âˆš</td></tr><tr><td style="text-align:center">å¯åºåˆ—åŒ–(Serializable)</td><td style="text-align:center">äº‹åŠ¡çº§</td><td style="text-align:center">Ã—</td><td style="text-align:center">Ã—</td><td style="text-align:center">Ã—</td></tr></tbody></table><p>æ³¨ï¼šä¸Šè¡¨åªæ˜¯é€šå¸¸æƒ…å†µï¼Œ<strong>InnoDB Repeatable readï¼Œé€šè¿‡MVCCè§£å†³æ™®é€šè¯»çš„å¹»è¯»ï¼Œé€šè¿‡é—´éš™é”(Gap Locks)ï¼Œä¸´é”®é”(Next-Key Locks)è§£å†³ <em><strong>å½“å‰è¯»</strong></em> å¹»å½±è¯»é—®é¢˜</strong></p><h3 id="è‡ªåŠ¨æäº¤">è‡ªåŠ¨æäº¤</h3><p>MySQLé»˜è®¤é‡‡ç”¨è‡ªåŠ¨æäº¤æ¨¡å¼ã€‚å³å¦‚æœä¸æ˜¯æ˜¾ç¤ºåœ°å¼€å§‹ä¸€ä¸ªäº‹åŠ¡ï¼Œåˆ™æ¯ä¸ªæŸ¥è¯¢éƒ½è¢«å½“åšä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œæäº¤æ“ä½œã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ACID&quot;&gt;ACID&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;åŸå­æ€§(Atomicity)&lt;br&gt;äº‹åŠ¡æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œå…¶å¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚&lt;/li&gt;&lt;li&gt;ä¸€è‡´æ€§(Consistency)&lt;br&gt;äº‹åŠ¡æ‰§è¡Œç»“æŸåï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸæ²¡æœ‰è¢«ç ´åï¼Œäº‹åŠ¡æ‰§è¡Œçš„å‰åéƒ½
      
    
    </summary>
    
    
    
      <category term="MySQL" scheme="https://zhucj94.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Oauth2.0</title>
    <link href="https://zhucj94.github.io/article/1b404596.html"/>
    <id>https://zhucj94.github.io/article/1b404596.html</id>
    <published>2020-04-30T08:48:37.000Z</published>
    <updated>2020-07-24T06:18:36.215Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åˆå¯¹æ¥å¾®ä¿¡ï¼Œå®ƒå¯¹å¤–å¼€æ”¾æ•°æ®çš„åè®®å°±æ˜¯Oauthï¼ŒæŠŠé˜®ä¸€å³°å¤§ç¥çš„å‡ ç¯‡æ–‡ç« æ‘˜å–å‡ æ®µï¼ŒåŠ æ·±å¯¹Oauthçš„ç†è§£ã€‚</p><p>Oauthï¼ˆOpen Authorizationï¼‰æ˜¯ä¸€ç§æˆæƒæœºåˆ¶ï¼Œæ ¸å¿ƒæ˜¯é€šè¿‡é¢å‘ä»¤ç‰Œç»™ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œä½¿å…¶å¯ä»¥æºå¸¦ä»¤ç‰Œè®¿é—®æ•°æ®ã€‚</p><h3 id="ä»¤ç‰Œä¸å¯†ç çš„å·®å¼‚">ä»¤ç‰Œä¸å¯†ç çš„å·®å¼‚</h3><ul><li>ä»¤ç‰Œæ˜¯çŸ­æœŸçš„ï¼Œ<strong>åˆ°æœŸåä¼šå¤±æ•ˆ</strong>ï¼Œå¯†ç ä¸€èˆ¬æ˜¯é•¿æœŸçš„ï¼Œç”¨æˆ·ä¸ä¸»åŠ¨ä¿®æ”¹ï¼Œä¸ä¼šæ”¹å˜ã€‚</li><li>ä»¤ç‰Œå¯è¢«é¢å‘è€…ä¸»åŠ¨æ’¤é”€ï¼Œè€Œå¯†ç ä¸€èˆ¬ä¸å¯ç”±ä»–äººæ§åˆ¶ã€‚</li><li>ä»¤ç‰Œçš„æƒé™èŒƒå›´ä¸€èˆ¬æ¯”å¯†ç å°ã€‚</li></ul><a id="more"></a><h3 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h3><ul><li>Third-party applicationï¼šç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºï¼Œä¾‹å¦‚å¾®ä¿¡ç½‘ç«™åº”ç”¨ã€‚</li><li>HTTP serviceï¼šHTTPæœåŠ¡æä¾›å•†ï¼Œä¾‹å¦‚å¾®ä¿¡ã€‚</li><li>Resource Ownerï¼šèµ„æºæ‰€æœ‰è€…ï¼Œä¾‹å¦‚å¾®ä¿¡ç”¨æˆ·ã€‚</li><li>User Agentï¼šç”¨æˆ·ä»£ç†ï¼Œæµè§ˆå™¨ã€‚</li><li>Authorization serverï¼šè®¤è¯æœåŠ¡å™¨ï¼Œå³æœåŠ¡æä¾›å•†ä¸“é—¨ç”¨æ¥å¤„ç†è®¤è¯çš„æœåŠ¡å™¨ã€‚</li><li>Resource serverï¼šèµ„æºæœåŠ¡å™¨ï¼Œå³æœåŠ¡æä¾›å•†å­˜æ”¾ç”¨æˆ·ç”Ÿæˆçš„èµ„æºçš„æœåŠ¡å™¨ã€‚å®ƒä¸è®¤è¯æœåŠ¡å™¨ï¼Œå¯ä»¥æ˜¯åŒä¸€å°æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸åŒçš„æœåŠ¡å™¨ã€‚</li></ul><h3 id="4ç§æˆæƒæ–¹å¼">4ç§æˆæƒæ–¹å¼</h3><ul><li><p>æˆæƒç æ¨¡å¼ï¼ˆauthorization codeï¼‰</p><p>æœ€å®‰å…¨çš„ä¸€ç§æ–¹å¼ï¼Œé€‚ç”¨äºæœ‰åç«¯çš„webåº”ç”¨</p><ol><li>èµ„æºæ‰€æœ‰è€…è®¿é—®ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œåè€…å°†å‰è€…å¯¼å‘è®¤è¯æœåŠ¡å™¨ã€‚</li><li>èµ„æºæ‰€æœ‰è€…é€‰æ‹©æ˜¯å¦ç»™äºˆç¬¬ä¸‰æ–¹åº”ç”¨æˆæƒã€‚</li><li>å‡è®¾èµ„æºæ‰€æœ‰è€…ç»™äºˆæˆæƒï¼Œè®¤è¯æœåŠ¡å™¨å°†èµ„æºæ‰€æœ‰è€…å¯¼å‘ç¬¬ä¸‰æ–¹åº”ç”¨äº‹å…ˆæŒ‡å®šçš„&quot;é‡å®šå‘URI&quot;ï¼ŒåŒæ—¶é™„ä¸Šä¸€ä¸ªæˆæƒç ã€‚</li><li>ç¬¬ä¸‰æ–¹åº”ç”¨æ”¶åˆ°æˆæƒç ï¼Œå‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œã€‚è¿™ä¸€æ­¥æ˜¯åœ¨ç¬¬ä¸‰æ–¹åº”ç”¨çš„åå°çš„æœåŠ¡å™¨ä¸Šå®Œæˆçš„ï¼Œå¯¹èµ„æºæ‰€æœ‰è€…ä¸å¯è§ã€‚</li><li>è®¤è¯æœåŠ¡å™¨æ ¸å¯¹äº†æˆæƒç å’Œé‡å®šå‘URIï¼Œç¡®è®¤æ— è¯¯åï¼Œå‘ç¬¬ä¸‰æ–¹åº”ç”¨å‘é€è®¿é—®ä»¤ç‰Œï¼ˆaccess tokenï¼‰å’Œæ›´æ–°ä»¤ç‰Œï¼ˆrefresh tokenï¼‰ã€‚</li></ol></li><li><p>éšè—ï¼ˆç®€åŒ–ï¼‰æ¨¡å¼ï¼ˆimplicitï¼‰</p><p>é€‚ç”¨äºçº¯å‰ç«¯åº”ç”¨</p><ol><li>å®¢æˆ·ç«¯å°†ç”¨æˆ·å¯¼å‘è®¤è¯æœåŠ¡å™¨ã€‚</li><li>ç”¨æˆ·å†³å®šæ˜¯å¦ç»™äºå®¢æˆ·ç«¯æˆæƒã€‚</li><li>å‡è®¾ç”¨æˆ·ç»™äºˆæˆæƒï¼Œè®¤è¯æœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯æŒ‡å®šçš„&quot;é‡å®šå‘URI&quot;ï¼Œå¹¶å¸¦ä¸Šè®¿é—®ä»¤ç‰Œï¼Œtokençš„ä½ç½®æ˜¯urlé”šç‚¹</li></ol></li><li><p>å¯†ç æ¨¡å¼ï¼ˆresource owner password credentialsï¼‰</p><p>é€‚ç”¨äºé«˜åº¦ä¿¡ä»»çš„åº”ç”¨</p><ol><li>èµ„æºæ‹¥æœ‰è€…å‘ç¬¬ä¸‰æ–¹åº”ç”¨æä¾›ç”¨æˆ·åå’Œå¯†ç ã€‚</li><li>ç¬¬ä¸‰æ–¹åº”ç”¨å°†ç”¨æˆ·åå’Œå¯†ç å‘ç»™è®¤è¯æœåŠ¡å™¨ï¼Œå‘åè€…è¯·æ±‚ä»¤ç‰Œã€‚</li><li>è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œã€‚</li></ol></li><li><p>å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆclient credentialsï¼‰</p><p>é€‚ç”¨äºæ²¡æœ‰å‰ç«¯çš„åº”ç”¨</p><ol><li>ç¬¬ä¸‰æ–¹åº”ç”¨å‘è®¤è¯æœåŠ¡å™¨è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¹¶è¦æ±‚ä¸€ä¸ªè®¿é—®ä»¤ç‰Œã€‚</li><li>è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œç›´æ¥è¿”å›è®¿é—®ä»¤ç‰Œã€‚</li></ol></li></ul><p>æœ¬æ–‡ç”±é˜®ä¸€å³°3ç¯‡oauth2.0æ–‡ç« æ€»ç»“è€Œæ¥ã€‚</p><p><a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html</a></p><p><a href="http://www.ruanyifeng.com/blog/2019/04/oauth-grant-types.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2019/04/oauth-grant-types.html</a></p><p><a href="http://www.ruanyifeng.com/blog/2019/04/oauth_design.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2019/04/oauth_design.html</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘åˆå¯¹æ¥å¾®ä¿¡ï¼Œå®ƒå¯¹å¤–å¼€æ”¾æ•°æ®çš„åè®®å°±æ˜¯Oauthï¼ŒæŠŠé˜®ä¸€å³°å¤§ç¥çš„å‡ ç¯‡æ–‡ç« æ‘˜å–å‡ æ®µï¼ŒåŠ æ·±å¯¹Oauthçš„ç†è§£ã€‚&lt;/p&gt;&lt;p&gt;Oauthï¼ˆOpen Authorizationï¼‰æ˜¯ä¸€ç§æˆæƒæœºåˆ¶ï¼Œæ ¸å¿ƒæ˜¯é€šè¿‡é¢å‘ä»¤ç‰Œç»™ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œä½¿å…¶å¯ä»¥æºå¸¦ä»¤ç‰Œè®¿é—®æ•°æ®ã€‚&lt;/p&gt;&lt;h3 id=&quot;ä»¤ç‰Œä¸å¯†ç çš„å·®å¼‚&quot;&gt;ä»¤ç‰Œä¸å¯†ç çš„å·®å¼‚&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;ä»¤ç‰Œæ˜¯çŸ­æœŸçš„ï¼Œ&lt;strong&gt;åˆ°æœŸåä¼šå¤±æ•ˆ&lt;/strong&gt;ï¼Œå¯†ç ä¸€èˆ¬æ˜¯é•¿æœŸçš„ï¼Œç”¨æˆ·ä¸ä¸»åŠ¨ä¿®æ”¹ï¼Œä¸ä¼šæ”¹å˜ã€‚&lt;/li&gt;&lt;li&gt;ä»¤ç‰Œå¯è¢«é¢å‘è€…ä¸»åŠ¨æ’¤é”€ï¼Œè€Œå¯†ç ä¸€èˆ¬ä¸å¯ç”±ä»–äººæ§åˆ¶ã€‚&lt;/li&gt;&lt;li&gt;ä»¤ç‰Œçš„æƒé™èŒƒå›´ä¸€èˆ¬æ¯”å¯†ç å°ã€‚&lt;/li&gt;&lt;/ul&gt;
    
    </summary>
    
    
    
      <category term="Oauth2.0" scheme="https://zhucj94.github.io/tags/Oauth2-0/"/>
    
  </entry>
  
  <entry>
    <title>è¯»å†™åˆ†ç¦»ä¸‹æ•°æ®åº“ä¸ç¼“å­˜çš„ä¸€è‡´æ€§</title>
    <link href="https://zhucj94.github.io/article/9e1a046e.html"/>
    <id>https://zhucj94.github.io/article/9e1a046e.html</id>
    <published>2020-04-18T07:50:54.000Z</published>
    <updated>2020-07-24T06:18:36.290Z</updated>
    
    <content type="html"><![CDATA[<h3 id="è¯»æ“ä½œ">è¯»æ“ä½œ</h3><ol><li>å°è¯•ä»ç¼“å­˜getæ•°æ®ï¼Œç»“æœæ²¡æœ‰å‘½ä¸­ã€‚</li><li>ä»æ•°æ®åº“è·å–æ•°æ®ï¼Œè¯»ä»åº“ã€‚</li><li>æŠŠæ•°æ®setåˆ°ç¼“å­˜ï¼Œæœªæ¥èƒ½å¤Ÿå‘½ä¸­ç¼“å­˜ã€‚<br><img src="/images/cache/read.png" alt="avatar"></li></ol><h3 id="å†™æ“ä½œ">å†™æ“ä½œ</h3><ol><li>deleteç¼“å­˜ã€‚</li><li>æ“ä½œæ•°æ®åº“ã€‚<br><img src="/images/cache/write.png" alt="avatar"></li></ol><h3 id="ä¸ºä»€ä¹ˆå†™æ“ä½œå…ˆæ“ä½œç¼“å­˜ï¼Œå†æ“ä½œæ•°æ®åº“ï¼Ÿ">ä¸ºä»€ä¹ˆå†™æ“ä½œå…ˆæ“ä½œç¼“å­˜ï¼Œå†æ“ä½œæ•°æ®åº“ï¼Ÿ</h3><ul><li>å¦‚æœæ“ä½œæ•°æ®åº“æˆåŠŸï¼Œä½†æ˜¯æ“ä½œç¼“å­˜å¤±è´¥ï¼Œä¼šå¯¼è‡´æ•°æ®åº“ä¸ç¼“å­˜çš„ä¸ä¸€è‡´ã€‚</li></ul><h3 id="å†™æ“ä½œä¸ºä»€ä¹ˆä¸æ›´æ–°ç¼“å­˜ï¼Œè€Œæ˜¯åˆ é™¤ï¼Ÿ">å†™æ“ä½œä¸ºä»€ä¹ˆä¸æ›´æ–°ç¼“å­˜ï¼Œè€Œæ˜¯åˆ é™¤ï¼Ÿ</h3><ul><li>ä½¿ç”¨æ›´æ–°ï¼Œ1æˆåŠŸï¼Œ2å¤±è´¥ï¼Œä¼šå¯¼è‡´ç¼“å­˜é‡Œæ˜¯æ›´æ–°åçš„æ•°æ®ï¼Œæ•°æ®åº“é‡Œæ˜¯ä¹‹å‰çš„æ•°æ®ï¼Œæ•°æ®ä¸ä¸€è‡´ã€‚</li><li>ä½¿ç”¨åˆ é™¤ï¼Œ1æˆåŠŸï¼Œ2å¤±è´¥ï¼Œä¼šå¯¼è‡´ç¼“å­˜é‡Œæ²¡æœ‰æ•°æ®ï¼Œæ•°æ®åº“é‡Œæ˜¯ä¹‹å‰çš„æ•°æ®ï¼Œæ•°æ®æ²¡æœ‰ä¸ä¸€è‡´ã€‚åªæ˜¯ä¸‹ä¸€æ¬¡è¯»å–ï¼Œä¼šå¤šä¸€æ¬¡cache missã€‚</li></ul><h3 id="å†™æ“ä½œå®Œæˆåï¼Œæ•°æ®åº“ä¸»ä»åŒæ­¥æœªå®Œæˆ-ä¸»åº“æ˜¯æ–°æ•°æ®-ä»åº“æ˜¯æ—§æ•°æ®-ï¼Œæ­¤æ—¶è¯»æ“ä½œå°†æ—§æ•°æ®å†™å…¥ç¼“å­˜ï¼Œæ€ä¹ˆåŠï¼Ÿ">å†™æ“ä½œå®Œæˆåï¼Œæ•°æ®åº“ä¸»ä»åŒæ­¥æœªå®Œæˆ(ä¸»åº“æ˜¯æ–°æ•°æ®,ä»åº“æ˜¯æ—§æ•°æ®)ï¼Œæ­¤æ—¶è¯»æ“ä½œå°†æ—§æ•°æ®å†™å…¥ç¼“å­˜ï¼Œæ€ä¹ˆåŠï¼Ÿ</h3><ul><li>æ–¹æ¡ˆä¸€<ul><li>é€šè¿‡å·¥å…·ï¼ˆcanalï¼‰è®¢é˜…ä»åº“çš„binlogï¼Œä»åº“æ‰§è¡Œå®Œå†™æ“ä½œåï¼Œå†æ¬¡åˆ é™¤ç¼“å­˜ï¼Œæ·˜æ±°å¯èƒ½å†™å…¥ç¼“å­˜çš„æ—§æ•°æ®ã€‚</li></ul></li><li>æ–¹æ¡ˆäºŒ<ul><li>å†™æ“ä½œåï¼Œå°†å“ªä¸ªåº“ï¼Œå“ªä¸ªè¡¨ï¼Œå“ªä¸ªä¸»é”®ä¸‰ä¸ªä¿¡æ¯æ‹¼è£…ä¸€ä¸ªkeyå†™åˆ°cacheé‡Œï¼Œè¿™æ¡è®°å½•çš„è¶…æ—¶æ—¶é—´ï¼Œè®¾ç½®ä¸ºâ€œä¸»ä»åŒæ­¥æ‰€éœ€æ—¶é—´â€ã€‚</li><li>è¯»æ“ä½œç¬¬äºŒæ­¥æ”¹ä¸ºæ‹¼è£…keyå»ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœå‘½ä¸­åˆ™å¼ºåˆ¶è¯»ä¸»åº“ï¼Œå¦åˆ™è¯»ä»åº“ã€‚</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;è¯»æ“ä½œ&quot;&gt;è¯»æ“ä½œ&lt;/h3&gt;&lt;ol&gt;&lt;li&gt;å°è¯•ä»ç¼“å­˜getæ•°æ®ï¼Œç»“æœæ²¡æœ‰å‘½ä¸­ã€‚&lt;/li&gt;&lt;li&gt;ä»æ•°æ®åº“è·å–æ•°æ®ï¼Œè¯»ä»åº“ã€‚&lt;/li&gt;&lt;li&gt;æŠŠæ•°æ®setåˆ°ç¼“å­˜ï¼Œæœªæ¥èƒ½å¤Ÿå‘½ä¸­ç¼“å­˜ã€‚&lt;br&gt;&lt;img src=&quot;/images/cache/read.png&quot; alt=&quot;
      
    
    </summary>
    
    
    
      <category term="ç¼“å­˜" scheme="https://zhucj94.github.io/tags/%E7%BC%93%E5%AD%98/"/>
    
  </entry>
  
  <entry>
    <title>å¼‚å¸¸</title>
    <link href="https://zhucj94.github.io/article/23a3bd72.html"/>
    <id>https://zhucj94.github.io/article/23a3bd72.html</id>
    <published>2020-04-02T06:22:14.000Z</published>
    <updated>2020-07-24T06:18:36.244Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å¯¹å¯æ¢å¤çš„æƒ…å†µä½¿ç”¨å—æ£€å¼‚å¸¸ï¼Œå¯¹ç¼–ç¨‹é”™è¯¯ä½¿ç”¨è¿è¡Œæ—¶å¼‚å¸¸">å¯¹å¯æ¢å¤çš„æƒ…å†µä½¿ç”¨å—æ£€å¼‚å¸¸ï¼Œå¯¹ç¼–ç¨‹é”™è¯¯ä½¿ç”¨è¿è¡Œæ—¶å¼‚å¸¸</h3><ul><li>å¦‚æœæœŸæœ›è°ƒç”¨è€…èƒ½å¤Ÿåˆç†çš„æ¢å¤ç¨‹åºè¿è¡Œï¼Œå¯¹äºè¿™ç§æƒ…å†µå°±åº”è¯¥ä½¿ç”¨å—æ£€å¼‚å¸¸ã€‚</li><li>ç”¨è¿è¡Œæ—¶å¼‚å¸¸æ¥è¡¨æ˜ç¼–ç¨‹é”™è¯¯ï¼Œä¾‹å¦‚æ•°ç»„çš„ä¸‹æ ‡å€¼åœ¨0åˆ°é•¿åº¦-1ä¹‹é—´ï¼ŒArrayIndexOutOfBoundsExceptionè¡¨æ˜è¿åäº†è¿™ä¸ªå‰æã€‚æŒ‰ç…§æƒ¯ä¾‹ï¼Œ<em><strong>é”™è¯¯ï¼ˆErrorï¼‰å¾€å¾€è¢«JVMä¿ç•™ä¸‹æ¥ä½¿ç”¨ï¼Œä½ å®ç°çš„æ‰€æœ‰éå—æ£€çš„ throwable éƒ½åº”è¯¥æ˜¯ RuntimeExceptiond å­ç±»ã€‚</strong></em></li></ul><a id="more"></a><h3 id="é¿å…ä¸å¿…è¦çš„ä½¿ç”¨å—æ£€å¼‚å¸¸">é¿å…ä¸å¿…è¦çš„ä½¿ç”¨å—æ£€å¼‚å¸¸</h3><ul><li>åœ¨è°¨æ…ä½¿ç”¨çš„å‰æä¹‹ä¸‹ï¼Œå—æ£€å¼‚å¸¸å¯ä»¥æå‡ç¨‹åºçš„å¯è¯»æ€§ï¼›è¿‡åˆ†ä½¿ç”¨å—æ£€å¼‚å¸¸ä½¿apiä¸æ–¹ä¾¿ï¼Œapiå¿…é¡»ä½äºtryå—ä¸­æˆ–è€…æ–¹æ³•å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸ã€‚</li><li>å¯ä»¥ä½¿ç”¨ä¸‹é¢ä¸¤ç§æ–¹å¼éƒ¨åˆ†æ›¿ä»£å—æ£€å¼‚å¸¸ã€‚<ul><li>è¿”å›ä¸€ä¸ªOptionalï¼Œæ–¹æ³•ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œåªæ˜¯è¿”å›ä¸€ä¸ªç©ºOptionalï¼Œç¼ºç‚¹æ˜¯æ–¹æ³•æ— æ³•è¿”å›é¢å¤–ä¿¡æ¯ï¼Œè€Œå¼‚å¸¸å¯ä»¥ã€‚</li><li>å°†å—æ£€å¼‚å¸¸å˜ä¸ºéå—æ£€å¼‚å¸¸ï¼ŒæŠŠè¿™ä¸ªæŠ›å‡ºå¼‚å¸¸çš„æ–¹æ³•åˆ†æˆä¸¤ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªbooleanå€¼ï¼Œè¡¨æ˜æ˜¯å¦åº”è¯¥æŠ›å‡ºå¼‚å¸¸ï¼Œç¬¬äºŒä¸ªæ–¹æ³•æ­£å¸¸æ‰§è¡Œï¼ŒæŠ›å‡ºéå—æ£€å¼‚å¸¸ã€‚</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    obj.action( args );</span><br><span class="line">&#125; <span class="keyword">catch</span> ( TheCheckedException e ) &#123;</span><br><span class="line">... <span class="comment">/* Handle exceptional condition */</span></span><br><span class="line">&#125;</span><br><span class="line">é‡æ„ä¸ºä¸‹é¢</span><br><span class="line"><span class="keyword">if</span> ( obj.actionPermitted( args ) ) &#123;</span><br><span class="line">    obj.action( args );</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">... <span class="comment">/* Handle exceptional condition */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§é‡æ„å¹¶éæ€»æ˜¯æ°å½“çš„ï¼Œå¦‚æœå¯¹è±¡å°†åœ¨ç¼ºå°‘å¤–éƒ¨åŒæ­¥çš„æƒ…å†µä¸‹è¢«å¹¶å‘è®¿é—®ï¼Œæˆ–è€…å¯è¢«å¤–ç•Œæ”¹å˜çŠ¶æ€ï¼Œè¿™ç§é‡æ„å°±æ˜¯ä¸æ°å½“çš„ï¼Œå› ä¸ºåœ¨actionPermittedå’Œactionè¿™ä¸¤ä¸ªè°ƒç”¨çš„æ—¶é—´é—´éš”ä¹‹ä¸­ï¼Œå¯¹è±¡çš„çŠ¶æ€æœ‰å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚å¦‚æœå•ç‹¬çš„actionPermittedæ–¹æ³•å¿…é¡»é‡å¤actionæ–¹æ³•çš„å·¥ä½œï¼Œå‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œè¿™ç§APIé‡æ„å°±ä¸å€¼å¾—å»åšã€‚</p><h3 id="æŠ›å‡ºä¸æŠ½è±¡å¯¹åº”çš„å¼‚å¸¸">æŠ›å‡ºä¸æŠ½è±¡å¯¹åº”çš„å¼‚å¸¸</h3><ul><li>å¦‚æœæ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ä¸å®ƒæ‰€æ‰§è¡Œçš„ä»»åŠ¡æ²¡æœ‰æ˜æ˜¾çš„è”ç³»ï¼Œè¿™ç§æƒ…å½¢å°†ä¼šä½¿äººä¸çŸ¥æ‰€æªã€‚å½“æ–¹æ³•ä¼ é€’ç”±ä½å±‚æŠ›å‡ºçš„å¼‚å¸¸æ—¶ï¼Œå¾€å¾€ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œæ›´é«˜å±‚çš„å®ç°åº”è¯¥<em><strong>æ•è·ä½å±‚çš„å¼‚å¸¸ï¼ŒåŒæ—¶æŠ›å‡ºå¯ä»¥æŒ‰ç…§é«˜å±‚æŠ½è±¡è¿›è¡Œè§£é‡Šçš„å¼‚å¸¸ã€‚è¿™ç§åšæ³•ç§°ä¸ºå¼‚å¸¸è½¬è¯‘(exception translation)</strong></em>ï¼Œä¾‹å¦‚AbstractSequentialList.get(index)ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> listIterator(index).next();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchElementException exc) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(<span class="string">"Index: "</span>+index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>***å°½ç®¡å¼‚å¸¸è½¬è¯‘ä¸ä¸åŠ é€‰æ‹©åœ°ä»ä½å±‚ä¼ é€’å¼‚å¸¸çš„åšæ³•ç›¸æ¯”æœ‰æ‰€æ”¹è¿›ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½æ»¥ç”¨å®ƒã€‚***å¤„ç†æ¥è‡ªä½å±‚å¼‚å¸¸çš„æœ€å¥½åšæ³•æ˜¯åœ¨è°ƒç”¨ä½å±‚æ–¹æ³•ä¹‹å‰ç¡®ä¿å®ƒä»¬ä¼šæˆåŠŸæ‰§è¡Œï¼Œä»è€Œé¿å…å®ƒä»¬æŠ›å‡ºå¼‚å¸¸ï¼Œä¾‹å¦‚ç»™ä½å±‚ä¼ é€’å‚æ•°ä¹‹å‰ï¼Œæ£€æŸ¥æ›´é«˜å±‚æ–¹æ³•çš„å‚æ•°çš„æœ‰æ•ˆæ€§ã€‚å…¶æ¬¡çš„åšæ³•æ˜¯ï¼Œè®©æ›´é«˜å±‚æ¥æ‚„æ‚„åœ°å¤„ç†è¿™äº›å¼‚å¸¸ï¼Œä»è€Œå°†é«˜å±‚æ–¹æ³•çš„è°ƒç”¨è€…ä¸ä½å±‚çš„é—®é¢˜éš”ç¦»å¼€æ¥ï¼Œä¾‹å¦‚æ—¥å¿—æ‰“å°ã€‚</li></ul><h3 id="ä¿è¯å¤±è´¥åŸå­æ€§">ä¿è¯å¤±è´¥åŸå­æ€§</h3><ul><li>ä¸€èˆ¬è€Œè¨€ï¼Œ***å¤±è´¥çš„æ–¹æ³•è°ƒç”¨åº”è¯¥ä½¿å¯¹è±¡ä¿æŒåœ¨è¢«è°ƒç”¨ä¹‹å‰çš„çŠ¶æ€ã€‚***å…·æœ‰è¿™ç§å±æ€§çš„æ–¹æ³•è¢«ç§°ä¸ºå…·æœ‰å¤±è´¥åŸå­æ€§ (failure atomic)ã€‚</li><li>æœ‰5ä¸­æ–¹æ³•ä¿æŒå¤±è´¥åŸå­æ€§<ul><li>ä½¿ç”¨ä¸å¯å˜å¯¹è±¡ã€‚</li><li>åœ¨æ‰§è¡Œæ“ä½œä¹‹å‰æ£€æŸ¥å‚æ•°çš„æœ‰æ•ˆæ€§ï¼Œä¾‹å¦‚Arraylist.get(index)ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">  rangeCheck(index);</span><br><span class="line">  <span class="keyword">return</span> elementData(index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rangeCheck</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (index &gt;= size)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(outOfBoundsMsg(index));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è°ƒæ•´è®¡ç®—å¤„ç†è¿‡ç¨‹çš„é¡ºåºï¼Œä½¿å¾—ä»»ä½•å¯èƒ½ä¼šå¤±è´¥çš„è®¡ç®—éƒ¨åˆ†éƒ½åœ¨å¯¹è±¡çŠ¶æ€è¢«ä¿®æ”¹ä¹‹å‰å‘ç”Ÿã€‚</li><li>åœ¨å¯¹è±¡çš„ä¸€ä»½ä¸´æ—¶æ‹·è´ä¸Šæ‰§è¡Œæ“ä½œï¼Œå½“æ“ä½œå®Œæˆä¹‹åå†ç”¨ä¸´æ—¶æ‹·è´ä¸­çš„ç»“æœä»£æ›¿å¯¹è±¡çš„å†…å®¹ã€‚</li><li>ç¼–å†™ä¸€æ®µæ¢å¤ä»£ç  (recoverycode)ï¼Œç”±å®ƒæ¥æ‹¦æˆªæ“ä½œè¿‡ç¨‹ä¸­å‘ç”Ÿçš„å¤±è´¥ï¼Œä»¥åŠä¾¿å¯¹è±¡å›æ»šåˆ°æ“ä½œå¼€å§‹ä¹‹å‰çš„çŠ¶æ€ä¸Šã€‚</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;å¯¹å¯æ¢å¤çš„æƒ…å†µä½¿ç”¨å—æ£€å¼‚å¸¸ï¼Œå¯¹ç¼–ç¨‹é”™è¯¯ä½¿ç”¨è¿è¡Œæ—¶å¼‚å¸¸&quot;&gt;å¯¹å¯æ¢å¤çš„æƒ…å†µä½¿ç”¨å—æ£€å¼‚å¸¸ï¼Œå¯¹ç¼–ç¨‹é”™è¯¯ä½¿ç”¨è¿è¡Œæ—¶å¼‚å¸¸&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;å¦‚æœæœŸæœ›è°ƒç”¨è€…èƒ½å¤Ÿåˆç†çš„æ¢å¤ç¨‹åºè¿è¡Œï¼Œå¯¹äºè¿™ç§æƒ…å†µå°±åº”è¯¥ä½¿ç”¨å—æ£€å¼‚å¸¸ã€‚&lt;/li&gt;&lt;li&gt;ç”¨è¿è¡Œæ—¶å¼‚å¸¸æ¥è¡¨æ˜ç¼–ç¨‹é”™è¯¯ï¼Œä¾‹å¦‚æ•°ç»„çš„ä¸‹æ ‡å€¼åœ¨0åˆ°é•¿åº¦-1ä¹‹é—´ï¼ŒArrayIndexOutOfBoundsExceptionè¡¨æ˜è¿åäº†è¿™ä¸ªå‰æã€‚æŒ‰ç…§æƒ¯ä¾‹ï¼Œ&lt;em&gt;&lt;strong&gt;é”™è¯¯ï¼ˆErrorï¼‰å¾€å¾€è¢«JVMä¿ç•™ä¸‹æ¥ä½¿ç”¨ï¼Œä½ å®ç°çš„æ‰€æœ‰éå—æ£€çš„ throwable éƒ½åº”è¯¥æ˜¯ RuntimeExceptiond å­ç±»ã€‚&lt;/strong&gt;&lt;/em&gt;&lt;/li&gt;&lt;/ul&gt;
    
    </summary>
    
    
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="https://zhucj94.github.io/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
      <category term="effective java 3rd" scheme="https://zhucj94.github.io/tags/effective-java-3rd/"/>
    
  </entry>
  
  <entry>
    <title>æ–¹æ³•</title>
    <link href="https://zhucj94.github.io/article/ad01bc3e.html"/>
    <id>https://zhucj94.github.io/article/ad01bc3e.html</id>
    <published>2020-03-30T11:09:10.000Z</published>
    <updated>2020-07-24T06:18:36.252Z</updated>
    
    <content type="html"><![CDATA[<h3 id="æ£€æŸ¥å‚æ•°æœ‰æ•ˆæ€§">æ£€æŸ¥å‚æ•°æœ‰æ•ˆæ€§</h3><ul><li>å¤§å¤šæ•°æ–¹æ³•å’Œæ„é€ æ–¹æ³•å¯¹å¯ä»¥å°†å“ªäº›å€¼ä¼ é€’åˆ°å…¶å¯¹åº”å‚æ•°ä¸­æœ‰ä¸€äº›é™åˆ¶ã€‚ä¾‹å¦‚ï¼Œç´¢å¼•å€¼å¿…é¡»æ˜¯éè´Ÿæ•°ã€‚<em><strong>åœ¨æ–¹æ³•çš„å¼€å¤´æ£€æŸ¥å‚æ•°ï¼ŒæŠ›å‡ºé€‚å½“çš„å¼‚å¸¸å¿«é€Ÿä¸”æ¸…æ¥šçš„ç»“æŸæ–¹æ³•</strong></em>ã€‚å¦‚æœä¸æ£€æŸ¥å‚æ•°ï¼Œå¯èƒ½ä¼šå‡ºç°ä»¤äººå›°æƒ‘çš„å¼‚å¸¸ï¼Œæˆ–è€…æ–¹æ³•æ­£å¸¸è¿”å›ï¼Œä½†è®¡ç®—é”™è¯¯ã€‚</li><li>å¯ä»¥ä½¿ç”¨guavaçš„Preconditionsæ£€æŸ¥å‚æ•°ã€‚</li></ul><a id="more"></a><h3 id="å¿…è¦æ—¶è¿›è¡Œé˜²å¾¡æ€§æ‹·è´">å¿…è¦æ—¶è¿›è¡Œé˜²å¾¡æ€§æ‹·è´</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Period</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Date start;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Date end;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Period</span><span class="params">(Date start, Date end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (start.compareTo(end) &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                start + <span class="string">" after "</span> + end);</span><br><span class="line">                <span class="keyword">this</span>.start = start;</span><br><span class="line">        <span class="keyword">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> start;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">end</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> end;</span><br><span class="line">    &#125; </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>***å‡å®šç±»çš„å®¢æˆ·ç«¯å°½åŠ›æ‘§æ¯ç±»ä¸å˜é‡ï¼Œé˜²å¾¡æ€§åœ°ç¼–å†™ç¨‹åºã€‚***Periodçœ‹èµ·æ¥æ˜¯ä¸å¯å˜çš„ï¼Œä½†æ˜¯åˆ©ç”¨Dateçš„å¯å˜æ€§ï¼Œå°±èƒ½æ‰“ç ´ä¸å˜æ€§ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Period(<span class="keyword">new</span> Date(), <span class="keyword">new</span> Date()).end().setYear(<span class="number">78</span>);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Period</span><span class="params">(Date start, Date end)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.start = <span class="keyword">new</span> Date(start.getTime());</span><br><span class="line">    <span class="keyword">this</span>.end = <span class="keyword">new</span> Date(end.getTime());</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.start.compareTo(<span class="keyword">this</span>.end) &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                <span class="keyword">this</span>.start + <span class="string">" after "</span> + <span class="keyword">this</span>.end);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Date <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Date(start.getTime());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Date <span class="title">end</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Date(end.getTime());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ–°çš„æ„é€ æ–¹æ³•å’Œæ–°çš„è®¿é—®å™¨ï¼ŒPeriodæ˜¯çœŸæ­£ä¸å¯å˜çš„ã€‚åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œåº”è¯¥ä½¿ç”¨ä¸å¯å˜å¯¹è±¡ä½œä¸ºå¯¹è±¡çš„ç»„ä»¶ï¼Œå¦‚Periodä¸­ä½¿ç”¨LocalDateTimeï¼Œå°±ä¸ç”¨åšé˜²å¾¡æ€§æ‹·è´ã€‚<br><em><strong>é˜²å¾¡æ€§æ‹·è´æ˜¯åœ¨æ£€æŸ¥å‚æ•°çš„æœ‰æ•ˆæ€§ä¹‹å‰è¿›è¡Œçš„</strong></em>ï¼Œæœ‰æ•ˆæ€§æ£€æŸ¥æ˜¯åœ¨æ‹·è´ä¸Šè€Œä¸æ˜¯åœ¨åŸå§‹å®ä¾‹ä¸Šè¿›è¡Œçš„,è¿™æ ·æ£€æŸ¥å‚æ•°å’Œæ‹·è´å‚æ•°ä¹‹é—´çš„æ¼æ´çª—å£æœŸé—´ä¿æŠ¤ç±»ä¸å—å…¶ä»–çº¿ç¨‹å¯¹å‚æ•°çš„æ›´æ”¹çš„å½±å“ï¼Œè¿™ç§°ä¸ºtime-of-check/time-of-use æˆ– TOCTOU æ”»å‡»ã€‚</p><ul><li>å¦‚æœæ‹·è´çš„æˆæœ¬å¤ªé«˜ï¼Œå¹¶ä¸”ç±»ä¿¡ä»»å®ƒçš„å®¢æˆ·ç«¯ä¸ä¼šä¸é€‚å½“åœ°ä¿®æ”¹ç»„ä»¶ï¼Œåˆ™å¯ä»¥ç”¨æ–‡æ¡£æ›¿æ¢é˜²å¾¡æ€§æ‹·è´ï¼Œè¯¥æ–‡æ¡£æ¦‚è¿°äº†å®¢æˆ·ç«¯ä¸å¾—ä¿®æ”¹å—å½±å“ç»„ä»¶ã€‚</li></ul><h3 id="ä»”ç»†è®¾è®¡æ–¹æ³•ç­¾å">ä»”ç»†è®¾è®¡æ–¹æ³•ç­¾å</h3><ul><li>ä»”ç»†é€‰æ‹©æ–¹æ³•åï¼Œé€‰æ‹©ä¸åŒä¸€åŒ…ä¸­çš„å…¶ä»–åç§°ä¸€è‡´ä¸”æ˜“äºç†è§£çš„åç§°ï¼Œé¿å…ä½¿ç”¨è¾ƒé•¿çš„æ–¹æ³•åï¼Œå¯ä»¥å‚è€ƒ Java ç±»åº“API</li><li>ä¸è¦è¿‡åˆ†åœ°æä¾›æ–¹ä¾¿çš„æ–¹æ³•ï¼Œå¤ªå¤šçš„æ–¹æ³•ä½¿å¾—ç±»éš¾ä»¥ä½¿ç”¨å’Œç»´æŠ¤ï¼Œå¯¹äºç±»æˆ–æ¥å£æ”¯æŒçš„æ¯ä¸ªæ“ä½œï¼Œ<br>æä¾›ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„æ–¹æ³•ã€‚</li><li>é¿å…è¿‡é•¿çš„å‚æ•°åˆ—è¡¨ï¼Œå°½é‡æ˜¯4ä¸ªåŠä»¥ä¸‹çš„å‚æ•°ï¼Œè¿‡å¤šçš„å‚æ•°ä¼šä½¿æ–¹æ³•éš¾ä»¥ä½¿ç”¨ã€‚æœ‰3ç§æŠ€æœ¯å¯ä»¥ç¼©çŸ­åˆ—è¡¨<ul><li>åˆ›å»ºè¾…åŠ©ç±»ä¿å­˜å‚æ•°ç»„ï¼Œè¿™äº›è¾…åŠ©ç±»é€šå¸¸æ˜¯é™æ€å†…éƒ¨ç±»ã€‚</li><li>å°†æ–¹æ³•åˆ†è§£ä¸ºå¤šä¸ªæ–¹æ³•ï¼Œæ¯ä¸ªæ–¹æ³•åªéœ€è¦å‚æ•°çš„ä¸€ä¸ªå­é›†ã€‚ä¾‹å¦‚Listæ²¡æœ‰æä¾›å­åˆ—è¡¨ä¸­å…ƒç´ çš„ç¬¬ä¸€ä¸ªæˆ–æœ€åä¸€ä¸ªç´¢å¼•ä½ç½®ï¼Œä½†æ˜¯å¯ä»¥ç»“åˆsubListï¼ŒindexOfï¼ŒlastIndexOfä½¿ç”¨ã€‚</li><li>Builderæ¨¡å¼ï¼Œå®šä¹‰ä¸€ä¸ªå¯¹è±¡æ¥è¡¨ç¤ºæ‰€æœ‰çš„å‚æ•°ï¼Œå¹¶å…è®¸å®¢æˆ·ç«¯åœ¨è¿™ä¸ªå¯¹è±¡ä¸Šè¿›è¡Œå¤šä¸ª&quot;setter&quot; è°ƒç”¨ï¼Œè®¾ç½®å¥½æ‰€éœ€çš„å‚æ•°åï¼Œå®¢æˆ·ç«¯è°ƒç”¨å¯¹è±¡çš„&quot;execute&quot;æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯¹å‚æ•°è¿›è¡Œæœ€åçš„æœ‰æ•ˆæ€§æ£€æŸ¥ï¼Œå¹¶æ‰§è¡Œå®é™…çš„è®¡ç®—ã€‚</li></ul></li><li>ä¸å¸ƒå°”å‹å‚æ•°ç›¸æ¯”ï¼Œä¼˜å…ˆä½¿ç”¨ä¸¤ä¸ªå…ƒç´ æšä¸¾ç±»å‹ï¼Œé™¤éå¸ƒå°”å‹å‚æ•°çš„å«ä¹‰åœ¨æ–¹æ³•åä¸­æ˜¯æ˜ç¡®çš„ã€‚</li></ul><h3 id="æ˜æ™ºå®¡æ…åœ°ä½¿ç”¨é‡è½½">æ˜æ™ºå®¡æ…åœ°ä½¿ç”¨é‡è½½</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CollectionClassifier</span> </span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">classify</span><span class="params">(Set&lt;?&gt; s)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">"Set"</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">classify</span><span class="params">(List&lt;?&gt; lst)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">"List"</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">classify</span><span class="params">(Collection&lt;?&gt; c)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">"Unknown Collection"</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">         Collection&lt;?&gt;[] collections = &#123;</span><br><span class="line">                 <span class="keyword">new</span> HashSet&lt;String&gt;(),</span><br><span class="line">                 <span class="keyword">new</span> ArrayList&lt;BigInteger&gt;(),</span><br><span class="line">                 <span class="keyword">new</span> HashMap&lt;String, String&gt;().values()</span><br><span class="line">         &#125;;</span><br><span class="line">         <span class="keyword">for</span> (Collection&lt;?&gt; c : collections)</span><br><span class="line">             System.out.println(classify(c));</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><ul><li>è¿™ä¸ªmainæ–¹æ³•å°†è¾“å‡ºä¸‰æ¬¡Unknown Collectionï¼Œå› ä¸ºclassifyæ–¹æ³•è¢«é‡è½½äº†ï¼Œ<em><strong>åœ¨ç¼–è¯‘æ—¶é€‰æ‹©è¦è°ƒç”¨å“ªä¸ªé‡è½½æ–¹æ³•ã€‚</strong></em></li><li>é‡è½½ï¼ˆoverloadedï¼‰æ–¹æ³•ä¹‹é—´çš„é€‰æ‹©æ˜¯é™æ€çš„ï¼Œ<em><strong>è€Œé‡å†™ï¼ˆoverriddenï¼‰æ–¹æ³•ä¹‹é—´çš„é€‰æ‹©æ˜¯åŠ¨æ€çš„ã€‚é‡å†™æ€»æ˜¯ä¼šæ‰§è¡Œâ€œæœ€å…·ä½“ (most specific)â€çš„é‡å†™æ–¹æ³•ã€‚</strong></em></li><li>***ä¸€ä¸ªå®‰å…¨å’Œä¿å®ˆçš„ç­–ç•¥æ˜¯æ°¸è¿œä¸è¦å¯¼å‡ºä¸¤ä¸ªå…·æœ‰ç›¸åŒå‚æ•°æ•°é‡çš„é‡è½½ï¼Œå¯ä»¥ä¸ºæ–¹æ³•èµ‹äºˆä¸åŒçš„åç§°ï¼Œè€Œä¸æ˜¯é‡è½½å®ƒä»¬ã€‚***ä¾‹å¦‚ObjectOutputStreamçš„writeBoolean(boolean)ï¼ŒwriteFloat(float)ã€‚</li><li>ç±»çš„å¤šä¸ªæ„é€ å‡½æ•°æ€»æ˜¯è¢«é‡è½½ï¼Œå¯ä»¥ä½¿ç”¨é™æ€å·¥å‚æ–¹æ³•è€Œä¸æ˜¯æ„é€ ã€‚</li><li>ä¸è¦åœ¨ç›¸åŒå‚æ•°ä½ç½®é‡è½½é‡‡ç”¨ä¸åŒå‡½æ•°å¼æ¥å£çš„æ–¹æ³•ã€‚ä¾‹å¦‚Executors.submit(Callable),Executors.submit(Runnable)ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Executors.newCachedThreadPool().submit(System.out::println)<span class="comment">//æ— æ³•ç¼–è¯‘Ambiguous method</span></span><br></pre></td></tr></table></figure><p>Runnable.run()è¿”å›æ˜¯voidï¼Œprintlnè¿”å›æ˜¯voidï¼Œçœ‹èµ·æ¥åº”è¯¥èƒ½ç¼–è¯‘ï¼Œä½†å¹¶ä¸èƒ½ã€‚</p><h3 id="æ˜æ™ºå®¡æ…åœ°ä½¿ç”¨å¯å˜å‚æ•°">æ˜æ™ºå®¡æ…åœ°ä½¿ç”¨å¯å˜å‚æ•°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span>... args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> arg : args)</span><br><span class="line">        sum += arg;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨éœ€è¦å‚æ•°æ•°é‡å¯å˜çš„æ–¹æ³•æ—¶ï¼Œå¯å˜å‚æ•°æ˜¯æœ‰æ•ˆçš„,åœ¨æ€§èƒ½å…³é”®çš„æƒ…å†µä¸‹ä½¿ç”¨å¯å˜å‚æ•°æ—¶è¦å°å¿ƒã€‚æ¯æ¬¡è°ƒç”¨å¯å˜å‚æ•°æ–¹æ³•éƒ½ä¼šå¯¼è‡´æ•°ç»„åˆ†é…å’Œåˆå§‹åŒ–ã€‚å‡è®¾ä½ å·²ç¡®å®š95ï¼…çš„è°ƒç”¨æ˜¯ä¸‰ä¸ªæˆ–æ›´å°‘çš„å‚æ•°çš„æ–¹æ³•ï¼Œé‚£ä¹ˆå£°æ˜è¯¥æ–¹æ³•çš„äº”ä¸ªé‡è½½ã€‚ä¾‹å¦‚guavaçš„ImmutableMapé™æ€å·¥å‚æ–¹æ³•ofã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;K, V&gt; <span class="function">ImmutableMap&lt;K, V&gt; <span class="title">of</span><span class="params">(K k1, V v1)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;K, V&gt; <span class="function">ImmutableMap&lt;K, V&gt; <span class="title">of</span><span class="params">(K k1, V v1, K k2, V v2)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;K, V&gt; <span class="function">ImmutableMap&lt;K, V&gt; <span class="title">of</span><span class="params">(K k1, V v1, K k2, V v2, K k3, V v3)</span><span class="params">( &#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">public</span> <span class="keyword">static</span> &lt;K, V&gt; ImmutableMap&lt;K, V&gt; of(K k1, V v1, K k2, V v2, K k3, V v3, K k4, V v4)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;K, V&gt; <span class="function">ImmutableMap&lt;K, V&gt; <span class="title">of</span><span class="params">(K k1, V v1, K k2, V v2, K k3, V v3, K k4, V v4, K k5, V v5)</span></span>&#123; &#125;</span><br></pre></td></tr></table></figure><h3 id="è¿”å›ç©ºçš„æ•°ç»„æˆ–é›†åˆï¼Œä¸è¦è¿”å›-null">è¿”å›ç©ºçš„æ•°ç»„æˆ–é›†åˆï¼Œä¸è¦è¿”å› null</h3><ul><li>åœ¨å‡ ä¹æ¯æ¬¡ä½¿ç”¨è¿”å› null æ¥ä»£æ›¿ç©ºé›†åˆæˆ–æ•°ç»„çš„æ–¹æ³•æ—¶ï¼Œéƒ½éœ€è¦åˆ¤æ–­éç©ºã€‚</li><li>å¦‚æœæœ‰è¯æ®è¡¨æ˜åˆ†é…ç©ºé›†åˆä¼šæŸå®³æ€§èƒ½ï¼Œå¯ä»¥é€šè¿‡é‡å¤è¿”å›ç›¸åŒçš„ä¸å¯å˜ç©ºé›†åˆæ¥é¿å…åˆ†é…ï¼Œä¾‹å¦‚Collections.emptyListã€‚</li></ul><h3 id="æ˜æ™ºå®¡æ…åœ°è¿”å›-Optional">æ˜æ™ºå®¡æ…åœ°è¿”å› Optional</h3><ul><li>åœ¨ Java 8 ä¸­åŠ å…¥äº† Optional&lt;T&gt;ï¼Œè¿”å›Optionalçš„æ–¹æ³•æ¯”æŠ›å‡ºå¼‚å¸¸çš„æ–¹æ³•æ›´çµæ´»ã€æ›´å®¹æ˜“ä½¿ç”¨ï¼Œè€Œä¸”æ¯”è¿”å› null çš„æ–¹æ³•æ›´ä¸å®¹æ˜“å‡ºé”™ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Comparable&lt;E&gt;&gt; <span class="function">Optional&lt;E&gt; <span class="title">max</span><span class="params">(Collection&lt;E&gt; c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (c.isEmpty())</span><br><span class="line">        <span class="keyword">return</span> Optional.empty();</span><br><span class="line">    E result = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (E e : c)</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span> || e.compareTo(result) &gt; <span class="number">0</span>)</span><br><span class="line">            result = Objects.requireNonNull(e);</span><br><span class="line">    <span class="keyword">return</span> Optional.of(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">String lastWordInLexicon = max(words).orElse(<span class="string">"No words..."</span>);</span><br></pre></td></tr></table></figure><p>Optionalå¾ˆç®€å•,Optional.empty() è¿”å›ä¸€ä¸ªç©ºçš„ Optionalï¼Œ Optional.of(value)è¿”å›ä¸€ä¸ªåŒ…å«ç»™å®šénullå€¼çš„Optionalï¼Œä¸è¦å°†nullä¼ å…¥ofæ–¹æ³•ï¼Œè¿™å°†ä¼šæŠ›å‡ºNullPointerExceptionã€‚<br><em><strong>æ°¸è¿œä¸è¦é€šè¿‡è¿”å› Optional çš„æ–¹æ³•è¿”å›ä¸€ä¸ªnull</strong></em>ï¼Œè¿™è¿åäº†Optionalè®¾è®¡åˆè¡·ã€‚<br>Optionalè¿«ä½¿ç”¨æˆ·é¢å¯¹å¯èƒ½æ²¡æœ‰è¿”å›å€¼çš„äº‹å®ï¼ŒæŠ›å‡ºæœªæŠ›å‡ºæœªæ£€æŸ¥çš„å¼‚å¸¸æˆ–è¿”å›nullå…è®¸ç”¨æˆ·å¿½ç•¥è¿™ç§å¯èƒ½æ€§ï¼Œä»è€Œå¸¦æ¥æ½œåœ¨çš„é”™è¯¯ã€‚æŠ›å‡ºä¸€ä¸ªæ£€æŸ¥å¼‚å¸¸éœ€è¦åœ¨å®¢æˆ·ç«¯ä¸­æ·»åŠ é¢å¤–çš„ä»£ç ã€‚</p><ul><li>å®¹å™¨ç±»å‹ï¼ŒåŒ…æ‹¬é›†åˆã€æ˜ å°„ã€Streamã€æ•°ç»„å’ŒOptionalï¼Œä¸åº”è¯¥å°è£…åœ¨Optionalä¸­ï¼Œä¸å…¶è¿”å›ä¸€ä¸ªç©ºçš„ Optional&lt;List<t>&gt; ï¼Œä¸è¿˜å¦‚è¿”å›ä¸€ä¸ªç©ºçš„ List<t>ã€‚</t></t></li><li>é€šå¸¸ï¼Œ<em><strong>å¦‚æœå¯èƒ½æ— æ³•è¿”å›ç»“æœï¼Œå¹¶ä¸”åœ¨æ²¡æœ‰è¿”å›ç»“æœï¼Œå®¢æˆ·ç«¯è¿˜å¿…é¡»æ‰§è¡Œç‰¹æ®Šå¤„ç†çš„æƒ…å†µä¸‹ï¼Œåˆ™åº”å£°æ˜è¿”å› Optional çš„æ–¹æ³•ã€‚</strong></em></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;æ£€æŸ¥å‚æ•°æœ‰æ•ˆæ€§&quot;&gt;æ£€æŸ¥å‚æ•°æœ‰æ•ˆæ€§&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;å¤§å¤šæ•°æ–¹æ³•å’Œæ„é€ æ–¹æ³•å¯¹å¯ä»¥å°†å“ªäº›å€¼ä¼ é€’åˆ°å…¶å¯¹åº”å‚æ•°ä¸­æœ‰ä¸€äº›é™åˆ¶ã€‚ä¾‹å¦‚ï¼Œç´¢å¼•å€¼å¿…é¡»æ˜¯éè´Ÿæ•°ã€‚&lt;em&gt;&lt;strong&gt;åœ¨æ–¹æ³•çš„å¼€å¤´æ£€æŸ¥å‚æ•°ï¼ŒæŠ›å‡ºé€‚å½“çš„å¼‚å¸¸å¿«é€Ÿä¸”æ¸…æ¥šçš„ç»“æŸæ–¹æ³•&lt;/strong&gt;&lt;/em&gt;ã€‚å¦‚æœä¸æ£€æŸ¥å‚æ•°ï¼Œå¯èƒ½ä¼šå‡ºç°ä»¤äººå›°æƒ‘çš„å¼‚å¸¸ï¼Œæˆ–è€…æ–¹æ³•æ­£å¸¸è¿”å›ï¼Œä½†è®¡ç®—é”™è¯¯ã€‚&lt;/li&gt;&lt;li&gt;å¯ä»¥ä½¿ç”¨guavaçš„Preconditionsæ£€æŸ¥å‚æ•°ã€‚&lt;/li&gt;&lt;/ul&gt;
    
    </summary>
    
    
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="https://zhucj94.github.io/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
      <category term="effective java 3rd" scheme="https://zhucj94.github.io/tags/effective-java-3rd/"/>
    
  </entry>
  
  <entry>
    <title>Lambdaså’ŒStreams</title>
    <link href="https://zhucj94.github.io/article/33749838.html"/>
    <id>https://zhucj94.github.io/article/33749838.html</id>
    <published>2020-03-28T09:40:14.000Z</published>
    <updated>2020-07-24T06:18:36.186Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¼˜å…ˆä½¿ç”¨æ ‡å‡†çš„å‡½æ•°å¼æ¥å£">ä¼˜å…ˆä½¿ç”¨æ ‡å‡†çš„å‡½æ•°å¼æ¥å£</h3><ul><li>æœ‰äº†lambdaåï¼Œç¼–å†™ API çš„æœ€ä½³å®è·µå·²ç»å‘ç”Ÿäº†å¾ˆå¤§çš„å˜åŒ–ï¼Œä¾‹å¦‚æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œå…¶ä¸­ä¸€ä¸ªå­ç±»é‡å†™åŸå§‹æ–¹æ³•ä»¥ä¸“é—¨åŒ–å…¶çˆ¶ç±»çš„è¡Œä¸ºï¼Œå˜å¾—æ²¡æœ‰é‚£ä¹ˆå¸å¼•äººã€‚ç°ä»£æ›¿ä»£çš„é€‰æ‹©æ˜¯æä¾›ä¸€ä¸ªé™æ€å·¥å‚æˆ–æ„é€ æ–¹æ³•æ¥æ¥å—å‡½æ•°å¯¹è±¡ä»¥è¾¾åˆ°ç›¸åŒçš„æ•ˆæœã€‚<br>ä¾‹å¦‚ LinkedHashMapï¼Œå¯ä»¥é€šè¿‡é‡å†™removeEldestEntry æ–¹æ³•å°†æ­¤ç±»ç”¨ä½œç¼“å­˜ï¼Œæ¯æ¬¡å°†æ–°çš„key å€¼åŠ å…¥åˆ° mapæ—¶éƒ½ä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œå½“æ­¤æ–¹æ³•è¿”å›trueæ—¶ï¼Œmapå°†åˆ é™¤ä¼ é€’ç»™è¯¥æ–¹æ³•çš„æœ€ä¹…æ¡ç›®ã€‚</li></ul><a id="more"></a><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;K,V&gt; eldest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> size() &gt; <span class="number">100</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœLinkedHashMapæ˜¯ç°åœ¨ç¼–å†™ï¼Œå¯ä»¥ç”¨lambdaæ¥å®ç°ï¼Œå¢åŠ ä¸€ä¸ªæ„é€ æˆ–é™æ€å·¥å‚æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> BiPredicate&lt;Map&lt;K,V&gt;, Map.Entry&lt;K,V&gt;&gt; removeEldestEntry;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">(BiPredicate&lt;Map&lt;K,V&gt;, Map.Entry&lt;K,V&gt;&gt; param)</span> </span>&#123;</span><br><span class="line">    removeEldestEntry = param;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>java.util.Functionä¸­æœ‰43ä¸ªå‡ å£ï¼Œä½†æ˜¯åªæœ‰6ä¸ªåŸºæœ¬æ¥å£ï¼Œå…¶ä½™çš„å‡æ˜¯å…¶æ´¾ç”Ÿæ¥å£</li></ul><table><thead><tr><th style="text-align:center">æ¥å£</th><th style="text-align:center">æ–¹æ³•</th><th style="text-align:center">ç¤ºä¾‹</th></tr></thead><tbody><tr><td style="text-align:center">UnaryOperator&lt;T&gt;</td><td style="text-align:center">T apply(T t)</td><td style="text-align:center">String::toLowerCase</td></tr><tr><td style="text-align:center">BinaryOperator&lt;T&gt;</td><td style="text-align:center">T apply(T t1, T t2)</td><td style="text-align:center">BigInteger::add</td></tr><tr><td style="text-align:center">Predicate&lt;T&gt;</td><td style="text-align:center">boolean test(T t)</td><td style="text-align:center">Collection::isEmpty</td></tr><tr><td style="text-align:center">Function&lt;T,R&gt;</td><td style="text-align:center">R apply(T t)</td><td style="text-align:center">Arrays::asList</td></tr><tr><td style="text-align:center">Supplier&lt;T&gt;</td><td style="text-align:center">T get()</td><td style="text-align:center">Instant::now</td></tr><tr><td style="text-align:center">Consumer&lt;T&gt;</td><td style="text-align:center">void accept(T t)</td><td style="text-align:center">System.out::println</td></tr></tbody></table><ul><li>å§‹ç»ˆä½¿ç”¨ @FunctionalInterface æ³¨è§£æ ‡æ³¨ä½ çš„å‡½æ•°å¼æ¥å£ã€‚<br>å®ƒå‘Šè¯‰è¯»è€…è¯¥æ¥å£æ˜¯ä¸ºäº†å®ç°lambdaè¡¨è¾¾å¼è€Œè®¾è®¡çš„ã€‚<br>å®ƒä½¿æ¥å£å¯é ï¼Œå› ä¸ºé™¤éåªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå¦åˆ™æ¥å£ä¸ä¼šç¼–è¯‘ã€‚<br>å®ƒå¯ä»¥é˜²æ­¢ç»´æŠ¤äººå‘˜åœ¨æ¥å£å‘ç”Ÿå˜åŒ–æ—¶ä¸å°å¿ƒåœ°å°†æŠ½è±¡æ–¹æ³•æ·»åŠ åˆ°æ¥å£ä¸­ã€‚</li></ul><p>// TODO</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;ä¼˜å…ˆä½¿ç”¨æ ‡å‡†çš„å‡½æ•°å¼æ¥å£&quot;&gt;ä¼˜å…ˆä½¿ç”¨æ ‡å‡†çš„å‡½æ•°å¼æ¥å£&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;æœ‰äº†lambdaåï¼Œç¼–å†™ API çš„æœ€ä½³å®è·µå·²ç»å‘ç”Ÿäº†å¾ˆå¤§çš„å˜åŒ–ï¼Œä¾‹å¦‚æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œå…¶ä¸­ä¸€ä¸ªå­ç±»é‡å†™åŸå§‹æ–¹æ³•ä»¥ä¸“é—¨åŒ–å…¶çˆ¶ç±»çš„è¡Œä¸ºï¼Œå˜å¾—æ²¡æœ‰é‚£ä¹ˆå¸å¼•äººã€‚ç°ä»£æ›¿ä»£çš„é€‰æ‹©æ˜¯æä¾›ä¸€ä¸ªé™æ€å·¥å‚æˆ–æ„é€ æ–¹æ³•æ¥æ¥å—å‡½æ•°å¯¹è±¡ä»¥è¾¾åˆ°ç›¸åŒçš„æ•ˆæœã€‚&lt;br&gt;ä¾‹å¦‚ LinkedHashMapï¼Œå¯ä»¥é€šè¿‡é‡å†™removeEldestEntry æ–¹æ³•å°†æ­¤ç±»ç”¨ä½œç¼“å­˜ï¼Œæ¯æ¬¡å°†æ–°çš„key å€¼åŠ å…¥åˆ° mapæ—¶éƒ½ä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œå½“æ­¤æ–¹æ³•è¿”å›trueæ—¶ï¼Œmapå°†åˆ é™¤ä¼ é€’ç»™è¯¥æ–¹æ³•çš„æœ€ä¹…æ¡ç›®ã€‚&lt;/li&gt;&lt;/ul&gt;
    
    </summary>
    
    
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="https://zhucj94.github.io/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
      <category term="effective java 3rd" scheme="https://zhucj94.github.io/tags/effective-java-3rd/"/>
    
  </entry>
  
</feed>
